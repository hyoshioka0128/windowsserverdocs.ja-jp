---
title: フェールオーバークラスターでクラスターの共有ボリュームを使用する
description: フェールオーバークラスターでクラスターの共有ボリュームを使用する方法。
ms.prod: windows-server
ms.topic: article
author: JasonGerend
ms.author: jgerend
ms.technology: storage-failover-clustering
ms.date: 06/07/2019
ms.localizationpriority: medium
ms.openlocfilehash: da0f541c34c7f8687822bec365364fdd406fa3c3
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71369737"
---
# <a name="use-cluster-shared-volumes-in-a-failover-cluster"></a>フェールオーバークラスターでクラスターの共有ボリュームを使用する

>適用対象:Windows Server 2019、Windows Server 2016、Windows Server 2012、Windows Server 2012 R2

クラスターの共有ボリューム (CSV) を使用すると、フェールオーバー クラスターの複数のノードが、NTFS ボリュームとしてプロビジョニングされている同じ LUN (ディスク) に同時に読み取り/書き込みアクセスできます (Windows Server 2012 R2 では、ディスクを NTFS または弾性ファイルシステム (ReFS) としてプロビジョニングできます)。CSV を使用すると、ドライブの所有権の変更やボリュームのマウント解除と再マウントを行うことなく、クラスター化された役割を別のノードに迅速にフェールオーバーできます。 また、フェールオーバー クラスター内の多数の LUN の管理も簡素化されます。

CSV は、NTFS (Windows Server 2012 R2 では ReFS) の上に階層化された汎用のクラスター化されたファイルシステムを提供します。 CSV アプリケーションには、次のものが含まれます。

- クラスター化された仮想ハード ディスク (VHD) ファイル。これはクラスター化された Hyper-V 仮想マシン用です。
- スケールアウト ファイル共有。これはスケールアウト ファイル サーバーのクラスターの役割のアプリケーション データを格納するために使用されます。 この役割のアプリケーション データの例には、Hyper-V 仮想マシン ファイルや Microsoft SQL Server のデータがあります (スケールアウト ファイル サーバーでは ReFS はサポートされないことに注意してください)。スケールアウトファイルサーバーの詳細については、「[アプリケーションデータのスケールアウトファイルサーバー](sofs-overview.md)」を参照してください。

> [!NOTE]
> Csv では、SQL Server 2012 およびそれ以前のバージョンの SQL Server で Microsoft SQL Server クラスター化されたワークロードはサポートされていません。

Windows Server 2012 では、CSV 機能が大幅に強化されました。 たとえば、Active Directory ドメイン サービスとの依存関係が削除されました。 また、**chkdsk** の機能向上、ウイルス対策およびバックアップ アプリケーションとの相互運用性、および一般的な記憶域機能 (BitLocker 暗号化ボリュームや記憶域スペースなど) との統合のサポートが追加されました。 Windows Server 2012 で導入された CSV 機能の概要については、「 [Windows server 2012 でのフェールオーバークラスタリングの新機能 \[redirected された @ no__t-2](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn265972(v%3dws.11)>)」を参照してください。

Windows Server 2012 R2 では、分散 CSV の所有権、サーバーサービスの可用性による回復性の向上、CSV キャッシュに割り当てることができる物理メモリの量に対する柔軟性の向上など、追加の機能が導入されています。ReFS と重複除去のサポートを含む、柔軟な割り当て、強化された相互運用性。 詳細については、「[フェールオーバークラスタリングの新機能](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn265972(v%3dws.11)>)」を参照してください。

> [!NOTE]
> 仮想デスクトップ インフラストラクチャ (VDI) シナリオのために CSV でデータ重複除去を使用する方法については、ブログ記事の「 [Windows Server 2012 R2 で VDI 記憶域用にデータ重複除去を展開する](https://blogs.technet.com/b/filecab/archive/2013/07/31/deploying-data-deduplication-for-vdi-storage-in-windows-server-2012-r2.aspx) 」と「 [Windows Server 2012 R2 でデータ重複除去を新しいワークロードに適用する](https://blogs.technet.com/b/filecab/archive/2013/07/31/extending-data-deduplication-to-new-workloads-in-windows-server-2012-r2.aspx)」を参照してください。

## <a name="review-requirements-and-considerations-for-using-csv-in-a-failover-cluster"></a>フェールオーバー クラスターで CSV を使用するための要件と考慮事項を確認する

フェールオーバー クラスターで CSV を使用する前に、このセクションでネットワーク、記憶域、およびその他の要件と考慮事項を確認してください。

### <a name="network-configuration-considerations"></a>ネットワーク構成に関する考慮事項

CSV をサポートするネットワークを構成するときは、次の考慮事項を確認してください。

- **複数のネットワークと複数のネットワーク アダプター**。 ネットワーク障害の発生時にフォールト トレランスを有効にするには、複数のクラスター ネットワークによって CSV トラフィックを伝送するか、またはチーム化されたネットワーク アダプターを構成することをお勧めします。
    
    クラスター ノードがクラスターによって使用されてはならないネットワークに接続されている場合は、それらのネットワークを無効にする必要があります。 たとえば、クラスターによる iSCSI ネットワークの使用を無効にして、CSV トラフィックがそれらのネットワークに伝送されるのを防ぐことをお勧めします。 ネットワークを無効にするには、フェールオーバークラスターマネージャーで **[ネットワーク]** を選択し、ネットワークを選択して、 **[プロパティ]** アクションを選択し、 **[このネットワークでのクラスターネットワーク通信を許可しない]** を選択します。 または、 [Get clusternetwork](https://docs.microsoft.com/powershell/module/failoverclusters/get-clusternetwork?view=win10-ps) Windows PowerShell コマンドレットを使用して、ネットワークの**ロール**プロパティを構成することもできます。
- **ネットワーク アダプターのプロパティ**。 クラスター通信を伝送するすべてのアダプターのプロパティで、次の設定が有効になっていることを確認します。

  - **[Microsoft ネットワーク用クライアント]** と **[Microsoft ネットワーク用ファイルとプリンタ共有]** 。 これらの設定は、ノード間の CSV トラフィックを伝送するために既定で使用されるサーバー メッセージ ブロック (SMB) 3.0 をサポートしています。 SMB をサポートするために、サーバー サービスとワークステーション サービスが実行されており、それらが各クラスター ノードで自動的に開始されるように構成されていることを確認します。

    >[!NOTE]
    >Windows Server 2012 R2 では、フェールオーバークラスターノードごとに複数のサーバーサービスインスタンスがあります。 標準のファイル共有にアクセスする SMB クライアントからの受信トラフィックを処理する既定のインスタンスと、ノード間の CSV トラフィックのみを処理する 2 番目の CSV インスタンスが存在します。 また、ノードのサーバー サービスが正常な状態ではなくなった場合、CSV の所有権は自動的に別のノードに移動します。

    SMB 3.0 には、SMB マルチチャネルと SMB ダイレクトの機能が含まれています。これらの機能を使用すると、CSV トラフィックがクラスター内の複数のネットワークを経由でき、リモート ダイレクト メモリ アクセス (RDMA) をサポートするネットワーク アダプターを有効活用することができます。 既定では、SMB マルチチャネルが CSV トラフィック用に使用されます。 詳細については、「[サーバー メッセージ ブロックの概要](../storage/file-server/file-server-smb-overview.md)」を参照してください。
  - **Microsoft フェールオーバー クラスター仮想アダプター パフォーマンス フィルター**。 この設定は、CSV にアクセスする必要があるとき (たとえば、接続の失敗によってノードが直接 CSV ディスクに接続できない場合など) にノードが I/O リダイレクトを実行する機能を強化します。 詳細については、このトピックで後述する「 [CSV 通信での i/o 同期と i/o リダイレクトについ](#about-io-synchronization-and-io-redirection-in-csv-communication)て」を参照してください。
- **クラスター ネットワークの優先順位付け**。 一般に、クラスターによって構成されているネットワーク設定を変更しないことをお勧めします。
- **IP サブネットの構成**。 CSV を使用するネットワークのノードについては特定のサブネット構成は不要です。 CSV は、マルチサブネット クラスターをサポートしています。
- **ポリシー ベースのサービスの品質 (QoS)** 。 CSV を使用する場合は、各ノードへのネットワーク トラフィックに対する QoS 優先順位ポリシーと最小帯域幅ポリシーを構成することをお勧めします。 詳細については、「[サービスの品質 (QoS)](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831679(v%3dws.11)>)」を参照してください。
- **記憶域ネットワーク**。 記憶域ネットワークの推奨事項については、使用する記憶域のベンダーが提供するガイドラインを確認してください。 CSV 用の記憶域に関するその他の考慮事項については、このトピックで後述する「[記憶域およびディスク構成の要件](#storage-and-disk-configuration-requirements)」を参照してください。

フェールオーバー クラスターのハードウェア、ネットワーク、および記憶域の要件の概要については、「[フェールオーバー クラスタリングのハードウェア要件と記憶域オプション](clustering-requirements.md)」を参照してください。

#### <a name="about-io-synchronization-and-io-redirection-in-csv-communication"></a>CSV 通信での I/O 同期と I/O リダイレクトについて

- **I/o の同期**:CSV を使用すると、複数のノードが同じ共有記憶域に同時に読み取り/書き込みアクセスできるようになります。 ノードが CSV ボリュームでディスク入力/出力 (I/O) を実行する場合、ノードは記憶域ネットワーク (SAN) などを通して直接記憶域と通信します。 しかし、LUN に関連付けられている物理ディスク リソースを “所有” するノード (コーディネーター ノードと呼ぶ) は常に 1 つです。 CSV ボリュームのコーディネーター ノードは、フェールオーバー クラスター マネージャーの **[ディスク]** の下に **[所有者ノード]** として表示されます。 また、 [Get ClusterSharedVolume](https://docs.microsoft.com/powershell/module/failoverclusters/get-clustersharedvolume?view=win10-ps) Windows PowerShell コマンドレットの出力にも表示されます。

  >[!NOTE]
  >Windows Server 2012 R2 では、CSV の所有権は、各ノードが所有する CSV ボリュームの数に基づいて、フェールオーバークラスターノード全体に均等に分散されます。 また、CSV がフェールオーバーした、ノードがクラスターに戻された、新しいノードをクラスターに追加した、クラスター ノードを再起動した、フェールオーバー クラスターをシャットダウン後に起動したなどの状況が発生した場合、所有権は自動的に再分配されます。

  CSV ボリュームのファイル システムに小さい変更が発生した場合、このメタデータは、単一のコーディネーター ノードだけではなく、LUN にアクセスする各物理ノードで同期される必要があります。 たとえば、CSV ボリューム上で仮想マシンが起動、作成、または削除されるたか、または仮想マシンが移行された場合、この情報は、この仮想マシンにアクセスする各物理ノードで同期される必要があります。 SMB 3.0 を使用すると、これらのメタデータ更新操作はクラスター ネットワークをまたがって並列的に実行されます。 これらの操作では、物理ノードがすべて共有記憶域と通信する必要はありません。

- **I/o リダイレクト**:記憶域の接続障害と特定の記憶域操作によって、特定のノードが記憶域と直接通信できなくなる場合があります。 ノードが記憶域と通信できないときに機能を維持するために、ノードはクラスター ネットワークを介して、ディスクが現在マウントされているコーディネーター ノードにディスク I/O をリダイレクトします。 現在のコーディネーター ノードが記憶域に接続できない場合は、新しいノードがコーディネーター ノードとして設定される間、すべてのディスク I/O 操作が一時的にキューに配置されます。

サーバーは、状況に応じて次のいずれかの I/O リダイレクト モードを使用します。

- **ファイル システム リダイレクト** リダイレクトはボリューム単位で行われます。たとえば、CSV ボリュームが手動でリダイレクト I/O モードに設定されているときに CSV のスナップショットがバックアップ アプリケーションによって作成されるときなどです。
- **ブロック リダイレクト** リダイレクトはファイルブロック レベルで行われます。たとえば、ボリュームへの記憶域の接続が切断された場合などです。 ブロック リダイレクトは、ファイル システム リダイレクトより大幅に高速に行われます。

Windows Server 2012 R2 では、CSV ボリュームの状態をノード単位で表示できます。 たとえば、I/O が直接実行されているのか、またはリダイレクトされているのかや、CSV ボリュームが利用可能かどうかを確認できます。 CSV ボリュームが I/O リダイレクト モードの場合は、その理由を表示することもできます。 この情報を表示するには、Windows PowerShell コマンドレットの **Get-ClusterSharedVolumeState** を使用します。

> [!NOTE]
> * Windows Server 2012 では、CSV 設計が改善されているため、CSV では、Windows Server 2008 R2 で発生したよりも多くの操作を直接 i/o モードで実行します。
> * CSV と SMB 3.0 の機能 (SMB マルチチャネルや SMB ダイレクトなど) との統合により、リダイレクトされた I/O トラフィックは複数のクラスター ネットワークを経由できます。
> * クラスター ネットワークを計画する際は、I/O リダイレクト中にコーディネーター ノードへのネットワーク トラフィックが増加する可能性があることを考慮に入れる必要があります。

### <a name="storage-and-disk-configuration-requirements"></a>記憶域およびディスク構成の要件

CSV を使用するには、記憶域とディスクが次の要件を満たしている必要があります。

- **ファイル システム形式**。 Windows Server 2012 R2 では、CSV ボリュームのディスクまたは記憶域スペースは NTFS または ReFS でパーティション分割されたベーシックディスクである必要があります。 Windows Server 2012 では、CSV ボリュームのディスクまたは記憶域スペースは NTFS でパーティション分割されたベーシックディスクである必要があります。

  CSV には、次の追加要件があります。
    
  - Windows Server 2012 R2 では、FAT または FAT32 でフォーマットされたディスクを CSV 用として使用することはできません。
  - Windows Server 2012 では、FAT、FAT32、または ReFS でフォーマットされたディスクを CSV 用として使用することはできません。
  - CSV 用として記憶域スペースを使用する場合は、シンプルな記憶域スペースまたはミラーの記憶域スペースを構成できます。 Windows Server 2012 R2 では、パリティスペースを構成することもできます。 (Windows Server 2012 では、CSV ではパリティスペースはサポートされません)。
  - CSV はクォーラム監視ディスクとして使用できません。 クラスタークォーラムの詳細については、「[記憶域スペースダイレクトのクォーラムに](../storage/storage-spaces/understand-quorum.md)ついて」を参照してください。
  - ディスクを CSV として追加すると、ディスクは CSVFS 形式 (CSV ファイル システム用) で指定されます。 これにより、クラスターと他のソフトウェアは、CSV 記憶域と他の NTFS または ReFS 記憶域を区別できるようになります。 一般に、CSVFS は NTFS または ReFS と同じ機能をサポートしています。 しかし、特定の機能はサポートされていません。 たとえば、Windows Server 2012 R2 では、CSV で圧縮を有効にすることはできません。 Windows Server 2012 では、CSV でデータ重複除去または圧縮を有効にすることはできません。
- **クラスターのリソースの種類**。 CSV ボリュームの場合、リソースの種類として物理ディスクを使用する必要があります。 既定では、クラスター記憶域に追加されるディスクまたは記憶域スペースは自動的にこのように構成されます。
- **クラスター記憶域の CSV ディスクまたは他のディスクの選択**。 クラスター化された仮想マシン用のディスクを 1 つ以上選択する場合は、各ディスクの使用方法を検討します。 ディスクが Hyper-V によって作成されるファイル (VHD ファイルや構成ファイルなど) を格納するために使用される場合は、クラスター記憶域の CSV ディスクまたはその他の使用可能なディスクを選択できます。 ディスクが仮想マシンに直接アタッチされる物理ディスク (パススルー ディスク) である場合は、CSV ディスクを選択できず、クラスター記憶域のその他の使用可能なディスクから選択する必要があります。
- **ディスクを識別するためのパス名**。 CSV のディスクは、パス名で識別されます。 各パスは、ノードのシステムドライブの **\\ Clusterstorage**フォルダーの下に番号付きのボリュームとして表示されます。 このパスは、クラスター内のどのノードから参照しても同じです。 必要な場合、ボリューム名を変更できます。

CSV 用の記憶域の要件については、記憶域のベンダーが提供するガイドラインを確認してください。 CSV 用の記憶域の計画に関するその他の考慮事項については、後述の「 [フェールオーバー クラスターで CSV を使用するための計画](#plan-to-use-csv-in-a-failover-cluster) 」を参照してください。

### <a name="node-requirements"></a>ノードの要件

CSV を使用するには、ノードが次の要件を満たしている必要があります。

- **システム ディスクのドライブ文字**。 すべてのノードで、システム ディスクのドライブ文字は同じにする必要があります。
- **認証プロトコル**。 NTLM プロトコルをすべてのノードで有効にする必要があります。 これは既定で有効になっています。

## <a name="plan-to-use-csv-in-a-failover-cluster"></a>フェールオーバー クラスターで CSV を使用するための計画

このセクションでは、Windows Server 2012 R2 または Windows Server 2012 を実行しているフェールオーバークラスターで CSV を使用するための計画上の考慮事項と推奨事項を示します。

> [!IMPORTANT]
> 特定の記憶域ユニットを CSV 用に構成する方法に関する推奨事項については、記憶域のベンダーに問い合わせてください。 記憶域ベンダーからの推奨事項がこのトピックの情報と異なっている場合は、記憶域ベンダーからの推奨事項に従ってください。

### <a name="arrangement-of-luns-volumes-and-vhd-files"></a>LUN、ボリューム、および VHD ファイルの配置

クラスター化された仮想マシン用の記憶域として CSV を最大限に活用するために、物理サーバーを構成するときに LUN (ディスク) の配置方法を確認します。 対応する仮想マシンを構成するときに、VHD ファイルを同様の方法で配置します。

物理サーバーの場合は、次のようにディスクとファイルを配置します。

- 1 つの物理ディスクにシステム ファイル (ページ ファイルを含む) を配置
- 別の物理ディスクにデータ ファイルを配置

対応するクラスター化された仮想マシンの場合は、ボリュームとファイルを同様の方法で配置します。

- 1 つの CSV にシステム ファイル (ページ ファイルを含む) を VHD ファイルとして配置
- 別の CSV にデータ ファイルを VHD ファイルとして配置

別の仮想マシンを追加する場合は、その仮想マシン用の VHD を同じように配置します。

### <a name="number-and-size-of-luns-and-volumes"></a>LUN およびボリュームの数とサイズ

CSV を使用するフェールオーバー クラスターの記憶域構成を計画する場合、次の推奨事項に従います。

- 構成する LUN の数を決定するには、記憶域のベンダーに問い合わせてください。 たとえば、記憶域ベンダーによっては、各 LUN を 1 つのパーティションで構成し、その LUN に 1 つの CSV ボリュームを配置することを推奨する場合があります。
- 単一の CSV ボリュームでサポートできる仮想マシンの数に制限はありません。 しかし、クラスターに配置する仮想マシンの数と各仮想マシンのワークロード (1 秒あたりの I/O 操作数) を考慮する必要があります。 次に例を示します。

  - ある組織が、ワークロードが比較的軽い仮想ディスク インフラストラクチャ (VDI) をサポートする仮想マシンを展開しようとしています。 クラスターでは高パフォーマンスの記憶域が使用されています。 クラスター管理者は、記憶域のベンダーに相談した結果、CSV ボリュームごとに比較的多くの仮想マシンを配置することを決定しました。
  - 別の組織が、ワークロードが重く、大量に使用されるデータベース アプリケーションをサポートする多数の仮想マシンを展開しようとしています。 クラスターでは性能がより低い記憶域が使用されています。 クラスター管理者は、記憶域のベンダーに相談した結果、CSV ボリュームごとに比較的少ない仮想マシンを配置することを決定しました。
- 特定の仮想マシンの記憶域構成を計画する場合は、その仮想マシンがサポートするサービス、アプリケーション、または役割のディスク要件を考慮します。 これらの要件を理解することで、パフォーマンスの低下につながる可能性のあるディスク競合を回避できます。 仮想マシンの記憶域の構成は、同じサービス、アプリケーション、または役割を実行している物理サーバーに対して使用する記憶域の構成とほぼ同じにする必要があります。 詳細については、このトピックで前述し[た「lun、ボリューム、および VHD ファイルの配置](#arrangement-of-luns-volumes-and-vhd-files)」を参照してください。

    ディスクの競合は、多数の独立した物理ハード ディスクで構成される記憶域を使用することによって減らすことができます。 適切な記憶域ハードウェアを選択し、記憶域のベンダーに問い合わせて記憶域のパフォーマンスを最適化してください。
- クラスターのワークロードと必要な I/O 操作に応じて、仮想マシンの一部のみを各 LUN にアクセスするように構成し、残りの仮想マシンはアクセスを行わず、コンピューティング操作専用にすることを検討します。

## <a name="add-a-disk-to-csv-on-a-failover-cluster"></a>ディスクを CSV としてフェールオーバー クラスターに追加する

フェールオーバー クラスターでは、CSV 機能は既定で有効にされています。 ディスクを CSV に追加するには、ディスクをクラスターの**使用可能記憶域**グループに追加し (まだ追加されていない場合)、続いてクラスターの CSV に追加します。 これらの手順を実行するには、フェールオーバークラスターマネージャーまたはフェールオーバークラスターの Windows PowerShell コマンドレットを使用できます。

### <a name="add-a-disk-to-available-storage"></a>ディスクを使用可能記憶域に追加する

1. フェールオーバー クラスター マネージャーのコンソール ツリーで、クラスターの名前を展開し、 **[記憶域]** を展開します。
2. **[ディスク]** を右クリックし、 **[ディスクの追加]** を選択します。 フェールオーバー クラスターに追加できるディスクの一覧が表示されます。
3. 追加するディスクを選択し、[ **OK]** を選択します。

    ディスクが **[使用可能記憶域]** グループに追加されます。

#### <a name="windows-powershell-equivalent-commands-add-a-disk-to-available-storage"></a>Windows PowerShell の同等のコマンド (使用可能な記憶域にディスクを追加する)

以下の Windows PowerShell コマンドレットは、前述の手順と同じ機能を実行します。 ここでは書式上の制約のために、折り返されて複数の行にわたって表示される場合もありますが、各コマンドレットは 1 行に入力します。

次の例では、クラスターに追加できる状態にあるディスクを識別し、それらを **使用可能記憶域** グループに追加します。

```PowerShell
Get-ClusterAvailableDisk | Add-ClusterDisk
```

### <a name="add-a-disk-in-available-storage-to-csv"></a>使用可能記憶域のディスクを CSV に追加する

1. フェールオーバークラスターマネージャーのコンソールツリーで、クラスターの名前を展開し、 **[記憶域]** を展開して、 **[ディスク]** を選択します。
2. **使用可能記憶域**に割り当てられているディスクを1つまたは複数選択し、その選択を右クリックして、 **[クラスターの共有ボリュームに追加]** を選択します。

    ディスクがクラスターの **[クラスターの共有ボリューム]** グループに割り当てられます。 ディスクは、各クラスター ノードの %SystemDisk%ClusterStorage フォルダーの下に番号付きのボリューム (マウント ポイント) として公開されます。 ボリュームは、CSVFS ファイル システムで表示されます。

>[!NOTE]
>%SystemDisk%ClusterStorage フォルダーの CSV ボリュームの名前を変更できます。

#### <a name="windows-powershell-equivalent-commands-add-a-disk-to-csv"></a>Windows PowerShell の同等のコマンド (CSV へのディスクの追加)

以下の Windows PowerShell コマンドレットは、前述の手順と同じ機能を実行します。 ここでは書式上の制約のために、折り返されて複数の行にわたって表示される場合もありますが、各コマンドレットは 1 行に入力します。

次の例では、 *使用可能記憶域* にある **Cluster Disk 1** をローカル クラスター上の CSV に追加します。

```PowerShell
Add-ClusterSharedVolume –Name "Cluster Disk 1"
```

## <a name="enable-the-csv-cache-for-read-intensive-workloads-optional"></a>大量の読み取りが発生するワークロード用に CSV ブロック キャッシュを有効にする (オプション)

CSV キャッシュは、システム メモリ (RAM) をライトスルー キャッシュとして割り当てることで、読み取り専用バッファなし I/O 操作のブロック レベルのキャッシングを提供します (バッファなし I/O 操作はキャッシュ マネージャーによってキャッシュされません)。これにより、VHD にアクセスするときにバッファなし I/O 操作を実行する Hyper-V などのアプリケーションのパフォーマンスが向上します。 CSV キャッシュは、書き込み要求をキャッシュせずに読み取り要求のパフォーマンスを高めます。 CSV キャッシュの有効化は、スケールアウト ファイル サーバーのシナリオにも役立ちます。

>[!NOTE]
>すべてのクラスター化された Hyper-V およびスケールアウト ファイル サーバー展開で CSV キャッシュを有効にすることをお勧めします。

既定では、Windows Server 2012 では CSV キャッシュは無効になっています。 Windows Server 2012 R2 以降では、CSV キャッシュは既定で有効になっています。 しかし、予約用にブロック キャッシュのサイズを割り当てる必要があります。

次の表に、CSV キャッシュを制御する 2 つの構成設定を示します。

| Windows Server 2012 R2 以降 |  Windows Server 2012                 | 説明 |
| -------------------------------- | ------------------------------------ | ----------- |
| BlockCacheSize                   | SharedVolumeBlockCacheSizeInMB       | これは、クラスター内の各ノードで CSV キャッシュのために予約するメモリ量 (メガバイト) を定義するためのクラスター共通プロパティです。 たとえば、値として 512 を定義した場合、512 MB のシステム メモリが各ノードで予約されます (多くのクラスターでは、512 MB が推奨値です)。既定の設定は 0 (無効の場合) です。 |
| EnableBlockCache                 | CsvEnableBlockCache                  | これはクラスターの物理ディスク リソースのプライベート プロパティです。 このプロパティを使用して、CSV に追加される個々のディスクで CSV キャッシュを有効にできます。 Windows Server 2012 では、既定の設定は 0 (無効) です。 ディスクで CSV キャッシュを有効にするには、値を 1 に設定します。 既定では、Windows Server 2012 R2 では、この設定は有効になっています。 |

CSV キャッシュを監視するには、パフォーマンス モニターで **[クラスター CSV ボリューム キャッシュ]** の下にカウンターを追加します。

#### <a name="configure-the-csv-cache"></a>CSV キャッシュを構成する

1. 管理者として Windows PowerShell を起動します。
2. 各ノードで *512* MB の予約済みキャッシュを定義するには、次のように入力します。

    - Windows Server 2012 R2 以降:

        ```PowerShell
        (Get-Cluster).BlockCacheSize = 512  
        ```

    - Windows Server 2012:

        ```PowerShell
        (Get-Cluster).SharedVolumeBlockCacheSizeInMB = 512  
        ```
3. Windows Server 2012 で、*クラスターディスク 1*という名前の CSV で csv キャッシュを有効にするには、次のように入力します。

    ```PowerShell
    Get-ClusterSharedVolume "Cluster Disk 1" | Set-ClusterParameter CsvEnableBlockCache 1
    ```

>[!NOTE]
> * Windows Server 2012 では、合計物理 RAM の 20% のみを CSV キャッシュに割り当てることができます。 Windows Server 2012 R2 以降では、最大 80% を割り当てることができます。 スケールアウト ファイル サーバーは通常メモリの制約を受けないため、CSV キャッシュ用に追加のメモリを使用してパフォーマンスを大幅に向上させることができます。
> * リソースの競合を回避するには、CSV キャッシュに割り当てられているメモリを変更した後、クラスター内の各ノードを再起動する必要があります。 Windows Server 2012 R2 以降では、再起動は必要なくなりました。
> * 個々のディスクで CSV キャッシュを有効または無効にしたら、設定を有効にするために、物理ディスク リソースをいったんオフラインにしてからオンラインに戻す必要があります。 (既定では、Windows Server 2012 R2 以降では、CSV キャッシュが有効になっています)。 
> * パフォーマンス カウンターに関する情報を含む、CSV キャッシュの詳細については、ブログ記事の「 [CSV キャッシュを有効にする方法](https://blogs.msdn.microsoft.com/clustering/2013/07/19/how-to-enable-csv-cache/)」を参照してください。

## <a name="backing-up-csvs"></a>Csv のバックアップ

フェールオーバークラスターの Csv に格納されている情報をバックアップする方法は複数あります。 Microsoft のバックアップ アプリケーションに加えて、Microsoft 以外のアプリケーションも使用できます。 一般に、CSV では、NTFS または ReFS でフォーマットされたクラスター化された記憶域のバックアップ要件を超える特別なバックアップ要件はありません。 また、CSV バックアップによって他の CSV 記憶域操作が中断されることはありません。

CSV 用のバックアップ アプリケーションとバックアップ スケジューラを選択するときには、次の要素を考慮してください。

- CSV ボリュームのボリュームレベル アクアは、その CSV ボリュームに接続しているどのノードからも実行できます。
- バックアップ アプリケーションは、ソフトウェア スナップショットまたはハードウェア スナップショットを使用できます。 バックアップ アプリケーションがそれらをどの程度サポートするかに応じて、アプリケーション間の整合性およびクラッシュ前後の整合性が維持されるボリューム シャドウ コピー サービス (VSS) スナップショットをバックアップで使用できます。
- 実行している仮想マシンが複数存在する CSV をバックアップする場合は、通常、管理オペレーティング システム ベースのバックアップ手法を選択する必要があります。 バックアップ アプリケーションがこれをサポートしている場合は、複数の仮想マシンを同時にバックアップできます。
- CSV は、Windows Server 2012 R2 バックアップ、Windows Server 2012 バックアップ、または Windows Server 2008 R2 バックアップを実行しているバックアップ要求元をサポートしています。 しかし、Windows Server バックアップは通常、基本的なバックアップ ソリューションのみを提供するため、より大規模なクラスターを使用する組織には適さない場合があります。 Windows Server バックアップは、CSV 上でアプリケーション間の整合性が維持される仮想マシンのバックアップをサポートしていません。 クラッシュ前後の整合性が維持されるボリュームレベルのバックアップのみをサポートしています (クラッシュ前後の整合性が維持されるバックアップを復元する場合、仮想マシンは、バックアップの実行時にクラッシュが発生したときと同じ状態になります)。CSV ボリューム上の仮想マシンのバックアップは成功しますが、 これがサポートされていないことを示すエラー イベントがログに記録されます。
- フェールオーバー クラスターをバックアップするときには、管理者の資格情報が必要になる場合があります。

> [!IMPORTANT]
>バックアップ アプリケーションがどのデータをバックアップおよび復元するか、どの CSV 機能をサポートしているか、および各クラスター ノードでのアプリケーションのリソース要件を注意深く確認してください。

> [!WARNING]
> バックアップ データを CSV ボリュームに復元する必要がある場合は、バックアップ アプリケーションに、クラスター ノードにまたがってアプリケーション間の整合性が維持されるデータを維持および復元する機能と、その機能に対する制限があるかどうかを確認してください。 たとえば、一部のアプリケーションでは、CSV ボリュームをバックアップしたノードとは異なるノードで CSV を復元する場合、復元を実行するノードでアプリケーションの状態に関する重要なデータを誤って上書きする可能性があります。

## <a name="more-information"></a>詳細情報

- [フェールオーバー クラスタリング](failover-clustering.md)
- [クラスター化された記憶域スペースの展開](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj822937(v%3dws.11)>)