---
title: テナント用のシールドされた Vm-テンプレートディスクの作成-オプション
ms.prod: windows-server
ms.topic: article
ms.assetid: c1992f8b-6f88-4dbc-b4a5-08368bba2787
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: d5cdaf915de94e73374459c41b090f197b8f56ef
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2020
ms.locfileid: "85475079"
---
# <a name="shielded-vms-for-tenants---creating-a-template-disk-optional"></a>テナント用のシールドされた Vm-テンプレートディスクの作成 (省略可能)

>適用対象: windows server 2019、Windows Server (半期チャネル)、Windows Server 2016

新しいシールドされた VM を作成するには、特別に準備された署名済みテンプレートディスクを使用する必要があります。 署名付きテンプレートディスクのメタデータは、作成後にディスクが変更されないようにするのに役立ちます。また、テナントとして、シールドされた Vm の作成に使用できるディスクを制限できます。 このディスクを提供する方法の1つは、このトピックで説明するように、テナントで作成することです。

> [!IMPORTANT]
> 必要に応じて、ホスティングサービスプロバイダーによって提供されるテンプレートディスクを代わりに使用することもできます。 これを行う場合は、そのテンプレートディスクを使用してテスト VM をデプロイし、独自のツール (ウイルス対策、脆弱性スキャナーなど) を実行して、実際には信頼できる状態でディスクが検証されるようにすることが重要です。

## <a name="prepare-an-operating-system-vhdx"></a>オペレーティングシステムの VHDX を準備する

シールドされたテンプレートディスクを作成するには、まず、テンプレートディスクウィザードを使用して実行される OS ディスクを準備する必要があります。 このディスクは、シールドされた Vm の OS ディスクとして使用されます。 既存のツールを使用して、Microsoft Desktop Image Service Manager (DISM) などのこのディスクを作成するか、空の VHDX で VM を手動で設定して、そのディスクに OS をインストールすることができます。 ディスクを設定するときは、第2世代またはシールドされた Vm に固有の次の要件に従う必要があります。

| VHDX の要件 | 理由 |
|-----------|----|
|GUID パーティションテーブル (GPT) ディスクである必要があります。 | UEFI をサポートする第2世代仮想マシンのために必要|
|ディスクの種類は、**動的**ではなく**基本**である必要があります。 <br>注: これは、Hyper-v でサポートされている "動的に拡張された" VHDX 機能ではなく、論理ディスクの種類を参照します。 | BitLocker はダイナミックディスクをサポートしていません。|
|ディスクには、少なくとも2つのパーティションがあります。 1つのパーティションに、Windows がインストールされているドライブを含める必要があります。 これは、BitLocker が暗号化するドライブです。 もう1つのパーティションはアクティブなパーティションで、ブートローダーを含み、コンピューターを起動できるように暗号化されていません。|BitLocker に必要|
|ファイルシステムが NTFS | BitLocker に必要|
|VHDX にインストールされているオペレーティングシステムは、次のいずれかになります。<br>-Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、または Windows Server 2012 <br>-Windows 10、Windows 8.1、Windows 8| 第2世代仮想マシンと Microsoft セキュアブートテンプレートをサポートするために必要|
|オペレーティングシステムは一般化されている必要があります (実行 sysprep.exe) | テンプレートのプロビジョニングには、特定のテナントのワークロードに対応する Vm が含まれます。|

> [!NOTE]
> この段階では、テンプレートディスクを VMM ライブラリにコピーしないでください。

### <a name="required-packages-to-create-a-nano-server-template-disk"></a>Nano Server テンプレートディスクを作成するために必要なパッケージ

シールドされた Vm でゲスト OS として Nano Server を実行する予定がある場合は、Nano Server イメージに次のパッケージが含まれていることを確認する必要があります。

- Microsoft-NanoServer-Guest-Package
- Microsoft-NanoServer-SecureStartup-Package

## <a name="run-windows-update-on-the-template-operating-system"></a>テンプレートオペレーティングシステムで Windows Update を実行する

テンプレートディスクで、オペレーティングシステムに最新の Windows 更新プログラムがすべてインストールされていることを確認します。 最近リリースされた更新プログラムは、テンプレートのオペレーティングシステムが最新ではない場合に、完了できない可能性があるプロセスであるエンドツーエンドのシールドプロセスの信頼性を向上させます。

## <a name="sign-and-protect-the-vhdx-with-the-template-disk-wizard"></a>テンプレートディスクの作成ウィザードを使用して VHDX に署名して保護する

シールドされた Vm でテンプレートディスクを使用するには、ディスクが署名され、BitLocker で暗号化されている必要があります。 これを行うには、シールドされたテンプレートディスク作成ウィザードを使用します。 このウィザードでは、ディスクのハッシュが生成され、ボリューム署名カタログ (VSC) に追加されます。 VSC は、指定した証明書を使用して署名されます。テナント用にデプロイされているディスクが変更されていないこと、またはテナントが信頼していないディスクに置き換えられていないことを確認するために、プロビジョニングプロセス中に使用されます。 最後に、VM のプロビジョニング時に暗号化用にディスクを準備するために、ディスクのオペレーティングシステム (まだ存在していない場合) に BitLocker がインストールされます。

> [!NOTE]
> テンプレートディスクウィザードによって、指定したテンプレートディスクがインプレースで変更されます。 後でディスクを更新するためにウィザードを実行する前に、保護されていない VHDX のコピーを作成することもできます。 テンプレートディスクウィザードを使用して保護されているディスクを変更することはできません。

Windows Server 2016 を実行しているコンピューターで、次の手順を実行します (保護されたホストまたは VMM サーバーである必要はありません)。

1. 「[オペレーティングシステムの vhdx](#prepare-an-operating-system-vhdx)をサーバーに準備する」で作成した一般化された vhdx をコピーします (サーバーにまだ存在していない場合)。

2. コンピューターの**リモートサーバー管理ツール**から、シールドされた**VM ツール**機能をインストールします。

        Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart

3. 新しいシールドされた Vm のテンプレートディスクとなる VHDX に署名するための証明書を取得または作成します。 この証明書の詳細は、信頼できるディスクとしてディスクを承認するシールドデータファイルに組み込まれます。 そのため、お客様とホスティングサービスプロバイダーが信頼している証明機関からこの証明書を取得することが重要です。 ホストとテナントの両方であるエンタープライズシナリオでは、PKI からこの証明書を発行することを検討できます。

    テスト環境を設定していて、自己署名証明書を使用してテンプレートディスクに署名する場合は、コンピューターで次のようなコマンドを実行します。

        New-SelfSignedCertificate -DnsName publisher.fabrikam.com

4. [スタート] メニューの [**管理ツール**] フォルダーから**テンプレートディスクウィザード**を起動するか、コマンドプロンプトに「 **TemplateDiskWizard.exe** 」と入力します。

5. [**証明書**] ページで、[**参照**] をクリックして証明書の一覧を表示します。 ディスクテンプレートへの署名に使用する証明書を選択します。 **[OK]** をクリックし、 **[次へ]** をクリックします。

6. [仮想ディスク] ページで、[**参照**] をクリックして、準備した VHDX を選択し、[**次へ**] をクリックします。

7. [署名カタログ] ページで、フレンドリ**ディスク名**とバージョンを指定し**ます。** これらのフィールドは、ディスクが署名された後に識別できるようにするために用意されています。

    たとえば、**ディスク名**として「 _WS2016_ 」と入力します。**バージョン**は_1.0.0.0_です。

8. ウィザードの [設定の確認] ページで選択内容を確認します。 [**生成**] をクリックすると、ウィザードはテンプレートディスクで BitLocker を有効にし、ディスクのハッシュを計算して、ボリューム署名カタログを作成します。これは VHDX メタデータに格納されます。

    署名プロセスが完了するまで待ってから、テンプレートディスクをマウントまたは移動します。 ディスクのサイズによっては、このプロセスが完了するまでに時間がかかることがあります。

9. [**概要**] ページには、ディスクテンプレート、テンプレートに署名するために使用される証明書、および証明書の発行者に関する情報が表示されます。 **[閉じる]** をクリックしてウィザードを終了します。


シールドされたディスクテンプレートを、「シールドされた[VM を定義するシールドデータの作成](guarded-fabric-tenant-creates-shielding-data.md)」で説明されているように、作成するシールドデータファイルと共にホスティングサービスプロバイダーに提供します。

## <a name="additional-references"></a>その他のリファレンス

- [シールドされた VMの展開](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [保護されたファブリックとシールドされた VM](guarded-fabric-and-shielded-vms-top-node.md)
