---
title: Windows のシールドされた VM テンプレートディスクを作成する
ms.custom: na
ms.prod: windows-server
ms.topic: article
ms.assetid: 9c8b84e8-1f5a-47a1-83ca-b1dbd801cb0b
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 01/29/2019
ms.openlocfilehash: 70014c04bbb4425fe3c3fd0379f10cf00abe00ee
ms.sourcegitcommit: 4b4ff8d9e18b2ddcd1916ffa2cd58fffbed8e7ef
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/28/2019
ms.locfileid: "72986444"
---
# <a name="create-a-windows-shielded-vm-template-disk"></a>Windows のシールドされた VM テンプレートディスクを作成する

>適用対象: Windows Server (半期チャネル)、Windows Server 2016、Windows Server 2019


通常の Vm と同様に、VM テンプレート (たとえば、 [Virtual Machine Manager (VMM) の vm テンプレート](https://technet.microsoft.com/system-center-docs/vmm/manage/manage-library-add-vm-templates)) を作成して、テナントと管理者がテンプレートディスクを使用してファブリックに新しい vm を簡単に展開できるようにすることができます。 シールドされた Vm はセキュリティが重要な資産であるため、シールドをサポートする VM テンプレートを作成するための追加の手順があります。 このトピックでは、VMM でシールドされたテンプレートディスクと VM テンプレートを作成する手順について説明します。

このトピックがシールドされた Vm のデプロイプロセス全体にどのように適合するかを理解するには、「保護された[ホストとシールドされた vm のホスティングサービスプロバイダーの構成手順](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)」を参照してください。

## <a name="prepare-an-operating-system-vhdx"></a>オペレーティングシステムの VHDX を準備する

まず OS ディスクを準備し、次に、シールドされたテンプレートディスク作成ウィザードを使用して実行します。 このディスクは、テナントの Vm の OS ディスクとして使用されます。 既存のツールを使用して、Microsoft Desktop Image Service Manager (DISM) などのこのディスクを作成するか、空の VHDX で VM を手動で設定して、そのディスクに OS をインストールすることができます。 ディスクを設定するときは、第2世代またはシールドされた Vm に固有の次の要件に従う必要があります。 

| VHDX の要件 | 原因 |
|-----------|----|
|GUID パーティションテーブル (GPT) ディスクである必要があります。 | UEFI をサポートする第2世代仮想マシンのために必要|
|ディスクの種類は、**動的**ではなく**基本**である必要があります。 <br>注: これは、Hyper-v でサポートされている "動的に拡張された" VHDX 機能ではなく、論理ディスクの種類を参照します。 | BitLocker はダイナミックディスクをサポートしていません。|
|ディスクには、少なくとも2つのパーティションがあります。 1つのパーティションに、Windows がインストールされているドライブを含める必要があります。 これは、BitLocker によって暗号化されるドライブです。 もう1つのパーティションはアクティブなパーティションで、ブートローダーを含み、コンピューターを起動できるように暗号化されていません。|BitLocker に必要|
|ファイルシステムが NTFS | BitLocker に必要|
|VHDX にインストールされているオペレーティングシステムは、次のいずれかになります。<br>-Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、または Windows Server 2012 <br>-Windows 10、Windows 8.1、Windows 8| 第2世代仮想マシンと Microsoft セキュアブートテンプレートをサポートするために必要|
|オペレーティングシステムは一般化されている必要があります (sysprep.exe を実行します)。 | テンプレートのプロビジョニングには、特定のテナントのワークロードに対応する Vm が含まれます。| 

> [!NOTE]
> VMM を使用する場合は、この段階でテンプレートディスクを VMM ライブラリにコピーしないでください。 

## <a name="run-windows-update-on-the-template-operating-system"></a>テンプレートオペレーティングシステムで Windows Update を実行する

テンプレートディスクで、オペレーティングシステムに最新の Windows 更新プログラムがすべてインストールされていることを確認します。 最近リリースされた更新プログラムは、テンプレートのオペレーティングシステムが最新ではない場合に、完了できない可能性があるプロセスであるエンドツーエンドのシールドプロセスの信頼性を向上させます。

## <a name="prepare-and-protect-the-vhdx-with-the-template-disk-wizard"></a>テンプレートディスクの作成ウィザードを使用して VHDX を準備して保護する

シールドされた Vm でテンプレートディスクを使用するには、シールドされたテンプレートディスク作成ウィザードを使用して、BitLocker でディスクを準備し、暗号化する必要があります。 このウィザードでは、ディスクのハッシュが生成され、ボリューム署名カタログ (VSC) に追加されます。 VSC は、指定した証明書を使用して署名されます。テナント用にデプロイされているディスクが変更されていないこと、またはテナントが信頼していないディスクに置き換えられていないことを確認するために、プロビジョニングプロセス中に使用されます。 最後に、VM のプロビジョニング時に暗号化用にディスクを準備するために、ディスクのオペレーティングシステム (まだ存在していない場合) に BitLocker がインストールされます。

> [!NOTE]
> テンプレートディスクウィザードによって、指定したテンプレートディスクがインプレースで変更されます。 後でディスクを更新するためにウィザードを実行する前に、保護されていない VHDX のコピーを作成することもできます。 テンプレートディスクウィザードを使用して保護されているディスクを変更することはできません。

Windows Server 2016、Windows 10 (リモートサーバー管理ツール、RSAT がインストールされている) 以降を実行しているコンピューターで、次の手順を実行します (保護されたホストまたは VMM サーバーである必要はありません)。

1. 「[オペレーティングシステムの vhdx](#prepare-an-operating-system-vhdx)をサーバーに準備する」で作成した一般化された vhdx をコピーします (サーバーにまだ存在していない場合)。

2. サーバーをローカルで管理するには、サーバーの**リモートサーバー管理ツール**からシールドされた**VM ツール**機能をインストールします。

        Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart
        
    また、 [Windows 10 リモートサーバー管理ツール](https://www.microsoft.com/en-us/download/details.aspx?id=45520)がインストールされているクライアントコンピューターからサーバーを管理することもできます。

3. 新しいシールドされた Vm のテンプレートディスクとなる VHDX の VSC に署名するための証明書を取得または作成します。 この証明書の詳細は、テナントがシールドデータファイルを作成し、信頼するディスクを承認しているときに、テナントに表示されます。 そのため、この証明書は、自分とテナントが相互に信頼している証明機関から取得することが重要です。 ホストとテナントの両方であるエンタープライズシナリオでは、PKI からこの証明書を発行することを検討できます。

    テスト環境をセットアップし、自己署名証明書のみを使用してテンプレートディスクを準備する場合は、次のようなコマンドを実行します。

        New-SelfSignedCertificate -DnsName publisher.fabrikam.com

4. スタート メニューの **管理ツール** フォルダーから**テンプレートディスクウィザード**を起動するか、コマンドプロンプトに「 **templatediskwizard .exe** 」と入力します。

5. **[証明書]** ページで、 **[参照]** をクリックして証明書の一覧を表示します。 ディスクテンプレートを準備するために使用する証明書を選択します。 **[OK]** をクリックし、 **[次へ]** をクリックします。

6. 仮想ディスク ページで、**参照** をクリックして、準備した VHDX を選択し、**次へ** をクリックします。

7. [署名カタログ] ページで、フレンドリ**ディスク名**とバージョンを指定し**ます。** これらのフィールドは、準備ができたディスクを識別するために用意されています。

    たとえば、**ディスク名**として「 _WS2016_ 」と入力します。**バージョン**は_1.0.0.0_です。

8. ウィザードの [設定の確認] ページで選択内容を確認します。 **[生成]** をクリックすると、ウィザードはテンプレートディスクで BitLocker を有効にし、ディスクのハッシュを計算して、ボリューム署名カタログを作成します。これは VHDX メタデータに格納されます。

    テンプレートディスクのマウントまたは移動を試行する前に、準備プロセスが完了するまで待ちます。 ディスクのサイズによっては、このプロセスが完了するまでに時間がかかることがあります。

    > [!IMPORTANT]
    > テンプレートディスクは、セキュリティで保護されたシールドされた VM のプロビジョニングプロセスでのみ使用できます。
    > テンプレートディスクを使用して通常の (シールドされていない) VM を起動しようとすると、停止エラー (ブルースクリーン) が発生し、サポートされていない可能性があります。

9. **[概要]** ページには、ディスクテンプレート、VSC の署名に使用された証明書、および証明書の発行者に関する情報が表示されます。 **[閉じる]** をクリックしてウィザードを終了します。

VMM を使用する場合は、このトピックの残りのセクションの手順に従って、テンプレートディスクを VMM のシールドされた VM テンプレートに組み込みます。 

## <a name="copy-the-template-disk-to-the-vmm-library"></a>テンプレートディスクを VMM ライブラリにコピーする

VMM を使用する場合は、テンプレートディスクを作成した後で、VMM ライブラリ共有にコピーして、新しい Vm のプロビジョニング時にホストがディスクをダウンロードして使用できるようにする必要があります。 テンプレートディスクを VMM ライブラリにコピーしてから、ライブラリを最新の状態に更新するには、次の手順を使用します。

1. VHDX ファイルを VMM ライブラリ共有フォルダーにコピーします。 既定の VMM 構成を使用した場合は、テンプレートディスクを _\\<vmmserver>\MSSCVMMLibrary\VHDs_にコピーします。

2. ライブラリサーバーを最新の状態に更新します。 **[ライブラリ]** ワークスペースを開き、 **[ライブラリサーバー]** を展開し、更新するライブラリサーバーを右クリックして、 **[更新]** をクリックします。

3. 次に、テンプレートディスクにインストールされているオペレーティングシステムに関する情報を VMM に提供します。

    」を参照します。 ライブラリサーバーの **[ライブラリ]** ワークスペースで、新しくインポートしたテンプレートディスクを見つけます。

    b. ディスクを右クリックし、 **[プロパティ]** をクリックします。

    c. **[オペレーティングシステム]** で、一覧を展開し、ディスクにインストールされているオペレーティングシステムを選択します。 オペレーティングシステムを選択すると、VHDX が空でないことが VMM に示されます。

    d. プロパティを更新したら、[OK] をクリックします。

ディスク名の横にある小さな盾アイコンは、シールドされた Vm 用の準備済みテンプレートディスクとしてディスクを表します。 また、列ヘッダーを右クリックし、**シールド**された列を切り替えて、ディスクが通常の VM デプロイとシールドされた VM の展開のどちらであるかを示すテキスト表現を表示することもできます。

![シールドされた vm テンプレートディスク](../media/Guarded-Fabric-Shielded-VM/shielded-vm-template-disk.png)

## <a name="create-the-shielded-vm-template-in-vmm-using-the-prepared-template-disk"></a>準備されたテンプレートディスクを使用して VMM でシールドされた VM テンプレートを作成する

VMM ライブラリの準備済みテンプレートディスクを使用して、シールドされた Vm 用の VM テンプレートを作成することができます。 シールドされた Vm の VM テンプレートは、特定の設定が固定されている (第2世代 VM、UEFI およびセキュアブートが有効など) という点で、従来の VM テンプレートと若干異なります (テナントのカスタマイズは、VM のいくつかのプロパティに制限されています). VM テンプレートを作成するには、次の手順を実行します。

1. **[ライブラリ]** ワークスペースで、上部にある ホーム タブの  **[VM テンプレートの作成]** をクリックします。

2. [ソースの選択] ページで、[ライブラリに保管された既存の VM テンプレートまたはバーチャル ハード ディスクを使用する] をクリックし、[参照] をクリックします。

3. 表示されるウィンドウで、VMM ライブラリから準備済みテンプレートディスクを選択します。 どのディスクが準備されているかをより簡単に識別するには、列ヘッダーを右クリックし、**シールド**された列を有効にします。 [ **OK]** 、 **[次へ]** の順にクリックします。

4. VM テンプレート名と、必要に応じて説明を指定し、 **[次へ]** をクリックします。

5. **[ハードウェアの構成]** ページで、このテンプレートから作成された vm の機能を指定します。 少なくとも1つの NIC が VM テンプレートで使用可能で構成されていることを確認してください。 テナントがシールドされた VM に接続する唯一の方法は、ネットワークプロトコル経由で動作するリモートデスクトップ接続、Windows リモート管理、またはその他の事前構成されたリモート管理ツールを使用することです。

    テナントネットワークで DHCP サーバーを実行するのではなく、VMM で静的 IP プールを利用する場合は、テナントにこの構成を通知する必要があります。 テナントは、VMM の無人セットアップファイルを含むシールドデータファイルを提供するときに、静的 IP プール情報に対して特殊なプレースホルダー値を指定する必要があります。 テナントの無人セットアップファイルでの VMM プレースホルダーの詳細については、「[応答ファイルの作成](guarded-fabric-tenant-creates-shielding-data.md#create-an-answer-file)」を参照してください。 

6. **[オペレーティングシステムの構成]** ページでは、VMM では、プロダクトキー、タイムゾーン、コンピューター名など、シールドされた vm に対していくつかのオプションのみを表示します。 管理者パスワードやドメイン名など、セキュリティで保護された情報の一部は、シールドデータファイル () を使用してテナントによって指定されます。PDK ファイル)。 

    > [!NOTE]
    > このページでプロダクトキーを指定する場合は、テンプレートディスクのオペレーティングシステムに対して有効であることを確認します。 無効なプロダクトキーが使用されている場合、VM の作成は失敗します。

テンプレートが作成されると、テナントはそれを使用して新しい仮想マシンを作成できます。 VM テンプレートがテナント管理者ユーザーロールで使用できるリソースの1つであることを確認する必要があります (VMM では、ユーザーロールは **[設定]** ワークスペースにあります)。

## <a name="prepare-and-protect-the-vhdx-using-powershell"></a>PowerShell を使用して VHDX を準備して保護する

テンプレートディスクウィザードを実行する代わりに、RSAT を実行しているコンピューターにテンプレートディスクと証明書をコピーし、 [Protect-TemplateDisk](https://docs.microsoft.com/powershell/module/shieldedvmtemplate/protect-templatedisk?view=win10-ps
)を実行して署名プロセスを開始することもできます。
次の例では、 _TemplateName_および_version_パラメーターで指定された名前とバージョン情報を使用します。
`-Path` パラメーターに指定した VHDX は、更新されたテンプレートディスクで上書きされます。そのため、コマンドを実行する前にコピーを作成してください。

```powershell
# Replace "THUMBPRINT" with the thumbprint of your template disk signing certificate in the line below
$certificate = Get-Item Cert:\LocalMachine\My\THUMBPRINT

Protect-TemplateDisk -Certificate $certificate -Path "WindowsServer2019-ShieldedTemplate.vhdx" -TemplateName "Windows Server 2019" -Version 1.0.0.0
```

これで、テンプレートディスクを使用して、シールドされた Vm をプロビジョニングする準備ができました。
System Center Virtual Machine Manager を使用して VM をデプロイしている場合は、VHDX を VMM ライブラリにコピーできるようになりました。

また、VHDX からボリューム署名カタログを抽出することもできます。
このファイルは、テンプレートを使用する VM 所有者に、署名証明書、ディスク名、およびバージョンに関する情報を提供するために使用されます。
このファイルを承認するには、このファイルをシールドデータファイルウィザードにインポートして、署名証明書を所有しているテンプレートの作成者に対して、このファイル用のテンプレートディスクを作成する必要があります。

ボリューム署名カタログを抽出するには、PowerShell で次のコマンドを実行します。

```powershell
Save-VolumeSignatureCatalog -TemplateDiskPath 'C:\temp\MyLinuxTemplate.vhdx' -VolumeSignatureCatalogPath 'C:\temp\MyLinuxTemplate.vsc'
```


## <a name="next-step"></a>次の手順

> [!div class="nextstepaction"]
> [シールドデータファイルを作成する](guarded-fabric-tenant-creates-shielding-data.md)

## <a name="see-also"></a>関連項目

- [保護されたホストとシールドされた Vm のホスティングサービスプロバイダーの構成手順](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [保護されたファブリックとシールドされた VM](guarded-fabric-and-shielded-vms-top-node.md)
