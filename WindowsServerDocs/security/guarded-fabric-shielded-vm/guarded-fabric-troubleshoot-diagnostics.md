---
title: 保護されたファブリック診断ツールを使用したトラブルシューティング
ms.custom: na
ms.prod: windows-server
ms.topic: article
ms.assetid: 07691d5b-046c-45ea-8570-a0a85c3f2d22
manager: dongill
author: huu
ms.technology: security-guarded-fabric
ms.openlocfilehash: 6db9ce1db139558bd1a7aa731cb12c1b227ead03
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/14/2020
ms.locfileid: "75949759"
---
# <a name="troubleshooting-using-the-guarded-fabric-diagnostic-tool"></a>保護されたファブリック診断ツールを使用したトラブルシューティング

>適用対象: windows server 2019、Windows Server (半期チャネル)、Windows Server 2016

このトピックでは、保護されたファブリックのインフラストラクチャのデプロイ、構成、および実行中の操作の一般的なエラーを特定して修復するための、保護されたファブリック診断ツールの使用方法について説明します。 これには、ホストガーディアンサービス (HGS)、保護されたすべてのホスト、および DNS や Active Directory などのサポートサービスが含まれます。 診断ツールを使用すると、保護されていないファブリックの方針に従って、管理者が障害を解決し、正しく構成されていない資産を特定できるようになります。 このツールは、保護されたファブリックの運用を音で区別するためのものではなく、日常の操作中に発生した最も一般的な問題を迅速に検証するためにのみ機能します。

このトピックで使用するコマンドレットのドキュメントについては、 [TechNet](https://technet.microsoft.com/library/mt718834.aspx)を参照してください。

[!INCLUDE [Guarded fabric diagnostics tool](../../../includes/guarded-fabric-diagnostics-tool.md)] 

## <a name="quick-start"></a>クイック スタート

ローカル管理者特権を持つ Windows PowerShell セッションから次のものを呼び出して、保護されたホストまたは HGS ノードのいずれかを診断できます。
```PowerShell
Get-HgsTrace -RunDiagnostics -Detailed
```
これにより、現在のホストの役割が自動的に検出され、自動的に検出される可能性のある関連する問題が診断されます。  `-Detailed` スイッチが存在するため、このプロセス中に生成されたすべての結果が表示されます。

このトピックの残りの部分では、複数のホストを一度に診断し、複雑なクロスノード構成の誤りを検出するなどの操作を行うための `Get-HgsTrace` の高度な使用方法について詳しく説明します。

## <a name="diagnostics-overview"></a>診断の概要
保護されたファブリック診断は、Server Core を実行しているホストを含め、仮想マシンに関連するシールドされたツールと機能がインストールされている任意のホストで利用できます。  現在、診断は次の機能/パッケージに含まれています。

1. ホストガーディアンサービスの役割
2. Host Guardian Hyper-V サポート
3. Fabric Management 用の VM シールド ツール
4. リモート サーバー管理ツール (RSAT)

つまり、診断ツールは、すべての保護されたホスト、HGS ノード、特定のファブリック管理サーバー、 [RSAT](https://www.microsoft.com/download/details.aspx?id=45520)がインストールされているすべての Windows 10 ワークステーションで使用できるようになります。  保護されたファブリックの保護されたホストまたは HGS ノードを診断する目的で、上記のいずれかのコンピューターから診断を呼び出すことができます。リモートトレースターゲットを使用すると、診断を実行しているコンピューター以外のホストを検出して接続できます。

診断の対象となるすべてのホストは、"トレースターゲット" と呼ばれます。  トレースターゲットは、ホスト名とロールによって識別されます。  ロールは、保護されたファブリックで特定のトレースターゲットが実行する関数を記述します。  現在、トレースターゲットは `HostGuardianService` ロールと `GuardedHost` ロールをサポートしています。  注ホストは一度に複数のロールを占有することができ、これは診断でもサポートされますが、これは運用環境では実行できません。  HGS ホストと Hyper-v ホストは常に個別に保持する必要があります。

管理者は `Get-HgsTrace`を実行することで、任意の診断タスクを開始できます。  このコマンドは、実行時に提供されるスイッチに基づいて、トレースコレクションと診断の2つの異なる関数を実行します。  これら2つの組み合わせによって、保護されたファブリック診断ツールの全体が構成されます。  明示的に必須ではありませんが、最も有用な診断では、トレースターゲットで管理者の資格情報を使用してのみ収集できるトレースが必要です。  トレースコレクションを実行しているユーザーが十分な特権を持っていない場合、昇格が必要なトレースは失敗し、他のトレースは成功します。  これにより、権限の低いオペレーターがトリアージを実行しているときに、部分的な診断を行うことができます。 

### <a name="trace-collection"></a>トレースコレクション
既定では、`Get-HgsTrace` はトレースを収集し、一時フォルダーに保存します。  トレースは、ターゲットホストの後に指定されたフォルダーの形式になり、ホストの構成方法を説明する特殊な形式のファイルが格納されます。  トレースには、トレースを収集するために診断がどのように呼び出されたかを説明するメタデータも含まれています。  このデータは、手動診断の実行時にホストに関する情報を復元するために診断によって使用されます。

必要に応じて、トレースを手動で確認できます。  すべての形式は人間が判読できる (XML) か、標準ツール (X509 証明書や Windows Crypto シェル拡張機能など) を使用して簡単に検査することができます。  ただし、トレースは手動で診断するように設計されていないため、常に `Get-HgsTrace`の診断機能を使用してトレースを処理する方が効率的です。

実行中のトレースコレクションの結果は、特定のホストの正常性を示すものではありません。  これは、トレースが正常に収集されたことを示しているだけです。  `Get-HgsTrace` の診断機能を使用して、トレースが失敗した環境を示しているかどうかを判断する必要があります。

`-Diagnostic` パラメーターを使用すると、指定した診断を操作するために必要なトレースのみをトレースコレクションに限定できます。  これにより、収集されるデータの量だけでなく、診断を呼び出すために必要なアクセス許可も減少します。

### <a name="diagnosis"></a>Diagnosis
収集されたトレースは、`-Path` パラメーターを使用し、`-RunDiagnostics` スイッチを指定することによって、トレースの場所 `Get-HgsTrace` 指定して診断できます。  さらに、`Get-HgsTrace` は、`-RunDiagnostics` スイッチとトレースターゲットの一覧を提供することで、単一のパスで収集と診断を実行できます。  トレースターゲットが指定されていない場合は、現在のコンピューターが暗黙的なターゲットとして使用され、インストールされている Windows PowerShell モジュールを調べることによってその役割が推論されます。

診断では、特定のエラーの原因となっているトレースターゲット、診断セット、および個々の診断を示す階層形式で結果が得られます。  エラーには、次に実行するアクションを決定する際に、修復と解決策に関する推奨事項が含まれます。  既定では、渡された結果と無関係の結果は非表示になります。  診断によってテストされたすべてを表示するには、`-Detailed` スイッチを指定します。  これにより、状態に関係なくすべての結果が表示されます。

`-Diagnostic` パラメーターを使用して実行される診断のセットを制限することができます。  これにより、トレースターゲットに対して実行する診断のクラスを指定し、他のすべての診断を抑制することができます。  使用可能な診断クラスの例としては、ネットワーク、ベストプラクティス、クライアントハードウェアなどがあります。  使用可能な診断の最新の一覧については、[コマンドレットのドキュメント](https://technet.microsoft.com/library/mt718831.aspx)を参照してください。

> [!WARNING]
> 診断は、強力な監視とインシデント対応のパイプラインに代わるものではありません。  保護されたファブリックの監視に使用できる System Center Operations Manager パッケージと、問題を早期に検出するために監視できるさまざまなイベントログチャネルがあります。  診断を使用して、これらの障害を迅速にトリアージし、一連の措置を取ることができます。

## <a name="targeting-diagnostics"></a>診断のターゲット設定

`Get-HgsTrace` は、トレースターゲットに対して動作します。  トレースターゲットは、保護されたファブリック内の HGS ノードまたは保護されたホストに対応するオブジェクトです。  これは `PSSession` の拡張機能と考えることができます。これには、ファブリック内のホストの役割など、診断によってのみ必要とされる情報が含まれます。  ターゲットは、暗黙的に生成する (ローカル診断や手動診断など) ことも、`New-HgsTraceTarget` コマンドを使用して明示的に生成することもできます。

### <a name="local-diagnosis"></a>ローカル診断

既定では、`Get-HgsTrace` は localhost (つまり、コマンドレットが呼び出されている場所) を対象とします。  これは、暗黙的なローカルターゲットと呼ばれます。  暗黙的なローカルターゲットは、`-Target` パラメーターでターゲットが指定されておらず、`-Path`内に既存のトレースが見つからない場合にのみ使用されます。

暗黙のローカルターゲットは、ロールの推論を使用して、保護されたファブリックで現在のホストがどのロールを果たしているかを判断します。  これは、インストールされている Windows PowerShell モジュールに基づいています。このモジュールは、システムにインストールされている機能にほぼ対応しています。  `HgsServer` モジュールが存在すると、トレースターゲットがロール `HostGuardianService` され、`HgsClient` モジュールの存在によってトレースターゲットがロール `GuardedHost`を取得します。  特定のホストで両方のモジュールを使用することができますが、その場合は、`HostGuardianService` と `GuardedHost`の両方として扱われます。

したがって、ローカルでトレースを収集するための診断の既定の呼び出しは次のとおりです。
```PowerShell
Get-HgsTrace
```
...は、次の場合と同じです。
```PowerShell
New-HgsTraceTarget -Local | Get-HgsTrace
```
> [!TIP]
> `Get-HgsTrace` は、パイプライン経由で、または `-Target` パラメーターを使用して直接ターゲットを受け入れることができます。  2つの運用の間に違いはありません。

### <a name="remote-diagnosis-using-trace-targets"></a>トレースターゲットを使用したリモート診断

リモート接続情報を使用してトレースターゲットを生成することで、ホストをリモートで診断することができます。  必要なのは、ホスト名と、Windows PowerShell リモート処理を使用して接続できる資格情報のセットだけです。
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $server
```
この例では、リモートユーザーの資格情報を収集するためのプロンプトが生成され、`hgs-01.secure.contoso.com` のリモートホストを使用して診断が実行され、トレースコレクションが完了します。  結果のトレースは localhost にダウンロードされ、診断されます。  診断の結果は、[ローカル診断](#local-diagnosis)を実行する場合と同じように表示されます。  同様に、役割は、リモートシステムにインストールされている Windows PowerShell モジュールに基づいて推論できるため、指定する必要はありません。

リモート診断では、リモートホストへのすべてのアクセスに Windows PowerShell リモート処理を利用します。  そのため、トレースターゲットで Windows PowerShell リモート処理が有効に[なっている](https://technet.microsoft.com/library/hh849694.aspx)ことと、ターゲットへの接続を開始するために localhost が適切に構成されていることが前提条件となります。

> [!NOTE]
> ほとんどの場合、localhost は同じ Active Directory フォレストの一部であり、有効な DNS ホスト名が使用されている必要があります。  環境でより複雑なフェデレーションモデルを使用している場合、または接続に直接 IP アドレスを使用する場合は、WinRM の[信頼さ](https://technet.microsoft.com/library/ff700227.aspx)れたホストの設定など、追加の構成を実行することが必要になる場合があります。

`Test-HgsTraceTarget` コマンドレットを使用して、トレースターゲットが適切にインスタンス化され、接続を受け入れるように構成されていることを確認できます。
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
$server | Test-HgsTraceTarget
```
このコマンドは、`Get-HgsTrace` がトレースターゲットとのリモート診断セッションを確立できる場合にのみ、`$True` を返します。  エラーが発生すると、このコマンドレットは、Windows PowerShell リモート処理接続のトラブルシューティングに関連する状態情報を返します。

#### <a name="implicit-credentials"></a>暗黙的な資格情報

トレースターゲットにリモート接続するための十分な特権を持つユーザーからリモート診断を実行する場合、資格情報を `New-HgsTraceTarget`に渡す必要はありません。  `Get-HgsTrace` コマンドレットでは、接続を開くときに、コマンドレットを呼び出したユーザーの資格情報が自動的に再利用されます。

> [!WARNING]
> 特に "2 番目のホップ" と呼ばれるものを実行する場合、資格情報の再利用にはいくつかの制限が適用されます。  このエラーは、リモートセッション内から別のコンピューターに資格情報を再利用しようとした場合に発生します。  このシナリオをサポートするには[CredSSP をセットアップ](https://technet.microsoft.com/library/hh849872.aspx)する必要がありますが、これは、保護されたファブリック管理とトラブルシューティングの範囲外です。

#### <a name="using-windows-powershell-just-enough-administration-jea-and-diagnostics"></a>Windows PowerShell を使用するだけで十分な管理 (JEA) と診断

リモート診断は、JEA によって制約された Windows PowerShell エンドポイントの使用をサポートしています。 既定では、リモートトレースのターゲットは、既定の `microsoft.powershell` エンドポイントを使用して接続します。  トレースターゲットに `HostGuardianService` ロールがある場合は、HGS のインストール時に構成されている `microsoft.windows.hgs` エンドポイントも使用されます。

カスタムエンドポイントを使用する場合は、次のように `-PSSessionConfigurationName` パラメーターを使用してトレースターゲットを構築するときに、セッション構成名を指定する必要があります。

```PowerShell
New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential) -PSSessionConfigurationName "microsoft.windows.hgs"
```

#### <a name="diagnosing-multiple-hosts"></a>複数のホストの診断

一度に複数のトレースターゲットを `Get-HgsTrace` に渡すことができます。  これには、ローカルとリモートの両方のターゲットが含まれます。  各ターゲットは順番にトレースされ、その後、すべてのターゲットからのトレースが同時に診断されます。  診断ツールでは、デプロイに関する知識が高まっているため、複雑なクロスノードの誤りを特定できますが、それ以外は検出できません。  この機能を使用するには、複数のホストからのトレースを同時に提供する (手動診断の場合) か、`Get-HgsTrace` を呼び出すときに複数のホストを対象にする (リモート診断の場合) 必要があります。

リモート診断を使用して、2つの HGS ノードと2つの保護されたホストで構成されるファブリックをトリアージする例を次に示します。この場合、保護されたホストの1つが `Get-HgsTrace`の起動に使用されます。

```PowerShell
$hgs01 = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Credential (Enter-Credential)
$hgs02 = New-HgsTraceTarget -HostName "hgs-02.secure.contoso.com" -Credential (Enter-Credential)
$gh01 = New-HgsTraceTarget -Local
$gh02 = New-HgsTraceTarget -HostName "guardedhost-02.contoso.com"
Get-HgsTrace -Target $hgs01,$hgs02,$gh01,$gh02 -RunDiagnostics
```

> [!NOTE]
> 複数のノードを診断するときに、保護されたファブリック全体を診断する必要はありません。  多くの場合、特定のエラー条件に関係する可能性があるすべてのノードを含めるだけで十分です。  これは通常、保護されたホストのサブセットであり、HGS クラスターからいくつかのノードになります。

## <a name="manual-diagnosis-using-saved-traces"></a>保存されたトレースを使用した手動診断

場合によっては、再度トレースを収集せずに診断を再実行するか、ファブリック内のすべてのホストを同時にリモートで診断するために必要な資格情報を持っていないことがあります。  手動診断は、`Get-HgsTrace`を使用してファブリック全体のトリアージを実行できますが、リモートトレースコレクションを使用することはできません。

手動診断を実行する前に、トリアージされるファブリック内の各ホストの管理者が、ユーザーに代わってコマンドを実行する準備ができていることを確認する必要があります。  診断トレース出力では、一般に機密として表示される情報は公開されませんが、この情報を他のユーザーに公開するのが安全かどうかを判断するためにユーザーに課せられます。

> [!NOTE]
> トレースは匿名化ではなく、ネットワーク構成、PKI 設定、およびその他の構成 (プライベート情報と見なされることもあります) を明らかにします。  そのため、トレースは組織内の信頼されたエンティティにのみ送信され、公開されることはありません。

手動診断を実行する手順は次のとおりです。

1. 各ホスト管理者に対して、既知の `-Path` と、結果のトレースに対して実行する診断の一覧を指定 `Get-HgsTrace` を実行するよう要求します。  たとえば次のようになります。

   ```PowerShell
   Get-HgsTrace -Path C:\Traces -Diagnostic Networking,BestPractices
   ```
2. 各ホスト管理者に対して、結果として得られるトレースフォルダーをパッケージ化し、送信するように要求します。  このプロセスは、電子メール、ファイル共有、または組織によって確立されたオペレーティングポリシーと手順に基づくその他のメカニズムによって促進できます。

3. 受信したすべてのトレースを1つのフォルダーにマージします。他のコンテンツやフォルダーは含まれません。

    * たとえば、管理者が、HGS-01、HGS-02、RR1N2608、および RR1N2608 という名前の4台のコンピューターから収集されたトレースを送信したとします。  各管理者には、同じ名前でフォルダーが送信されています。  次のようなディレクトリ構造をアセンブルします。

      ```
      FabricTraces
      |- HGS-01
      |  |- TargetMetadata.xml
      |  |- Metadata.xml
      |  |- [any other trace files for this host]
      |- HGS-02
      |  |- [...]
      |- RR1N2608-12
      |  |- [...]
      |- RR1N2608-13
         |- [..]
      ```

4. 診断を実行し、`-Path` パラメーターでアセンブルされたトレースフォルダーへのパスを指定し、`-RunDiagnostics` スイッチと、トレースの収集を管理者に依頼した診断を指定します。  診断では、パス内に存在するホストにアクセスできないと見なし、事前に収集されたトレースのみを使用しようとします。  トレースが見つからないか破損している場合、診断は影響を受けるテストのみを失敗として正常に続行します。  たとえば次のようになります。

   ```PowerShell
   Get-HgsTrace -RunDiagnostics -Diagnostic Networking,BestPractices -Path ".\FabricTraces"
   ```

### <a name="mixing-saved-traces-with-additional-targets"></a>保存されたトレースと追加のターゲットの混合

場合によっては、追加のホストトレースによって拡張する、事前に収集された一連のトレースが必要になることがあります。  診断の1回の呼び出しでトレースおよび診断される追加のターゲットと共に、事前に収集されたトレースを混在させることができます。

上で指定したトレースフォルダーを収集してアセンブルする手順に従って、事前に収集されたトレースフォルダーにない追加のトレースターゲットを使用して `Get-HgsTrace` を呼び出します。

```PowerShell
$hgs03 = New-HgsTraceTarget -HostName "hgs-03.secure.contoso.com" -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $hgs03 -Path .\FabricTraces
``` 

診断コマンドレットは、事前に収集されたすべてのホストと、トレースする必要がある追加のホストを特定し、必要なトレースを実行します。  事前に収集されたすべてのトレースと新しく収集されたトレースの合計が診断されます。  結果のトレースフォルダーには、古いトレースと新しいトレースの両方が含まれます。
