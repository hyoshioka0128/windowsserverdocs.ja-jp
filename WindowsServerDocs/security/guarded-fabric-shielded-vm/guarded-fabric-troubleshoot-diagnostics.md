---
title: 保護されたファブリック診断ツールを使用したトラブルシューティング
ms.topic: article
ms.assetid: 07691d5b-046c-45ea-8570-a0a85c3f2d22
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.date: 01/14/2020
ms.openlocfilehash: 40381a08c22c8b559fbf2b7da8e8151e91c77718
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87995368"
---
# <a name="troubleshooting-using-the-guarded-fabric-diagnostic-tool"></a>保護されたファブリック診断ツールを使用したトラブルシューティング

>適用対象: windows server 2019、Windows Server (半期チャネル)、Windows Server 2016

このトピックでは、保護されたファブリックのインフラストラクチャのデプロイ、構成、および実行中の操作の一般的なエラーを特定して修復するための、保護されたファブリック診断ツールの使用方法について説明します。 これには、ホストガーディアンサービス (HGS)、保護されたすべてのホスト、および DNS や Active Directory などのサポートサービスが含まれます。 診断ツールを使用すると、保護されていないファブリックの方針に従って、管理者が障害を解決し、正しく構成されていない資産を特定できるようになります。 このツールは、保護されたファブリックの運用を音で区別するためのものではなく、日常の操作中に発生した最も一般的な問題を迅速に検証するためにのみ機能します。

この記事で使用されているコマンドレットの完全なドキュメントについては、 [HgsDiagnostics モジュールリファレンスを参照](/powershell/module/hgsdiagnostics/?view=win10-ps)してください。

[!INCLUDE [Guarded fabric diagnostics tool](../../../includes/guarded-fabric-diagnostics-tool.md)]

## <a name="quick-start"></a>クイック スタート

ローカル管理者特権を持つ Windows PowerShell セッションから次のものを呼び出して、保護されたホストまたは HGS ノードのいずれかを診断できます。

```PowerShell
Get-HgsTrace -RunDiagnostics -Detailed
```

これにより、現在のホストの役割が自動的に検出され、自動的に検出される可能性のある関連する問題が診断されます。  スイッチが存在するため、このプロセス中に生成されたすべての結果が表示され `-Detailed` ます。

このトピックの残りの部分では、 `Get-HgsTrace` 複数のホストを一度に診断し、複雑なクロスノード構成の誤りを検出するなど、の高度な使用方法について詳しく説明します。

## <a name="diagnostics-overview"></a>診断の概要

保護されたファブリック診断は、Server Core を実行しているホストを含め、仮想マシンに関連するシールドされたツールと機能がインストールされている任意のホストで利用できます。  現在、診断は次の機能/パッケージに含まれています。

1. ホストガーディアンサービスの役割
2. Host Guardian Hyper-V サポート
3. Fabric Management 用の VM シールド ツール
4. リモート サーバー管理ツール (RSAT)

つまり、診断ツールは、すべての保護されたホスト、HGS ノード、特定のファブリック管理サーバー、 [RSAT](https://www.microsoft.com/download/details.aspx?id=45520)がインストールされているすべての Windows 10 ワークステーションで使用できるようになります。  保護されたファブリックの保護されたホストまたは HGS ノードを診断する目的で、上記のいずれかのコンピューターから診断を呼び出すことができます。リモートトレースターゲットを使用すると、診断を実行しているコンピューター以外のホストを検出して接続できます。

診断の対象となるすべてのホストは、"トレースターゲット" と呼ばれます。  トレースターゲットは、ホスト名とロールによって識別されます。  ロールは、保護されたファブリックで特定のトレースターゲットが実行する関数を記述します。  現在、トレースターゲットは `HostGuardianService` との役割をサポートして `GuardedHost` います。  注ホストは一度に複数のロールを占有することができ、これは診断でもサポートされますが、これは運用環境では実行できません。  HGS ホストと Hyper-v ホストは常に個別に保持する必要があります。

管理者は、を実行することで、任意の診断タスクを開始でき `Get-HgsTrace` ます。  このコマンドは、実行時に提供されるスイッチに基づいて、トレースコレクションと診断の2つの異なる関数を実行します。  これら2つの組み合わせによって、保護されたファブリック診断ツールの全体が構成されます。  明示的に必須ではありませんが、最も有用な診断では、トレースターゲットで管理者の資格情報を使用してのみ収集できるトレースが必要です。  トレースコレクションを実行しているユーザーが十分な特権を持っていない場合、昇格が必要なトレースは失敗し、他のトレースは成功します。  これにより、権限の低いオペレーターがトリアージを実行しているときに、部分的な診断を行うことができます。

### <a name="trace-collection"></a>トレースコレクション

既定で `Get-HgsTrace` は、はトレースを収集し、一時フォルダーに保存します。  トレースは、ターゲットホストの後に指定されたフォルダーの形式になり、ホストの構成方法を説明する特殊な形式のファイルが格納されます。  トレースには、トレースを収集するために診断がどのように呼び出されたかを説明するメタデータも含まれています。  このデータは、手動診断の実行時にホストに関する情報を復元するために診断によって使用されます。

必要に応じて、トレースを手動で確認できます。  すべての形式は人間が判読できる (XML) か、標準ツール (X509 証明書や Windows Crypto シェル拡張機能など) を使用して簡単に検査することができます。  ただし、トレースは手動で診断するように設計されていないので、の診断機能を使用してトレースを処理する方が常に効果的です `Get-HgsTrace` 。

実行中のトレースコレクションの結果は、特定のホストの正常性を示すものではありません。  これは、トレースが正常に収集されたことを示しているだけです。  の診断機能を使用して `Get-HgsTrace` 、トレースが失敗した環境を示しているかどうかを判断する必要があります。

パラメーターを使用する `-Diagnostic` と、指定した診断を操作するために必要なトレースのみをトレースコレクションに限定できます。  これにより、収集されるデータの量だけでなく、診断を呼び出すために必要なアクセス許可も減少します。

### <a name="diagnosis"></a>診断

収集されたトレースを診断するには、 `Get-HgsTrace` パラメーターを使用してトレースの場所を指定 `-Path` し、スイッチを指定し `-RunDiagnostics` ます。  また、は、 `Get-HgsTrace` `-RunDiagnostics` スイッチとトレースターゲットの一覧を提供することによって、コレクションと診断を1回のパスで実行できます。  トレースターゲットが指定されていない場合は、現在のコンピューターが暗黙的なターゲットとして使用され、インストールされている Windows PowerShell モジュールを調べることによってその役割が推論されます。

診断では、特定のエラーの原因となっているトレースターゲット、診断セット、および個々の診断を示す階層形式で結果が得られます。  エラーには、次に実行するアクションを決定する際に、修復と解決策に関する推奨事項が含まれます。  既定では、渡された結果と無関係の結果は非表示になります。  診断によってテストされたすべてを表示するには、スイッチを指定し `-Detailed` ます。  これにより、状態に関係なくすべての結果が表示されます。

パラメーターを使用して実行される診断のセットを制限することができ `-Diagnostic` ます。  これにより、トレースターゲットに対して実行する診断のクラスを指定し、他のすべての診断を抑制することができます。  使用可能な診断クラスの例としては、ネットワーク、ベストプラクティス、クライアントハードウェアなどがあります。  使用可能な診断の最新の一覧については、[コマンドレットのドキュメント](https://technet.microsoft.com/library/mt718831.aspx)を参照してください。

> [!WARNING]
> 診断は、強力な監視とインシデント対応のパイプラインに代わるものではありません。  保護されたファブリックの監視に使用できる System Center Operations Manager パッケージと、問題を早期に検出するために監視できるさまざまなイベントログチャネルがあります。  診断を使用して、これらの障害を迅速にトリアージし、一連の措置を取ることができます。

## <a name="targeting-diagnostics"></a>診断のターゲット設定

`Get-HgsTrace`トレースターゲットに対して動作します。  トレースターゲットは、保護されたファブリック内の HGS ノードまたは保護されたホストに対応するオブジェクトです。  これは、 `PSSession` ファブリック内のホストの役割などの診断でのみ必要な情報を含む、の拡張機能と考えることができます。  ターゲットは、暗黙的に生成する (ローカル診断や手動診断など) ことも、コマンドを使用して明示的に生成することもでき `New-HgsTraceTarget` ます。

### <a name="local-diagnosis"></a>ローカル診断

既定で `Get-HgsTrace` は、は localhost (つまり、コマンドレットが呼び出されている場所) を対象とします。  これは、暗黙的なローカルターゲットと呼ばれます。  暗黙的なローカルターゲットは、パラメーターでターゲットが指定されておらず `-Target` 、に既存のトレースが見つからない場合にのみ使用され `-Path` ます。

暗黙のローカルターゲットは、ロールの推論を使用して、保護されたファブリックで現在のホストがどのロールを果たしているかを判断します。  これは、インストールされている Windows PowerShell モジュールに基づいています。このモジュールは、システムにインストールされている機能にほぼ対応しています。  モジュールが存在 `HgsServer` すると、トレースターゲットがロールを取得し、 `HostGuardianService` モジュールの存在によって `HgsClient` トレースターゲットがロールを取得し `GuardedHost` ます。  特定のホストで両方のモジュールを使用することができますが、その場合、との両方として扱われ `HostGuardianService` `GuardedHost` ます。

したがって、ローカルでトレースを収集するための診断の既定の呼び出しは次のとおりです。

```PowerShell
Get-HgsTrace
```

...は、次の場合と同じです。

```PowerShell
New-HgsTraceTarget -Local | Get-HgsTrace
```

> [!TIP]
> `Get-HgsTrace`は、パイプライン経由で、またはパラメーターを使用して直接、ターゲットを受け入れることができ `-Target` ます。  2つの運用の間に違いはありません。

### <a name="remote-diagnosis-using-trace-targets"></a>トレースターゲットを使用したリモート診断

リモート接続情報を使用してトレースターゲットを生成することで、ホストをリモートで診断することができます。  必要なのは、ホスト名と、Windows PowerShell リモート処理を使用して接続できる資格情報のセットだけです。
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $server
```
この例では、リモートユーザーの資格情報を収集するためのプロンプトが生成されます。その後、のリモートホストを使用して診断が実行され、 `hgs-01.secure.contoso.com` トレースコレクションが完了します。  結果のトレースは localhost にダウンロードされ、診断されます。  診断の結果は、[ローカル診断](#local-diagnosis)を実行する場合と同じように表示されます。  同様に、役割は、リモートシステムにインストールされている Windows PowerShell モジュールに基づいて推論できるため、指定する必要はありません。

リモート診断では、リモートホストへのすべてのアクセスに Windows PowerShell リモート処理を利用します。  そのため、トレースターゲットで Windows PowerShell リモート処理が有効に[なっている](/powershell/module/microsoft.powershell.core/enable-psremoting?view=powershell-7)ことと、ターゲットへの接続を開始するために localhost が適切に構成されていることが前提条件となります。

> [!NOTE]
> ほとんどの場合、localhost は同じ Active Directory フォレストの一部であり、有効な DNS ホスト名が使用されている必要があります。  環境でより複雑なフェデレーションモデルを使用している場合、または接続に直接 IP アドレスを使用する場合は、WinRM の[信頼さ](/previous-versions/technet-magazine/ff700227(v=msdn.10))れたホストの設定など、追加の構成を実行することが必要になる場合があります。

コマンドレットを使用して、トレースターゲットが適切にインスタンス化され、接続を受け入れるように構成されていることを確認でき `Test-HgsTraceTarget` ます。
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
$server | Test-HgsTraceTarget
```
このコマンドは、が `$True` `Get-HgsTrace` トレースターゲットとのリモート診断セッションを確立できる場合にのみを返します。  エラーが発生すると、このコマンドレットは、Windows PowerShell リモート処理接続のトラブルシューティングに関連する状態情報を返します。

#### <a name="implicit-credentials"></a>暗黙的な資格情報

トレースターゲットにリモート接続するための十分な特権を持つユーザーからリモート診断を実行する場合、資格情報をに指定する必要はありません `New-HgsTraceTarget` 。  コマンドレットで `Get-HgsTrace` は、接続を開くときに、コマンドレットを呼び出したユーザーの資格情報が自動的に再利用されます。

> [!WARNING]
> 特に "2 番目のホップ" と呼ばれるものを実行する場合、資格情報の再利用にはいくつかの制限が適用されます。  このエラーは、リモートセッション内から別のコンピューターに資格情報を再利用しようとした場合に発生します。  このシナリオをサポートするには[CredSSP をセットアップ](/powershell/module/microsoft.wsman.management/enable-wsmancredssp?view=powershell-7)する必要がありますが、これは、保護されたファブリック管理とトラブルシューティングの範囲外です。

#### <a name="using-windows-powershell-just-enough-administration-jea-and-diagnostics"></a>Windows PowerShell を使用するだけで十分な管理 (JEA) と診断

リモート診断は、JEA によって制約された Windows PowerShell エンドポイントの使用をサポートしています。 既定では、リモートトレースターゲットは既定のエンドポイントを使用して接続し `microsoft.powershell` ます。  トレースターゲットにロールがある場合は `HostGuardianService` 、HGS のインストール時に構成されたエンドポイントも使用され `microsoft.windows.hgs` ます。

カスタムエンドポイントを使用する場合は、次のように、パラメーターを使用してトレースターゲットを構築するときに、セッション構成名を指定する必要があり `-PSSessionConfigurationName` ます。

```PowerShell
New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential) -PSSessionConfigurationName "microsoft.windows.hgs"
```

#### <a name="diagnosing-multiple-hosts"></a>複数のホストの診断

複数のトレースターゲットを同時に渡すことができ `Get-HgsTrace` ます。  これには、ローカルとリモートの両方のターゲットが含まれます。  各ターゲットは順番にトレースされ、その後、すべてのターゲットからのトレースが同時に診断されます。  診断ツールでは、デプロイに関する知識が高まっているため、複雑なクロスノードの誤りを特定できますが、それ以外は検出できません。  この機能を使用するには、複数のホストからのトレースを同時に提供する (手動診断の場合) か、を呼び出すときに複数のホストを対象にする `Get-HgsTrace` (リモート診断の場合) 必要があります。

次に、リモート診断を使用して、2つの HGS ノードと2つの保護されたホストで構成されるファブリックをトリアージする例を示します。この場合、保護されたホストの1つが起動に使用され `Get-HgsTrace` ます。

```PowerShell
$hgs01 = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Credential (Enter-Credential)
$hgs02 = New-HgsTraceTarget -HostName "hgs-02.secure.contoso.com" -Credential (Enter-Credential)
$gh01 = New-HgsTraceTarget -Local
$gh02 = New-HgsTraceTarget -HostName "guardedhost-02.contoso.com"
Get-HgsTrace -Target $hgs01,$hgs02,$gh01,$gh02 -RunDiagnostics
```

> [!NOTE]
> 複数のノードを診断するときに、保護されたファブリック全体を診断する必要はありません。  多くの場合、特定のエラー条件に関係する可能性があるすべてのノードを含めるだけで十分です。  これは通常、保護されたホストのサブセットであり、HGS クラスターからいくつかのノードになります。

## <a name="manual-diagnosis-using-saved-traces"></a>保存されたトレースを使用した手動診断

場合によっては、再度トレースを収集せずに診断を再実行するか、ファブリック内のすべてのホストを同時にリモートで診断するために必要な資格情報を持っていないことがあります。  手動診断は、を使用してファブリック全体のトリアージを実行できます `Get-HgsTrace` が、リモートトレースコレクションを使用することはできません。

手動診断を実行する前に、トリアージされるファブリック内の各ホストの管理者が、ユーザーに代わってコマンドを実行する準備ができていることを確認する必要があります。  診断トレース出力では、一般に機密として表示される情報は公開されませんが、この情報を他のユーザーに公開するのが安全かどうかを判断するためにユーザーに課せられます。

> [!NOTE]
> トレースは匿名化ではなく、ネットワーク構成、PKI 設定、およびその他の構成 (プライベート情報と見なされることもあります) を明らかにします。  そのため、トレースは組織内の信頼されたエンティティにのみ送信され、公開されることはありません。

手動診断を実行する手順は次のとおりです。

1. 各ホスト管理者に対して、 `Get-HgsTrace` `-Path` 結果として生成されるトレースに対して実行する診断の既知の一覧と、そのリストを指定して実行するよう要求します。  例:

   ```PowerShell
   Get-HgsTrace -Path C:\Traces -Diagnostic Networking,BestPractices
   ```

2. 各ホスト管理者に対して、結果として得られるトレースフォルダーをパッケージ化し、送信するように要求します。  このプロセスは、電子メール、ファイル共有、または組織によって確立されたオペレーティングポリシーと手順に基づくその他のメカニズムによって促進できます。

3. 受信したすべてのトレースを1つのフォルダーにマージします。他のコンテンツやフォルダーは含まれません。

    * たとえば、管理者が、HGS-01、HGS-02、RR1N2608、および RR1N2608 という名前の4台のコンピューターから収集されたトレースを送信したとします。  各管理者には、同じ名前でフォルダーが送信されています。  次のようなディレクトリ構造をアセンブルします。

      ```
      FabricTraces
      |- HGS-01
      |  |- TargetMetadata.xml
      |  |- Metadata.xml
      |  |- [any other trace files for this host]
      |- HGS-02
      |  |- [...]
      |- RR1N2608-12
      |  |- [...]
      |- RR1N2608-13
         |- [..]
      ```

4. 診断を実行します。パラメーターでアセンブルされたトレースフォルダーへのパスを `-Path` 指定し、 `-RunDiagnostics` スイッチと、トレースの収集を管理者に依頼した診断を指定します。  診断では、パス内に存在するホストにアクセスできないと見なし、事前に収集されたトレースのみを使用しようとします。  トレースが見つからないか破損している場合、診断は影響を受けるテストのみを失敗として正常に続行します。  例:

   ```PowerShell
   Get-HgsTrace -RunDiagnostics -Diagnostic Networking,BestPractices -Path ".\FabricTraces"
   ```

### <a name="mixing-saved-traces-with-additional-targets"></a>保存されたトレースと追加のターゲットの混合

場合によっては、追加のホストトレースによって拡張する、事前に収集された一連のトレースが必要になることがあります。  診断の1回の呼び出しでトレースおよび診断される追加のターゲットと共に、事前に収集されたトレースを混在させることができます。

上記で指定したトレースフォルダーを収集してアセンブルする手順に従うと、事前に収集された `Get-HgsTrace` トレースフォルダーには追加のトレースターゲットがありません。

```PowerShell
$hgs03 = New-HgsTraceTarget -HostName "hgs-03.secure.contoso.com" -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $hgs03 -Path .\FabricTraces
```

診断コマンドレットは、事前に収集されたすべてのホストと、トレースする必要がある追加のホストを特定し、必要なトレースを実行します。  事前に収集されたすべてのトレースと新しく収集されたトレースの合計が診断されます。  結果のトレースフォルダーには、古いトレースと新しいトレースの両方が含まれます。

## <a name="known-issues"></a>既知の問題

保護されたファブリック診断モジュールには、Windows Server 2019 または Windows 10、バージョン1809、およびそれ以降のバージョンの OS で実行される場合の既知の制限があります。
次の機能を使用すると、誤った結果が発生する可能性があります。

* ホストキーの構成証明
* 構成証明のみの HGS 構成 (SQL Server Always Encrypted シナリオ用)
* 構成証明ポリシーの既定値が v2 である HGS サーバーで v1 ポリシーアーティファクトを使用する

`Get-HgsTrace`これらの機能を使用するときののエラーは、必ずしも HGS サーバーまたは保護されたホストの構成が正しくないことを示しているわけではありません。
保護されたホストのような他の診断ツールを使用し `Get-HgsClientConfiguration` て、ホストが構成証明を受けたかどうかをテストします。