---
title: DNS サーバーのトラブルシューティング
description: この記事では、サーバー側からの DNS の問題をトラブルシューティングする方法について説明します。
manager: willchen
ms.prod: ''
ms.technology: networking-dns
ms.topic: article
ms.author: delhan
ms.date: 8/8/2019
author: Deland-Han
ms.openlocfilehash: b0547436cfa0f07ba9cbc4e3dd1825f8d33bc093
ms.sourcegitcommit: 0e3c2473a54f915d35687d30d1b4b1ac2bae4068
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/09/2019
ms.locfileid: "68917769"
---
# <a name="troubleshooting-dns-servers"></a>DNS サーバーのトラブルシューティング

この記事では、DNS サーバーの問題をトラブルシューティングする方法について説明します。

## <a name="check-ip-configuration"></a>IP 構成の確認

1. コマンド`ipconfig /all`プロンプトでを実行し、IP アドレス、サブネットマスク、およびデフォルトゲートウェイを確認します。

2. DNS サーバーが参照されている名前に対して権限を持っているかどうかを確認します。 その場合は、「[権限のあるデータに関する問題のチェック](#checking-for-problems-with-authoritative-data)」を参照してください。

3. 次のコマンドを実行します。

   ```cmd
   nslookup <name> <IP address of the DNS server>
   ```
   以下に例を示します。 
   ```cmd
   nslookup app1 10.0.0.1
   ```
   失敗またはタイムアウトの応答が返された場合は、「[再帰の問題の確認](#checking-for-recursion-problems)」を参照してください。

4. リゾルバーキャッシュをフラッシュします。 これを行うには、管理コマンドプロンプトウィンドウで次のコマンドを実行します。

   ```cmd
   dnscmd /clearcache
   ```
   または、管理用 PowerShell ウィンドウで、次のコマンドレットを実行します。
   ```powershell
   Clear-DnsServerCache
   ```

5. 手順 3. を繰り返します。 

## <a name="check-dns-server-problems"></a>DNS サーバーの問題を確認する

### <a name="event-log"></a>イベント ログ

記録されたエラーがあるかどうかを確認するには、次のログを確認します。

- アプリケーション

- System

- DNS サーバー

### <a name="test-by-using-nslookup-query"></a>Nslookup クエリを使用したテスト

次のコマンドを実行し、クライアントコンピューターから DNS サーバーに到達できるかどうかを確認します。

```cmd
nslookup <client name> <server IP address>
```

- リゾルバーがクライアントの IP アドレスを返した場合、サーバーに問題はありません。

- 競合回避モジュールが "サーバーエラー" または "クエリ拒否" 応答を返した場合、ゾーンが一時停止されているか、サーバーが過負荷になっている可能性があります。 一時停止されているかどうかを調べるには、DNS コンソールでゾーンのプロパティの [全般] タブを確認します。

競合回避モジュールが "サーバーがタイムアウトしました" または "サーバーからの応答がありません" という応答を返す場合、DNS サービスが実行されていないことがあります。 サーバーのコマンドプロンプトで次のように入力して、DNS サーバーサービスの再起動を試みます。

```cmd
net start DNS
```

サービスの実行中に問題が発生した場合は、nslookup クエリで使用した IP アドレスでサーバーがリッスンしていない可能性があります。 DNS コンソールの [サーバーのプロパティ] ページの [**インターフェイス**] タブでは、管理者は、選択したアドレスのみをリッスンするように dns サーバーを制限できます。 DNS サーバーが、構成済みの IP アドレスの特定のリストにサービスを制限するように構成されている場合、DNS サーバーへの接続に使用される IP アドレスが一覧に含まれていない可能性があります。 一覧で別の IP アドレスを試すことも、IP アドレスを一覧に追加することもできます。

まれに、DNS サーバーに高度なセキュリティやファイアウォールの構成が含まれている場合があります。 中間ホスト (パケットフィルタールーターやプロキシサーバーなど) を介してのみ到達可能な別のネットワーク上にサーバーが配置されている場合、DNS サーバーはクライアント要求をリッスンして受信するために標準以外のポートを使用することがあります。 既定では、nslookup は UDP ポート53の DNS サーバーにクエリを送信します。 そのため、DNS サーバーが他のポートを使用している場合、nslookup クエリは失敗します。 これが問題であると思われる場合は、中間フィルターが既知の DNS ポートでのトラフィックをブロックするために意図的に使用されているかどうかを確認します。 そうでない場合は、UDP/TCP ポート53のトラフィックを許可するように、ファイアウォールのパケットフィルターまたはポートルールを変更してみてください。

## <a name="checking-for-problems-with-authoritative-data"></a>権限のあるデータに関する問題を確認しています

正しくない応答を返すサーバーが、ゾーンのプライマリサーバー (ゾーンの標準のプライマリサーバー、または Active Directory 統合を使用してゾーンを読み込むサーバー) であるか、またはゾーンのセカンダリコピーをホストしているサーバーであるかを確認します。 

### <a name="if-the-server-is-a-primary-server"></a>サーバーがプライマリサーバーの場合

ユーザーがゾーンにデータを入力すると、問題が発生している可能性があります。 または、Active Directory レプリケーションまたは動的更新に影響する問題が原因である可能性があります。

### <a name="if-the-server-is-hosting-a-secondary-copy-of-the-zone"></a>サーバーがゾーンのセカンダリコピーをホストしている場合

1. マスターサーバー (このサーバーがゾーン転送をプルするサーバー) 上のゾーンを確認します。

   > [!NOTE]
   >DNS コンソールでセカンダリゾーンのプロパティを調べることによって、どのサーバーがマスタサーバーであるかを確認できます。

   マスターサーバーの名前が正しくない場合は、手順4に進みます。

2. マスターサーバーの名前が正しい場合は、マスターサーバーのシリアル番号がセカンダリサーバーのシリアル番号以下であるかどうかを確認します。 表示されている場合は、マスターサーバーまたはセカンダリサーバーのいずれかを変更して、マスターサーバーのシリアル番号がセカンダリサーバーのシリアル番号よりも大きいようにします。 
  
3. セカンダリサーバーで、DNS コンソール内から、または次のコマンドを実行して、ゾーンを強制的に転送します。
  
   ```cmd
   dnscmd /zonerefresh <zone name>
   ```
  
   たとえば、ゾーンが corp.contoso.com の場合は、「」 `dnscmd /zonerefresh corp.contoso.com`と入力します。
  
4. セカンダリサーバーをもう一度調べて、ゾーンが正しく転送されたかどうかを確認します。 それ以外の場合は、ゾーン転送の問題が発生している可能性があります。 詳細については、「[ゾーン転送に関する問題](#zone-transfer-problems)」を参照してください。

5. ゾーンが正しく転送された場合は、データが正しいかどうかを確認します。 それ以外の場合、データはプライマリゾーンでは正しくありません。 ユーザーがゾーンにデータを入力すると、問題が発生している可能性があります。 または、Active Directory レプリケーションまたは動的更新に影響する問題が原因である可能性があります。

## <a name="checking-for-recursion-problems"></a>再帰の問題を確認しています

再帰が正常に機能するには、再帰クエリのパスで使用されているすべての DNS サーバーが、適切なデータに応答して転送できる必要があります。 できない場合は、次のいずれかの理由で再帰クエリが失敗する可能性があります。

- クエリは、完了する前にタイムアウトになります。

- クエリ中に使用されたサーバーが応答しません。

- クエリ中に使用されるサーバーでは、正しくないデータが提供されます。

元のクエリで使用されていたサーバーでトラブルシューティングを開始します。 DNS コンソールでサーバーのプロパティの [**フォワーダー** ] タブを調べて、このサーバーが別のサーバーにクエリを転送するかどうかを確認します。 [**フォワーダーを有効にする**] チェックボックスがオンになっていて、1つまたは複数のサーバーが一覧表示されている場合、このサーバーはクエリを転送します。

このサーバーがクエリを別のサーバーに転送する場合は、このサーバーがクエリを転送するサーバーに影響する問題がないかどうかを確認します。 問題を確認するには、「 [DNS サーバーの問題を確認](#check-dns-server-problems)する」を参照してください。 このセクションでクライアントでタスクを実行するように指示された場合は、代わりにサーバーで実行してください。

サーバーが正常で、クエリを転送できる場合は、この手順を繰り返し、このサーバーがクエリを転送するサーバーを確認します。

このサーバーがクエリを別のサーバーに転送しない場合は、このサーバーがルートサーバーを照会できるかどうかをテストします。 これを行うには、次のコマンドを実行します。

```cmd
nslookup
server <IP address of server being examined>
set q=NS
 ```

- 競合回避モジュールがルートサーバーの IP アドレスを返した場合、ルートサーバーと解決しようとしている名前または IP アドレスとの間の委任が壊れている可能性があります。 「[壊れた委任のテスト](#test-a-broken-delegation)」の手順に従って、委任が解除されている場所を確認します。

- リゾルバーが "サーバータイムアウトに要求しました" という応答を返す場合は、ルートヒントが機能しているルートサーバーを指しているかどうかを確認します。 これを行うには、を使用して、[現在のルートヒントの](#to-view-the-current-root-hints)手順を表示します。 ルートヒントが機能しているルートサーバーを指している場合、ネットワークの問題が発生している可能性があります。または、「 [DNS サーバーの問題の確認](#check-dns-server-problems)」セクションで説明されているように、競合回避モジュールがサーバーを照会できないようにするための高度なファイアウォール構成を使用している可能性があります 再帰タイムアウトの既定値が短すぎる可能性もあります。

### <a name="test-a-broken-delegation"></a>壊れた委任をテストする

有効なルートサーバーに対してクエリを実行し、次の手順でテストを開始します。 このテストでは、ルートからすべての DNS サーバーに対してクエリを実行し、問題のある委任をテストしているサーバーに照会するプロセスを実行します。

1. テストするサーバーのコマンドプロンプトで、次のように入力します。

   ```cmd
   nslookup
   server <server IP address>
   set norecursion
   set querytype= <resource record type>
   <FQDN>
   ```
   > [!NOTE]
   >[リソースレコードの種類] は、元のクエリでクエリを実行していたリソースレコードの種類です。 FQDN は、(ピリオドで終了した) クエリを実行した FQDN です。
 
2. 委任されたサーバーの "NS" リソースレコードと "A" リソースレコードの一覧が応答に含まれる場合は、各サーバーに対して手順 1. を繰り返し、"A" リソースレコードの IP アドレスをサーバーの IP アドレスとして使用します。

   - 応答に "NS" リソースレコードが含まれていない場合、委任は解除されます。
   
   - 応答に "NS" リソースレコードが含まれていても、"A" リソースレコードがない場合は、"NS" レコードに一覧表示されているサーバーの "A" リソースレコードに対して、[**再帰の設定**] と [クエリ] を個別に入力します。 ゾーン内の各 NS リソースレコードについて、"A" リソースレコードの有効な IP アドレスが少なくとも1つ見つからない場合は、委任が解除されます。

3. 委任が壊れていると判断した場合は、委任されたゾーンの正しい DNS サーバーの有効な IP アドレスを使用して、親ゾーンの "A" リソースレコードを追加または更新することで修正します。

### <a name="to-view-the-current-root-hints"></a>現在のルートヒントを表示するには

1. DNS コンソールを起動します。

2. 再帰クエリに失敗した DNS サーバーを追加または接続します。

3. サーバーを右クリックし、[**プロパティ**] を選択します。

4. [ルートヒント] をクリックします。

ルートサーバーへの基本的な接続を確認します。

- ルートヒントが正しく構成されていると思われる場合は、失敗した名前解決で使用されている DNS サーバーが、ルートサーバーに IP アドレスで ping を実行できることを確認します。

- ルートサーバーが IP アドレスによる ping に応答しない場合は、ルートサーバーの IP アドレスが変更されている可能性があります。 ただし、ルートサーバーの再構成を確認することは珍しくありません。

## <a name="zone-transfer-problems"></a>ゾーン転送の問題

次のチェックを実行します。

- プライマリとセカンダリの両方の DNS サーバーのイベントビューアーを確認します。

- マスターサーバーで、セキュリティのために転送の送信が拒否されているかどうかを確認します。 

- DNS コンソールで、ゾーンのプロパティの [**ゾーンの転送**] タブを確認します。 ゾーンのプロパティの [**ネームサーバー** ] タブに一覧表示されているサーバーなど、サーバーの一覧にゾーン転送を制限する場合は、その一覧にセカンダリサーバーがあることを確認します。 サーバーがゾーン転送を送信するように構成されていることを確認します。

- マスタサーバーの問題を確認するには、「 [DNS サーバーの問題の確認](#check-dns-server-problems)」セクションの手順に従ってください。 クライアントでタスクを実行するように求めるメッセージが表示されたら、代わりにセカンダリサーバーでタスクを実行します。

- セカンダリサーバーで、BIND などの別の DNS サーバー実装が実行されているかどうかを確認します。 この問題が発生している場合は、次のいずれかの原因が考えられます。

  - 高速ゾーン転送を送信するように Windows マスターサーバーが構成されている可能性がありますが、サードパーティ製のセカンダリサーバーでは、高速ゾーン転送がサポートされていない可能性があります。 このような場合は、サーバーのプロパティの [**詳細設定**] タブにある [**セカンダリのバインドを有効**にする] チェックボックスをオンにして、DNS コンソール内からマスターサーバーの高速ゾーン転送を無効にします。

  - Windows サーバーの前方参照ゾーンに、セカンダリサーバーがサポートしていないレコードの種類 (SRV レコードなど) が含まれている場合、セカンダリサーバーでゾーンのプルに問題が発生する可能性があります。

マスターサーバーで、BIND などの別の DNS サーバー実装が実行されているかどうかを確認します。 その場合は、マスターサーバー上のゾーンに、Windows が認識しない互換性のあるリソースレコードが含まれている可能性があります。
 
マスターサーバーまたはセカンダリサーバーで別の DNS サーバー実装が実行されている場合は、両方のサーバーで同じ機能がサポートされていることを確認してください。 サーバーの [プロパティ] ページの [**詳細設定**] タブで、DNS コンソールで Windows server を確認できます。 [バインドセカンダリを有効にする] ボックスに加えて、このページには [**名前の確認**] ドロップダウンリストが表示されます。 これにより、DNS 名の文字に対する厳格な RFC 準拠の適用を選択できます。

