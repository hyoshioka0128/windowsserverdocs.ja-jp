---
ms.assetid: 606df285-259c-4c6b-8583-9aca1d614c43
title: 要求のパススルーとフィルターを使用するタイミングの規則
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: d41a255d38cae1144d73b70b8dc433c222911b96
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2020
ms.locfileid: "86958594"
---
# <a name="when-to-use-a-pass-through-or-filter-claim-rule"></a>要求のパススルーとフィルターを使用するタイミングの規則
この規則は、特定の入力 \( \) 方向の要求の種類を取得して、入力方向の要求の値に基づいてどのような出力を行うかを決定するアクションを適用する必要がある場合に Active Directory フェデレーションサービス (AD FS) AD FS で使用できます。 この規則を使用する場合、次の表の規則ロジックと一致する要求を、規則で構成するオプションに基づいてパススルーまたはフィルター処理します。  
  
|規則のオプション|規則のロジック|  
|---------------|--------------|  
|すべての要求値をパススルーする|入力方向の要求の種類が "指定した要求の種類"** に等しく、値が "すべての値"** に等しい場合、要求をパススルーします|  
|特定の要求値のみをパススルーする|入力方向の要求の種類が "指定した要求の種類"** に等しく、値が "指定した要求値"** に等しい場合、要求をパススルーします|  
|特定の電子メールサフィックスの値に一致する要求値のみをパススルーする \-|入力方向の要求の種類が "指定した要求の種類"** に等しく、値が "指定したサフィックス値"** に等しい場合、要求をパススルーします|  
|特定の値で始まる要求値のみをパススルーする|入力方向の要求の種類が "指定した要求の種類"** に等しく、値が "指定した要求値"** で始まる場合、要求をパススルーします|  
  
次のセクションでは、要求規則の概要と、その規則を使用するタイミングについて詳しく説明します。  
  
## <a name="about-claim-rules"></a>要求規則について  
要求規則は、入力方向の要求を受け取り、x が y の場合に条件を適用して、 \( \) 条件パラメーターに基づいて出力方向の要求を生成するビジネスロジックのインスタンスを表します。 次の一覧に、このトピックを読む前に理解しておく必要のある、要求規則に関する重要なヒントを示します。  
  
-   AD FS 管理スナップインでは \- 、要求規則テンプレートを使用してのみ要求規則を作成できます。  
  
-   要求規則は、フェデレーションサービス Active Directory などの要求プロバイダーから直接、 \( \) または要求プロバイダー信頼の受け入れ変換規則の出力から、入力方向の要求を処理します。  
  
-   要求規則は、要求発行エンジンによって、特定の規則セット内で時系列に従って処理されます。 規則に優先順位を設定すると、特定の規則セット内の先行する規則で生成された要求をさらに調整またはフィルター処理できます。  
  
-   要求規則テンプレートでは、常に入力方向の要求の種類を指定する必要があります。 ただし、1 つの規則を使用して、要求の種類が同じ複数の要求の値を処理できます。  
  
要求規則と要求規則セットの詳細については、「[要求規則の役割](The-Role-of-Claim-Rules.md)」を参照してください。 規則の処理方法の詳細については、「[要求エンジンの役割](The-Role-of-the-Claims-Engine.md)」を参照してください。 要求規則セットの処理方法の詳細については、「[要求パイプラインの役割](The-Role-of-the-Claims-Pipeline.md)」を参照してください。  
  
## <a name="pass-through-all-claim-values"></a>すべての要求値をパススルーする  
この操作を使用する場合、指定した要求の種類の入力方向の要求値すべてが、出力方向の要求としてパススルーされます。 たとえば、入力方向の要求の種類が "役割" として指定されている場合は、すべての入力方向の要求値が、新しい出力方向の要求に個別にコピーされ、出力方向の要求の種類は "役割" になります。  
  
## <a name="filtering-a-claim"></a>要求のフィルター処理  
AD FS では、*要求フィルター*とは、特定の値のみが出力方向の要求として渡され、送信されるように、入力方向の要求の値をフィルター処理または制限することを意味します。 これを実現するのが、**入力方向の要求のパススルーまたはフィルター処理**規則です。 この規則のプロパティ内で、指定した条件を満たす値のみがパススルーするように、入力方向の値をフィルター処理する条件を設定できます。  
  
たとえば、この規則を使用すると、入力方向の要求の種類が "役割" と一致するとき、またはユーザー名に関する要求のみを発行する必要があるときに、購入者の要求値に一致する要求のみをパススルーできますが、ユーザーの社会保障番号を含む要求はパススルーできません。  
  
この規則でフィルター条件を使用すると、入力方向のすべての要求で、どの要求が規則で設定された条件に一致するかが確認されます。 その他の要求はすべて無視され、指定した要求値の中で、選択した要求の種類に一致するものだけがパススルーします。  
  
たとえば、次の図に示すように、という条件で規則が設定されている場合に、UPN 要求の種類にキーが付けられている入力方向の要求のみをフィルター処理すると、 @fabrikam.com その他のすべての入力方向の要求は、この条件を満たしていない限り無視されます。 これには、 \- 要求の値がで終わる場合でも、要求の種類が電子メールアドレスの入力方向の要求が含まれ @fabrikam.com ます。 この場合、の値を含むクレームのみ Nick@fabrikam.com が証明書利用者に送信されます。  
  
![パススルーを使用する場合](media/adfs2_filter.gif)  
  
## <a name="configuring-this-rule-on-a-claims-provider-trust"></a>要求プロバイダー信頼でのこの規則の構成  
要求プロバイダー信頼を使用する場合、この規則は、特定の制約に一致する要求プロバイダーからの入力方向の要求のみをパススルーするように構成できます。 たとえば、要求プロバイダーからの電子メール要求のみを受け入れるようにすることができます \- 。したがって、この規則テンプレートを使用して、 \- 要求プロバイダーのドメインネームシステム DNS 名で終わる電子メール要求の種類を受け入れることができ \( \) ます。  
  
## <a name="configuring-this-rule-on-a-relying-party-trust"></a>証明書利用者の信頼でのこの規則の構成  
証明書利用者の信頼を使用すると、この規則は、証明書利用者に送信される出力方向の要求をパススルーまたはフィルター処理するように構成できます。 要求の種類すべてを、すべての証明書利用者が認識できるとは限りません。また、要求によっては、特定の証明書利用者に送信しないようにする必要がある機密情報が含まれる場合もあります。 この規則テンプレートは、特定の証明書利用者の信頼に対して、こうしたポリシーを適用するのに役立ちます。  
  
## <a name="how-to-create-this-rule"></a>この規則の作成方法  
この規則を作成するには、要求規則言語を使用するか、AD FS 管理スナップインで "入力方向の要求をパススルーまたはフィルター処理" 規則テンプレートを使用し \- ます。 この規則テンプレートには、次の構成オプションがあります。  
  
-   要求規則名を指定する  
  
-   入力方向の要求の種類を指定する  
  
-   すべての要求値をパススルーする  
  
-   特定の要求値のみをパススルーする  
  
-   特定の電子メールサフィックスの値に一致する要求値のみをパススルーする \-  
  
-   特定の値で始まる要求値のみをパススルーする  
  
このテンプレートを作成する方法の詳細については、「AD FS 展開ガイド」の「[入力方向の要求をパススルーまたはフィルター処理する規則を作成](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807060(v=ws.11))する」を参照してください。  
  
## <a name="using-the-claim-rule-language"></a>要求規則言語の使用  
要求値がカスタム パターンに一致する場合にのみ要求を送信する場合は、カスタム規則を使用する必要があります。 詳細については、カスタム規則を使用するタイミングに関するトピックを参照してください。  
  
### <a name="examples-of-how-to-construct-a-pass-through-or-filter-rule-syntax"></a>パススルーとフィルター処理規則の構文の作成例  
シンプルなフィルター処理規則では、上記で説明したプロパティのいずれかに基づいて要求をフィルター処理します。 たとえば、次の規則はすべての電子メール要求を通過し \- ます。  
  
```  
c:[type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"]  => issue(claim  = c);  
```  
  
フィルターは論理的にも ed でもかまい \- ません。 たとえば、次の規則では、 \- 値を含むすべての電子メール要求を受け入れます。johndoe@fabrikam.com:  
  
```  
c:[type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress", value == "johndoe@fabrikam.com "]  => issue(claim  = c);  
```  
  
前の例では、フィルターには常に等価演算子が使用されています。 要求規則言語でサポートされる演算子を次に示します。  
  
-   \=\=\- \( 大文字と小文字を \- 区別する\)  
  
-   \!\=\- \( 大文字と小文字を \- 区別しない\)  
  
-   \=~\-正規表現の一致  
  
-   \!~ \-正規表現が \- 一致しません  
  
たとえば、次の規則は、boeing.com という \- サフィックスを持つローカルフェデレーションサーバーによって発行されていないすべての電子メール要求を受け入れます。  
  
```  
c:[type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress", value =~ "^.*@boeing\.com$" , issuer != "LOCAL AUTHORITY"]  => issue(claim  = c);  
```  
  
### <a name="best-practices-for-creating-custom-rules"></a>カスタム規則を作成するためのベスト プラクティス  
次の表で説明するように、フィルターは、各要求の 1 つ以上のプロパティに適用できます。  
  

| 要求のプロパティ |                                                                                                                                                                                                                                                                                                                                                  説明                                                                                                                                                                                                                                                                                                                                                  |
|----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|      種類      |                                                                                                                                                                                        \(通常、Uri として表される要求の種類は、 \) 要求で伝達される情報の種類について、フェデレーション内のパートナー間の暗黙のアグリーメントを反映します。 たとえば、http: \/ \/schemas.xmlsoap.org \/ ws \/ 2005 \/ 05 の \/ id \/ 要求 emailaddress には、 \/ \- ユーザーの電子メールアドレスが含まれます。                                                                                                                                                                                         |
|     値      |                                                                                                                                                                                                                                                                   要求の値。 たとえば、http: \/ \/schemas.xmlsoap.org ws 2005 05 identity claim emailaddress 型のクレームは、次 \/ \/ \/ \/ \/ \/ の値を持つことができます。johndoe@fabrikam.com                                                                                                                                                                                                                                                                    |
|   ValueType    |                                                                                                                                                                                                  ValueType は、要求の値に含まれる情報がどのように解釈されるかを表します。 通常、ValueType は http: www.w3.org 2001 XMLSchema string に設定されます \/ \/ \/ \/ が、 \# 要求の値には、 \( イメージや日付、ブール値など、Base64Binary でエンコードされたデータを含めることができ \) ます。                                                                                                                                                                                                  |
|     発行者     | 発行者は、前回ユーザーに関する要求を発行したパーティです。 要求が要求プロバイダーのフェデレーションサーバーで取得された場合は、すべての要求の発行者が "LOCAL AUTHORITY" に設定されます。 フェデレーション プロバイダーのフェデレーション サーバーが要求を受信した場合、要求の発行者は、トークンに署名した要求プロバイダーの要求プロバイダー識別子に設定されます。 このため、要求プロバイダーから受信した要求の規則を処理するときは、すべての要求の発行者が同じ値に設定されます。 証明書利用者の規則を作成するとき、発行者のプロパティを使用して、別の要求プロバイダーから送信された要求を区別できます。 |
| OriginalIssuer |                                                                                                   この要求プロパティの目的は、要求を最初に発行したフェデレーション サーバーを伝達することです。 要求の issuer プロパティは、トークンに署名した最後のフェデレーションサーバーに設定されているので、元の発行者は、要求が複数のフェデレーションサーバーを経由して送信された場合に便利です。 \( たとえば、フェデレーションプロバイダーフェデレーションサーバーからトークンを受け取る証明書利用者が、特定の要求プロバイダーフェデレーションサーバーによって認証されたユーザー\)                                                                                                   |
|   Properties   |                                                                                                                             上記で説明した 5 つのプロパティのほかに、名前付きプロパティを格納できるプロパティ バッグが各要求にあります。 これらのプロパティはトークンでシリアル化されません。また、1 台のフェデレーション サーバーのスコープ内の要求発行パイプラインのコンポーネント間で情報をやり取りする場合にのみ有効です。 たとえば、要求プロバイダー規則の処理中にプロパティを設定し、証明書利用者の規則でそのプロパティを参照します。                                                                                                                              |
