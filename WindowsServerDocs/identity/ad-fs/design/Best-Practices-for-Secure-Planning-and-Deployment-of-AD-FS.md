---
ms.assetid: 963a3d37-d5f1-4153-b8d5-2537038863cb
title: AD FS のセキュリティを考慮した設計と展開のベスト プラクティス
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 55f68886bc5e782feb76b5005b15622881f42f6a
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2020
ms.locfileid: "86964464"
---
# <a name="best-practices-for-secure-planning-and-deployment-of-ad-fs"></a>AD FS のセキュリティを考慮した設計と展開のベスト プラクティス


このトピックでは、Active Directory フェデレーションサービス (AD FS) (AD FS) のデプロイを設計する際にセキュリティを計画および評価するためのベストプラクティス情報を提供します。 このトピックでは、AD FS の使用に関する全体的なセキュリティに影響を与える考慮事項を確認および評価するための開始点について説明します。 このトピックの情報は、既存のセキュリティ計画と他の設計のベスト プラクティスを補完および強化することを意図しています。  
  
## <a name="core-security-best-practices-for-ad-fs"></a>AD FS のセキュリティの主要ベスト プラクティス  
次の主要なベストプラクティスは、設計または展開のセキュリティを向上させたり拡張したりするすべての AD FS インストールに共通するものです。  

-   **"階層 0" システムとして AD FS をセキュリティで保護する** 

    AD FS は、基本的に認証システムです。  そのため、ネットワーク上の他の id システムと同様に、"階層 0" のシステムとして処理する必要があります。  Active Directory 管理層モデルの詳細については、 [Microsoft Docs](../../securing-privileged-access/securing-privileged-access-reference-material.md)を参照してください。 


-   **セキュリティの構成ウィザードを使用して AD FS 固有のセキュリティのベスト プラクティスをフェデレーション サーバーとフェデレーション サーバー プロキシ コンピューターに適用する**  
  
    セキュリティの構成ウィザード (SCW) は、すべての Windows Server 2008、Windows Server 2008 R2、および Windows Server 2012 コンピューターにプレインストールされているツールです。 このウィザードは、インストールするサーバーの役割に基づいて、サーバーが攻撃を受ける機会を削減するのに役立つセキュリティのベスト プラクティスを適用するのに使用できます。  
  
    AD FS をインストールすると、セットアップ プログラムによって役割拡張ファイルが作成されます。このファイルは、セットアップ時に選択する特定の AD FS サーバーの役割 (フェデレーション サーバーまたはフェデレーション サーバー プロキシ) に適用されるセキュリティ ポリシーを作成するために SCW で使用できます。  
  
    インストールされるそれぞれの役割拡張ファイルは、各コンピューターに構成される役割とサブ役割の種類を表します。 次の役割拡張ファイルが C:WindowsADFSScw ディレクトリにインストールされます。  
  
    -   Farm.xml  
  
    -   SQLFarm.xml  
  
    -   StandAlone.xml  
  
    -   Proxy.xml (このファイルはコンピューターをフェデレーション サーバー プロキシの役割に構成した場合にのみ存在します)  
  
    AD FS の役割の拡張を SCW で適用するには、次の手順を順番に実行してください。  
  
    1.  AD FS をインストールし、そのコンピューターに適したサーバーの役割を選択します。 詳細については、「AD FS 展開ガイド」の「[フェデレーションサービスプロキシの役割サービスのインストール](../../ad-fs/deployment/Install-the-Federation-Service-Proxy-Role-Service.md)」を参照してください。  
  
    2.  Scwcmd コマンドライン ツールを使用して適切な役割拡張ファイルを登録します。 下記の表で、コンピューターに構成される役割でこのツールを使用する方法の詳細を参照してください。  
  
    3.  WindowssecurityMsscwLogs ディレクトリにある SCWRegister_log.xml ファイルを調べて、コマンドが正常に完了したことを確認します。  
  
    AD FS ベースの SCW セキュリティ ポリシーを適用するフェデレーション サーバーまたはフェデレーション サーバー プロキシ コンピューターごとに、これらの手順をすべて実行する必要があります。  
  
    次の表では、AD FS をインストールしたコンピューターで選択する AD FS サーバーの役割に基づいて、適切な SCW の役割の拡張を登録する方法について説明します。  
  
    |AD FS サーバーの役割|使用する AD FS 構成データベース|コマンド プロンプトで入力するコマンド|  
    |---------------------|-------------------------------------|---------------------------------------------------|  
    |スタンドアロン フェデレーション サーバー|Windows Internal Database|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwStandAlone.xml"`|  
    |ファームに加わったフェデレーション サーバー|Windows Internal Database|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwFarm.xml"`|  
    |ファームに加わったフェデレーション サーバー|SQL Server|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwSQLFarm.xml"`|  
    |フェデレーション サーバー プロキシ|該当なし|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwProxy.xml"`|  
  
    AD FS に使用できるデータベースの詳細については、「[AD FS 構成データベースの役割](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md)」を参照してください。  
  
-   **キオスクを使用する場合など、セキュリティが非常に重要な懸念事項となる状況でトークン リプレイ検出を使用する**  
    トークンリプレイ検出は、フェデレーションサービスに対して行われたトークン要求の再生試行が検出され、要求が破棄されることを保証する AD FS の機能です。 トークン リプレイ検出は既定で有効になっています。 この機能は、同じトークンが複数回使用されないようにすることで、WS-Federation パッシブ プロファイルと Security Assertion Markup Language (SAML) WebSSO プロファイルの両方に対して機能します。  
  
    フェデレーション サービスが開始されると、サービスが対応するすべてのトークンの要求のキャッシュを構築し始めます。 時間と共に、キャッシュに後続のトークンの要求が追加されると、フェデレーション サービスにおいて、トークンの要求を複数回リプレイしようとする試みをより一層検出できるようになります。 トークン リプレイ検出を無効にして、後で再度有効にする場合は、リプレイ キャッシュがコンテンツを再構築するのに十分な時間が経過するまで、フェデレーション サービスは以前に使用された可能性のあるトークンを一定期間受け入れることに留意してください。 詳細については、「[AD FS 構成データベースの役割](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md)」を参照してください。  
  
-   **特にサポート対象の SAML アーティファクト解決を使用する場合に、トークンの暗号化を使用する**  
  
    トークンの暗号化は、AD FS のデプロイに対して試行される可能性がある man-in-the-middle (MITM) 攻撃に対するセキュリティと保護を強化するために強くお勧めします。 暗号化の使用はスループットに多少影響する可能性がありますが、認識されることは通常なく、多くの展開においてセキュリティの強化のメリットはサーバーのパフォーマンスの点であらゆるコストに勝ります。  
  
    トークンの暗号化を有効にするには、最初に証明書利用者信頼の暗号化証明書を設定して追加します。 暗号化証明書は、証明書利用者信頼の作成時または後で構成できます。 後で既存の証明書利用者信頼に暗号化証明書を追加するには、AD FS スナップインを使用しているときに、信頼プロパティ内の [**暗号化**] タブで使用する証明書を設定します。 AD FS コマンドレットを使用して既存の信頼の証明書を指定するには、 **ClaimsProviderTrust**コマンドレットまたは**set-relyingpartytrust**コマンドレットの encryptioncertificate パラメーターを使用します。 トークンを復号化するときに使用するフェデレーションサービスの証明書を設定するには、 **get-adfscertificate**コマンドレットを使用し、 `Token-Encryption` *certificatetype*パラメーターに "" を指定します。 特定の証明書利用者信頼に対する暗号化を有効または無効にするには、*Set-RelyingPartyTrust* コマンドレットの **EncryptClaims** パラメーターを使用します。  
  
-   **認証に対する保護の強化を活用する**  
  
    展開をセキュリティで保護するために、AD FS で認証の拡張保護機能を設定して使用することができます。 この設定では、フェデレーションサーバーでサポートされる認証の拡張保護レベルを指定します。  
  
    認証に対する保護の強化は、攻撃者がクライアントの資格情報を傍受してサーバーに転送する man-in-the-middle (MITM) 攻撃に対する保護に役立ちます。 このような攻撃に対する保護は、チャネル バインディング トークン (CBT) を使用することで可能になります。サーバーでは、クライアントと通信を確立するときに CBT を必須、許容、または不要のいずれかにできます。  
  
    保護を強化する機能を有効にするには、**ExtendedProtectionTokenCheck** パラメーターを **Set-ADFSProperties** コマンドレットで使用します。 次の表に、この設定で使用できる値と、値によって指定されるセキュリティのレベルを示します。  
  
    |パラメーター値|セキュリティ レベル|保護設定|  
    |-------------------|------------------|----------------------|  
    |必須|サーバーは完全にセキュリティで保護されます。|保護の強化が適用され常時必須です。|  
    |Allow|サーバーは部分的にセキュリティで保護されます。|保護の強化は、関係するシステムでパッチによってサポートされている場合に適用されます。|  
    |なし|サーバーは保護されていません。|保護の強化は適用されません。|  
  
-   **ログとトレースを使用する場合は、すべての機密情報のプライバシーを確保する**  
  
    AD FS は、既定では、フェデレーションサービスまたは通常の操作の一部として、個人を特定できる情報 (PII) を直接公開または追跡しません。 ただし AD FS でイベントログとデバッグトレースログが有効になっている場合、要求ポリシーによっては、一部の要求の種類とその関連値に PII が含まれている可能性があります。これは、AD FS イベントまたはトレースログに記録される可能性があります。  
  
    したがって、AD FS 構成とそのログファイルに対するアクセス制御を実施することを強くお勧めします。 このような情報を参照できないようにするには、ログを無効にするか、他のユーザーとログを共有する前にログのすべての PII や機密情報をフィルター処理する必要があります。  
  
    以下のヒントは、意図せずにログ ファイルの内容が公開されるのを防ぐのに役立ちます。  
  
    -   AD FS イベントログとトレースログファイルがアクセス制御リスト (ACL) によって保護されていることを確認します。アクセス制御リスト (ACL) は、アクセスを必要とする信頼された管理者のみにアクセスを制限します。  
  
    -   Web 要求を使用して簡単に処理できるファイル拡張子やパスを使用してログ ファイルをコピーしたりアーカイブしたりしないでください。 たとえば、ファイル名の拡張子として .xml を選択するのは安全ではありません。 インターネット インフォメーション サービス (IIS) の管理ガイドを参照して、処理できる拡張子のリストを確認します。  
  
    -   ログ ファイルのパスを変更する場合は、ログ ファイルのある場所への絶対パスを指定するようにしてください。この場所は、部外者が Web ブラウザーを使用してアクセスできないように、Web ホストの仮想ルート (vroot) パブリック ディレクトリの外部にする必要があります。  

-   **エクストラネットのソフトロックアウトと AD FS エクストラネットのスマートロックアウト保護を AD FS する**  
    
    Web アプリケーションプロキシ経由で無効な (正しくない) パスワードを使用した認証要求の形式で攻撃が発生した場合、AD FS エクストラネットロックアウトを使用すると、AD FS アカウントロックアウトからユーザーを保護することができます。 AD FS アカウントロックアウトからユーザーを保護するだけでなく、AD FS のエクストラネットロックアウトでは、ブルートフォースパスワード推測攻撃から保護することもできます。  
    
    Windows Server 2012 R2 の AD FS のエクストラネットのソフトロックアウトについては[AD FS 「エクストラネットのソフトロックアウト保護](../../ad-fs/operations/Configure-AD-FS-Extranet-Soft-Lockout-Protection.md)」を参照してください。  

     Windows Server 2016 の AD FS のエクストラネットのスマートロックアウトについては[AD FS 「エクストラネットのスマートロックアウトの保護](../../ad-fs/operations/Configure-AD-FS-Extranet-Smart-Lockout-Protection.md)」を参照してください。  
  
## <a name="sql-serverspecific-security-best-practices-for-ad-fs"></a>SQL Server 特有の AD FS のセキュリティに関するベスト プラクティス  
以下のセキュリティのベストプラクティスは、これらのデータベーステクノロジを使用して &reg; AD FS の設計と展開でデータを管理する場合に、Microsoft SQL Server または Windows Internal Database (WID) の使用に固有のものです。  
  
> [!NOTE]  
> これらの推奨事項は SQL Server 製品のセキュリティ ガイダンスを強化するためのものであって、取って代わるものではありません。 セキュリティで保護された SQL Server インストールの計画の詳細については、「[セキュリティで保護された SQL インストールのセキュリティに関する考慮事項](https://go.microsoft.com/fwlink/?LinkID=139831)」 (を参照してください https://go.microsoft.com/fwlink/?LinkID=139831) 。  
  
-   **常に SQL Server を物理的にセキュリティで保護されたネットワーク環境内のファイアウォールの背後に展開する。**  
  
    SQL Server のインストールを直接インターネットに公開しないでください。 データセンター内のコンピューターのみが、AD FS をサポートする SQL server インストールに接続できるようにする必要があります。 詳細については、「[セキュリティのベストプラクティスのチェックリスト](https://go.microsoft.com/fwlink/?LinkID=189229)」 (を参照してください https://go.microsoft.com/fwlink/?LinkID=189229) 。  
  
-   **既定のビルトイン システム サービス アカウントを使用せずに、別のサービス アカウントで SQL Server を実行する。**  
  
    SQL Server は既定で、LocalSystem や NetworkService アカウントなど、サポートされているビルトイン システム アカウントの 1 つを使用するようインストールおよび構成されることがよくあります。 AD FS の SQL Server インストールのセキュリティを強化するには、可能な限り、SQL Server サービスへのアクセスに別のサービスアカウントを使用し、Active Directory デプロイにこのアカウントのセキュリティプリンシパル名 (SPN) を登録することで Kerberos 認証を有効にします。 これによってクライアントとサーバー間で相互認証ができるようになります。 別のサービス アカウントの SPN を登録しないと、SQL Server は Windows ベースの認証で NTLM を使用するので、クライアントのみが認証されます。  
  
-   **SQL Server での外部からのアクセスを最小限にする。**  
  
    必要な SQL Server エンドポイントのみを有効にしてください。 SQL Server では、既定で組み込みの TCP エンドポイント (削除不可) が 1 つ提供されています。 AD FS には、この TCP エンドポイントを Kerberos 認証に対して有効にする必要があります。 現状の TCP エンドポイントを確認してユーザー定義の別の TCP ポートが SQL のインストールに追加されていないか調べるには、Transact-SQL (T-SQL) セッションで "SELECT * FROM sys.tcp_endpoints" クエリ ステートメントを使用できます。 SQL Server エンドポイント構成の詳細については、「[方法: 複数の TCP ポートでリッスンするようにデータベースエンジンを構成](https://go.microsoft.com/fwlink/?LinkID=189231)する」 (を参照してください https://go.microsoft.com/fwlink/?LinkID=189231) 。  
  
-   **SQL ベースの認証を使用しない。**  
  
    ネットワークでパスワードをクリア テキストとして転送したり、構成設定にパスワードを保存したりすることを避けるために、SQL Server インストールで Windows 認証のみを使用してください。 SQL Server 認証は以前の認証モードです。 SQL Server 認証の使用時に構造化照会言語 (SQL) ログイン資格証明書 (SQL ユーザー名とパスワード) を保存することは推奨されません。 詳細については、「[認証モード](https://go.microsoft.com/fwlink/?LinkID=189232)」 (を参照してください https://go.microsoft.com/fwlink/?LinkID=189232) 。  
  
-   **SQL のインストールで追加のチャネル セキュリティが必要か慎重に評価する。**  
  
    Kerberos 認証が有効でも、SQL Server セキュリティ サポート プロバイダー インターフェイス (SSPI) ではチャネル レベルのセキュリティは提供されません。 ただし、サーバーがファイアウォールで保護されたネットワークに安全に配置されているインストールでは、SQL 通信の暗号化は必要でない場合があります。  
  
    暗号化は、セキュリティの強化に役立つ便利なツールですが、すべてのデータまたは接続に対して考慮すべきものではありません。 暗号化を実装するかどうかを検討する際は、ユーザーがデータにどのようにアクセスするかを考慮する必要があります。 ユーザーがパブリック ネットワーク経由でデータにアクセスする場合は、セキュリティを強化するためにデータの暗号化が必要になると考えられます。 ただし、AD FS による SQL データのすべてのアクセスにセキュリティで保護されたイントラネット構成が関係している場合は、暗号化を必要としない可能性があります。 暗号化を使用する場合は、それに伴ってパスワード、キー、および証明書のメンテナンス計画が必要になります。  
  
    ネットワークで何らかの SQL データの参照または改ざんの可能性が懸念される場合は、インターネット プロトコル セキュリティ (IPsec) または Secure Sockets Layer (SSL) を使用して SQL 接続をセキュリティで保護してください。 ただし、SQL Server のパフォーマンスに悪影響を及ぼす可能性があります。これは、状況によっては AD FS のパフォーマンスに影響を与えたり、制限したりする可能性があります。 たとえば、SQL ベースの属性ストアからの属性参照がトークンの発行に不可欠な場合、トークンの発行での AD FS のパフォーマンスが低下する可能性があります。 SQL の改ざんの脅威は、境界セキュリティの構成を強固にすることでより確実に排除することができます。 たとえば、SQL Server のインストールをセキュリティで保護するためのより良いソリューションは、SQL Server に対して、インターネット ユーザーとコンピューターはアクセスできない状態にし、データセンター環境内のユーザーとコンピューターのみがアクセスできる状態にすることです。  
  
    詳細については、「 [SQL Server への接続の暗号化](https://go.microsoft.com/fwlink/?LinkID=189234)」または「 [SQL Server 暗号化](https://go.microsoft.com/fwlink/?LinkID=189233)」を参照してください。  
  
-   **ストアドプロシージャを使用して、sql に格納されているデータの AD FS によって SQL ベースのすべての参照を実行することで、安全に設計されたアクセスを構成します。**  
  
    サービスとデータの分離をより確実にするために、すべての属性ストア参照コマンドのためにストアド プロシージャを作成できます。 次に、ストアド プロシージャを実行する権限を付与するデータベースの役割を作成できます。 AD FS Windows サービスのサービス id をこのデータベースロールに割り当てます。 AD FS Windows サービスは、属性参照に使用される適切なストアドプロシージャ以外の他の SQL ステートメントを実行できないようにする必要があります。 このような方法で SQL Server データベースへのアクセスをロックダウンすることで、特権の昇格攻撃のリスクが低減されます。  
  
## <a name="see-also"></a>参照
[Windows Server 2012 での AD FS 設計ガイド](AD-FS-Design-Guide-in-Windows-Server-2012.md)
