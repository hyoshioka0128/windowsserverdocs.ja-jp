---
ms.assetid: e6fa9069-ec9c-4615-b266-957194b49e11
title: Windows Server 2016 への AD RMS のアップグレード
author: msmbaldwin
ms.author: esaggese
ms.date: 05/30/2019
ms.prod: windows-server
ms.topic: article
ms.openlocfilehash: 88af85f8e670b9c23b503e0f79af2ce8f10d045e
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2020
ms.locfileid: "80854855"
---
# <a name="upgrading-ad-rms-to-windows-server-2016"></a>Windows Server 2016 への AD RMS のアップグレード

## <a name="introduction"></a>はじめに

Active Directory Rights Management サービス (AD RMS) は、機密性の高いドキュメントや電子メールを保護する Microsoft のサービスです。 ファイアウォールや Acl などの従来の保護方法とは異なり、AD RMS の暗号化と保護は、ファイルの場所や転送方法にかかわらず永続的です。 

このドキュメントでは、Windows Server 2012 R2 SQL Server 2012 から Windows Server 2016 および SQL Server 2016 への移行に関するガイダンスを提供します。 同じプロセスを使用して、古いがサポートされているバージョンの AD RMS から移行できます。
Active Directory Rights Management サービスは現在アクティブな開発ではなく、最新の機能については、 [Azure Information Protection](https://azure.microsoft.com/services/information-protection/)への移行を検討してください。これにより、より包括的なデバイスとアプリケーションのサポートにより包括的な機能セットが提供されます。 

コンテンツを再保護せずに AD RMS から Azure Information Protection に移行する方法の詳細について[は、Azure Information Protection の移行に関するドキュメントを](https://docs.microsoft.com/azure/information-protection/migrate-from-ad-rms-to-azure-rms)参照してください。

## <a name="about-the-environment-used-in-this-guide"></a>このガイドで使用されている環境について

AD FS は、AD RMS インストールのオプションのコンポーネントです。 このガイドでは、ADFS の使用を前提としています。 AD RMS ユーザーをサポートするために ADFS が環境内で使用されていない場合は、ADFS を参照するすべての手順を省略できます。

このガイドでは、並列インストールを実行し、データベースをバックアップ経由で移動することで、SQL Server を SQL Server 2016 にアップグレードします。 または、AD RMS と ADFS データベースサーバーを SQL Server 2016 にインプレースアップグレードできる場合は、このセクションの手順を実行しなくても、このドキュメントの次のセクションに進むことができます。  

## <a name="installation"></a>インストール

### <a name="configuring-sql-server-2016"></a>SQL Server 2016 の構成

次のセクションでは、SQL Server 2016 構成に直接関連する実装タスクについて詳しく説明します。 このガイドでは、サーバーマネージャーと SQL Server Management Studio を使用してこれらのタスクを実行する方法について説明します。

これらの手順は、SQL Server 2016 インストールで完了する必要があります。 組織の標準的なプラクティスやポリシーに従って、適切なハードウェアに SQL Server 2016 をインストールします。 

#### <a name="preparing-the-sql-server"></a>SQL Server の準備

次のセクションでは、AD RMS プラットフォームの他のサービスをアップグレードして Windows Server 2016 を使用する前に、SQL Server 2016 にアップグレードできるように SQL Server を準備する方法について詳しく説明します。

##### <a name="adding-cname-for-sql-server-2016-to-dns"></a>DNS に SQL Server 2016 の CNAME を追加しています

CNAME を使用して、Windows Server 2016 のセットアップが新しい SQL Server 2016 でポイントされるため、適切なデータを取得するようにします。 **注: 既に ADFS と AD RMS サービスに CNAME を使用している場合は、次の手順に進むことができます。**


**SQL Server 2016 の CNAME を DNS に追加するには**

1.  ドメイン管理者の資格情報を使用して、Windows Server 2012 R2 ドメインコントローラーにログオンします。

2.  サーバー マネージャーを開きます。

3.  **[ツール]** をクリックし、 **[dns]** を選択して、dns マネージャーを開きます。

4.  左側のナビゲーションウィンドウで、DC を展開し、**前方参照ゾーン** を開きます。

5.  適切なドメインリソースを開き、右側のビューペインで右クリックして、 **[新しいエイリアス (cname)]** を選択し、cname の作成を開始します。

6.  エイリアス名として、論理名を入力して、存在する可能性がある他のものと区別します (例として、 SQLADRMS または SQLADFS)

7.  名前を入力した後、新しい SQL Server 2016 サーバーとなるターゲットホストの FQDN を指定します。 エックス. SQL2016.contoso.com)

8.  すべての情報を入力したら、[ **OK]** をクリックします。

##### <a name="backup-the-ad-rms-and-adfs-databases"></a>AD RMS と ADFS データベースをバックアップする

AD RMS および ADFS データベースには、サーバーライセンサー証明書の公開キー、権利ポリシーテンプレート、ADFS 構成データ、ログ情報など、AD RMS に必要な重要な情報が保持されています。 これらのデータベースがないと、クライアントは保護されたコンテンツを使用するためのライセンスを発行できません。その他の問題があります。

データベースの AD RMS 構成データベースは、SLC、権利ポリシーテンプレート、ユーザーのキー、および構成情報を格納するため、最も重要であると考えられます。 そのため、すべての AD RMS と ADFS データベースをバックアップする必要がありますが、構成データベースを定期的にバックアップするように計画する必要があります。

ログデータベースには、証明書と使用ライセンスの AD RMS クラスターへのユーザー要求に関する情報が格納されます。 このデータベースのバックアップ方法は、この種類の情報を保持するための会社のポリシーに基づいている必要があります。

ディレクトリサービスデータベースは AD RMS 機能にとって重要ではなく、最新のデータが失われた場合、AD RMS サーバーが証明書の要求を受け取り、ライセンスを使用すると、データベースに情報が再作成されます。 このデータベースを定期的にバックアップする必要はありませんが、AD RMS の配置後に最初に構成されたデータベースのコピーが少なくとも1つ必要です。

**Microsoft SQL Server を使用して AD RMS または ADFS データベースをバックアップするには**

1.  SQL 2012 を使用して、Windows Server 2012 R2 AD RMS データベースサーバーにログオンします。

2.  **[スタート]** 、 **[すべてのプログラム]** 、 **[Microsoft SQL Server]** の順にクリックし、 **[SQL Server Management Studio]** をクリックします。

3.  **[サーバーへの接続]** ウィンドウで、AD RMS データベースをホストしているサーバーが **[サーバー名]** ボックスに表示されていることを確認し、 **[接続]** をクリックします。

4.  **[データベース]** を展開します。 適切なデータベース (**Drms**と**Adfs**) を右クリックし、 **[タスク]** をポイントして、 **[バックアップ]** を選択します。

5.  残りのデータベースについて、手順 4. を繰り返します。

6.  ネットワーク上の他のコンピューターから、または記憶域デバイスを使用して、データベースのバックアップにアクセスできることを確認します。これは、移行中の後の手順で必要になります。

これで、データベースのコピーを安全な場所に格納できるようになりました。 データベースを頻繁にバックアップするようにしてください。

##### <a name="adding-domain-admin-sql-ad-rms-andor-adfs-service-account-to-sql-server-2016"></a>SQL Server 2016 にドメイン管理者、SQL、AD RMS、または ADFS サービスアカウントを追加する

次の手順では、SQL Server 2016 にさまざまなサービスアカウントを追加して、Windows Server 2012 R2 環境からのデータの移行を支援する方法を紹介します。 これにより、コンテンツにアクセスしてデータを処理するときに、適切なアクセス許可が与えられます。

**ドメイン管理者、SQL、AD RMS、または ADFS サービスアカウントをに追加するには SQL Server**

1.  ローカル管理者アカウントとして SQL Server 2016 を使用してサーバーにログオンします。

2.  **[スタート]** 、 **[すべてのプログラム]** 、 **[Microsoft SQL Server]** の順にクリックし、 **[SQL Server Management Studio]** をクリックします。

3.  **[サーバーへの接続]** ウィンドウで、AD RMS データベースをホストしているサーバーが **[サーバー名]** ボックスに表示されていることを確認します。次に、認証 で、ドロップダウンメニューをクリックし、 **[SQL Server 認証]** を選択します。

4.  **[ログイン]** フィールドに、ローカル管理者アカウントの名前 (例として「」) を入力します。 localadmin) を入力し、適切なパスワードを入力して、 **[接続]** をクリックします。

5.  **[セキュリティ]** を展開し、 **[ログイン]** を右クリックして、表示されるショートカットメニューから **[新しいログイン]** を選択します。

6.  ウィンドウが表示されたら、 **[ログイン名]** フィールドに「Domain Admin アカウント」と入力します (例は、 Contoso\\ContosoAdmin)

7.  左側のナビゲーションウィンドウで、 **[サーバーの役割]** を選択します。

8.  次に、サーバーロールで **[sysadmin]** のチェックボックスをオンにして、[ **OK]** をクリックします。

9.  **SQL Server 管理**を再起動します。

10. **[サーバーへの接続]** ウィンドウで、AD RMS データベースをホストしているサーバーが **[サーバー名]** ボックスに表示されていることを確認します。次に、認証 で、ドロップダウンメニューをクリックし、 **[Windows 認証]** をクリックして **[接続]** をクリックします。

##### <a name="restoring-the-ad-rms-and-adfs-databases-to-sql-server-2016"></a>AD RMS と ADFS データベースを SQL Server 2016 に復元する

次の手順は、前の SQL Server インスタンスから新しい2016インスタンスにデータを復元する方法を示しています。 これにより、新しい SQL では、前の AD RMS と ADFS データベースから関連する構成データを利用できるようになります。

**前の SQL Server のデータを新しい SQL Server に復元するには**

1.  適切なアカウントを使用して、SQL Server 2016 でサーバーにログオンします。

2.  左側のナビゲーションウィンドウで、 **[データベース]** を右クリックし、 **[データベースの復元]** を選択して復元プロセスを開始します。

3.  **[ソース]** で **[デバイス]** を選択し、前の手順でデータベースファイルが格納されていた場所を参照します。

4.  ファイルが選択されたら、[ **OK]** をクリックします。

5.  すべてのデータベースファイルが追加されていることを確認し、 **[OK]** をクリックしてプロセスを完了します。

### <a name="configuring-windows-server-2016-active-directory-federation-services-ad-fs"></a>Windows Server 2016 Active Directory フェデレーションサービス (AD FS) (AD FS) の構成

AD FS は、アプリケーションとして AD RMS にシングルサインオン (SSO) アクセスを提供するようにデプロイされています。 また、AD RMS モバイルデバイス拡張機能 (MDE) を使用して構成されています。これにより、エンドユーザーに対して Mac とモバイルデバイスのサポートが有効になります。

次のセクションでは、AD FS の展開で実行する必要のある運用タスクに関するガイダンスを提供します。

#### <a name="adding-a-2016-ad-fs-server-to-the-farm"></a>ファームへの 2016 AD FS サーバーの追加

AD RMS の展開をサポートするために、追加の AD FS サーバーを展開できます。 AD RMS サーバーまたはその他のアプリケーションへのトラフィックが増加した場合、または AD FS に現在使用されているサーバーの1つを削除する必要がある場合に、このアクションを実行することを選択できます。

**2016 AD FS サーバーをファームに追加するには**

1.  Azure AD Connect サーバーから、 **Azure AD Connect**アイコンをダブルクリックして、Azure AD Connect ウィザードを起動します。

2.  ようこそ ページで、**構成** をクリックします。

3.  追加のタスク ページで、**追加のフェデレーションサーバーの展開** をクリックし、**次へ** をクリックします。

4.  Azure AD への接続 ページで、グローバル管理アクセス許可を持つアカウントのユーザー名とパスワードを入力し、**次へ** をクリックします。

5.  ドメイン管理者の資格情報 ページで、ドメイン管理者のアクセス許可を持つアカウントのユーザー名とパスワードを入力し、**次へ** をクリックします。

6.  **[参照]** をクリックし、Azure AD Connect を使用して AD FS ファームを構成するときに使用する証明書ファイルを選択します。

7.  **パスワードの入力** をクリックして、証明書のパスワード ダイアログボックスを開きます。

8.  パスワード フィールドに証明書のパスワードを入力し、 **OK** をクリックします。

9.  **[次へ]** をクリックします。

10. AD FS サーバー ページで、新しい AD FS サーバーの名前または IP アドレスを入力し、**追加** をクリックします。

11. 構成の準備完了 ページで、**インストール** をクリックします。

12. インストールの完了 ページで、**終了** をクリックします。

#### <a name="raising-the-adfs-farm-behavior-level"></a>ADFS ファームの動作レベルを上げる

など、現在の環境レベルを超える ADFs サーバーを展開する場合、Windows Server 2012 R2 で ADFS を使用していて、ADFS Windows Server 2016 を追加する場合は、ファームの動作レベルを上げる必要があります。 これは、環境が最新の情報と機能を使用していることを確認するために必要です。

**ADFS ファームの動作レベルを上げるには**

1.  Windows Server 2016 ADFS に移動します。

2.  管理者の PowerShell セッションを開きます。

3.  次のコマンドを入力します。 **\$cred = Get-Credential**

4.  資格情報を求めるウィンドウが表示されたら、ドメイン管理者の資格情報を入力します。

5.  次のコマンドを入力します: **AdfsFarmBehaviorLevelRaise-Credential \$cred**

6.  プロンプトが表示され**ます。この操作を続行しますか?** プロンプトを受け入れるに**は、** 「」と入力します。

7.  コマンドが完了すると、ファームの動作レベルがセットアップされ、準備が整います。

#### <a name="enabling-mobile-device-extension-logging"></a>モバイルデバイス拡張機能のログ記録の有効化

モバイルデバイス拡張機能は、エンドユーザーのデバイスから受信した要求をログに記録できます。 ログ記録は既定で無効になっているので、トラブルシューティングのシナリオでのみログ記録を有効にすることをお勧めします。 モバイルデバイスとデスクトップコンピューターからのすべての要求は、AD RMS ログデータベースまたは Azure ストレージアカウントに記録されます。 MDE ログでは、AD RMS によって使用される SQL Server に、クライアントデバッグログテーブルとクライアントパフォーマンスログテーブルの2つの追加テーブルが作成されます。

**モバイルデバイス拡張機能のログ記録を有効にするには**

1.  AD RMS サーバーから、管理者として Windows PowerShell を開きます。

2.  次のコマンドを入力し **、enter キーを押します**。 **Import-Module AdRmsAdmin**

3.  次のコマンド**を入力し、enter キーを**押します。 **PSDrive-Name AdrmsCluster-Psprovider AdRmsAdmin-Root https://localhost**

4.  次のコマンドを入力し **、enter キーを押します**。 **Get-itemproperty-Path AdrmsCluster:\\-Name Is enabled-Value \$true**

トラブルシューティングに MDE ログを使用する場合は、問題に対処した後で無効にすることをお勧めします。

**モバイルデバイス拡張機能のログ記録を無効にするには**

1.  AD RMS サーバーから、管理者として Windows PowerShell を開きます。

2.  次のコマンドを入力し **、enter キーを押します**。 **Import-Module AdRmsAdmin**

3.  次のコマンド**を入力し、enter キーを**押します。 **PSDrive-Name AdrmsCluster-Psprovider AdRmsAdmin-Root https://localhost**

4.  次のコマンド**を入力し、enter キーを**押します。 **Get-itemproperty-Path AdrmsCluster:\\-Name Is enabled-Value \$false**

### <a name="upgrading-ad-rms-to-windows-server-2016"></a>Windows Server 2016 への AD RMS のアップグレード

以下のセクションでは、Windows server 2016 ベースの AD RMS サーバーを、現在の Windows Server 2012 R2 クラスターに追加する方法について説明します。 サーバーがクラスターに追加され、以前の AD RMS サーバーを非推奨にしてリソースを解放できるように、そのサーバーに情報がレプリケートされます。

1つの Windows Server 2016 ベース AD RMS サーバーを AD RMS クラスターに追加すると、以前のバージョンの Windows に基づくすべてのノードが非アクティブになります。 この処理が完了すると、これらのサーバーのプロビジョニングを解除できます (たとえば、Windows Server 2016 でシャットダウン、転用、または再インストールして AD RMS クラスターに参加させることができます)。 

クラスターに追加の AD RMS サーバーをデプロイして、AD RMS デプロイの負荷をサポートすることができます。 また、AD RMS サーバーへのトラフィックが増加した場合に、このアクションを実行することもできます。

このガイドでは、非推奨しているサーバーを除外し、クラスターに追加するサーバーを含めるために、環境内で使用している負荷分散メカニズムを変更するために必要な手順については説明しません。 

#### <a name="adding-a-2016-ad-rms-server"></a>2016 AD RMS サーバーの追加

AD RMS クラスターが、サーバーライセンサー証明書に対して一元的に管理されたキーではなくハードウェアセキュリティモジュールを使用している場合は、AD RMS をインストールする前に、ソフトウェアとその他の HSM アーティファクト (キーやファイルなど) をサーバーにインストールする必要があります。 また、物理的に、または関連するネットワーク構成を使用して、HSM をサーバーに接続する必要があります。 これらの手順については、HSM のガイダンスに従ってください。 

**2016 AD RMS サーバーを追加するには**

1.  必要な Windows Server 2016 の展開に AD RMS の役割をインストールします。

2.  インストールが完了したら、リンクを選択して**追加の構成を行い**ます。

3.  **[既存の AD RMS クラスターに参加]** します を選択し、 **[次へ]** をクリックします。

4.  **[構成データベースの選択]** ページで、2016 SQL SERVER (FQDN) の DNS に指定されている CNAME を入力します。

5.  2行目の **[リスト]** をクリックし、ドロップダウンから**defaultinstance**を選択します。

6.  **[構成データベース名]** でドロップダウンメニューを選択し、表示される drms 構成を選択します。 続けて、 **[次へ]** をクリックします。

7.  **[データベース情報]** ページで、表示されたフィールドにクラスターキーパスワードを入力します。 その後、 **[次へ]** をクリックします。

8.  ウィザードの次のページで、AD RMS サービスアカウントを指定し、パスワードを入力して、確認が完了したら **[次へ]** をクリックします。

9.  **[クラスター Web サイト]** ページが表示されたら、適切な web サイトが選択されていることを確認し、 **[次へ]** をクリックします。

10. **[サーバー認証証明書の選択]** ページで、インポートされた SSL 証明書を選択し、 **[次へ]** をクリックします。

11. **[インストール]** をクリックしてインストールを開始します。

12. 構成が完了したら、ログオフしてから、AD RMS を管理するために再度ログオンする必要があります。

13. 再度ログオンした後で、 **[ツール]** **サーバーマネージャー**選択し、 **[Active Directory Rights Management]** をクリックします。 [管理] ウィンドウが表示され、クラスターにクラスター内の追加のサーバーがあることが示されます。

14. AD RMS モバイルデバイス拡張機能が元の AD RMS クラスターにインストールされている場合は、更新されたクラスターノードに MDE もインストールする必要があります。 MDE ドキュメントに記載されている手順に従って、AD RMS クラスターに MDE を追加します。 この時点で、既存のすべてのノードを再利用するか、Windows Server 2016 にアップグレードして、上記と同じプロセスを使用して AD RMS クラスターに再度参加させることができます。 

### <a name="configuring-windows-server-2016-web-application-proxy-wap"></a>Windows Server 2016 Web アプリケーションプロキシ (WAP) の構成

以下のセクションでは、Web アプリケーションプロキシの展開で実行する必要のある運用タスクに関するガイダンスを提供します。 これは省略可能な手順であり、他のメカニズムを使用してインターネットに AD RMS を公開する場合は必要ありません。 

#### <a name="adding-a-windows-server-2016-wap-server"></a>Windows Server 2016 WAP サーバーの追加

AD RMS の展開をサポートするために、追加の Web アプリケーションプロキシサーバーを展開することができます。 AD RMS サーバーへのトラフィックが増加した場合、または Web アプリケーションプロキシで現在使用されているサーバーの1つを削除する必要がある場合に、このアクションを実行することを選択できます。

**2016 Web アプリケーションプロキシサーバーを追加するには**

1.  Web アプリケーションプロキシとしてセットアップするサーバーからサーバーマネージャーコンソールに移動し、 **[役割と機能の追加]** をクリックします。

2.  **役割と機能の追加ウィザード**で、サーバーの役割の選択 画面が表示されるまで **次へ** をクリックします。

3.  サーバーの役割の選択 画面で、**リモートアクセス** を選択し、サーバーの役割の選択 画面に戻るまで **次へ** をクリックします。

4.  サーバーの役割の選択 画面で  **Web アプリケーションプロキシ** を選択し、**機能の追加** をクリックして、**次へ** をクリックします。

5.  インストールオプションの確認 画面で、**インストール** をクリックします。

6.  インストールが完了したら、 **[閉じる]** をクリックします。

7.  次に、サーバーを構成します。 これを行うには、Web アプリケーションプロキシサーバーでリモートアクセス管理コンソールを開きます。 **[スタート]** メニューを開き、「 **ramgmtui.exe**」と入力して、アプリケーションを選択します。

8.  ナビゲーション ウィンドウで **[Web アプリケーション プロキシ]** をクリックします。

9.  リモートアクセス管理コンソールで、 **[Web アプリケーションプロキシ構成ウィザードを実行する]** をクリックします。 ウィザードで **[次へ]** をクリックします。

10. [フェデレーションサーバー] 画面で、AD FS サーバーの完全修飾ドメイン名を入力します (例については、 adfs.contoso.com) をクリックし、AD FS サーバーの管理者の資格情報を入力します。

11. プロキシ証明書の AD FS 画面の Web アプリケーションプロキシサーバーに現在インストールされている証明書の一覧で、AD FS プロキシの Web アプリケーションプロキシで使用する証明書を選択し、**次へ** をクリックします。

12. 確認 画面で設定を確認し、**構成** をクリックします。

13. 構成が完了したら、 **[閉じる]** をクリックします。

#### <a name="dns-configuration-for-2016-wap-server"></a>2016 WAP サーバーの DNS 構成

Windows Server 2016 Web アプリケーションプロキシサーバーを配置したら、いくつかの DNS 変更を行う必要があります。 そのためには、GoDaddy などのサービスを使用して、2016 WAP サーバーで ADFS と AD RMS サービスをポイントする必要があります。

**WAP サーバーで DNS をポイントするには**

1.  プロバイダーの web サイト (例) に移動します。 GoDaddy)。

2.  [ドメイン管理]、[DNS 管理] の順に選択します。

3.  ADFS と AD RMS サービスを見つけて、**ポイントを**2016 WAP サーバーのパブリック IP アドレスに置き換えて**保存**します。

4.  変更は反映されるまでに時間がかかる場合がありますが、この設定が完了すると、このセットアップが完了します。

#### <a name="enabling-debugging-logs"></a>デバッグログの有効化

詳細なログ情報は、Web アプリケーションプロキシサーバーで使用できます。 イベントビューアーを使用して、詳細なデバッグログを構成できます。 ログのサイズに対して追加の設定を選択して、分析がビューアーにとって有用であることを確認することもできます。

**Web アプリケーションプロキシのデバッグログを有効にする**

1.  Web アプリケーションプロキシで**イベントビューアー**コンソールを開きます。

2.  **Microsoft**ノードを展開します。

3.  **[Windows]** ノードを展開します。

4.  **Web アプリケーションプロキシ**のログを開きます。

5.  その後、**管理**ログを開くことができます。

6.  左上にある **[操作]** メニューを開き、 **[プロパティ]** を選択します。

7.  **[全般]** タブで、**ログ記録を有効**にするオプションを選択します。

8.  最後に、最大ログサイズと、イベントログの最大サイズに達したときの動作をカスタマイズできます。

### <a name="configuring-high-availability-for-windows-server-2016-services"></a>Windows Server 2016 サービスの高可用性の構成

次のセクションでは、高可用性で Windows Server 2016 環境をセットアップするために必要となる可能性がある運用タスクに関するガイダンスを提供します。

#### <a name="adding-a-2016-ad-rms-server-for-high-availability"></a>高可用性を実現するための 2016 AD RMS サーバーの追加

高可用性をセットアップするために、追加の AD RMS サーバーを展開することができます。 AD RMS サーバーへのトラフィックが増加した場合に、このアクションを実行することを選択できます。

**高可用性を実現するために 2016 AD RMS サーバーを追加するには**

1.  必要な Windows Server 2016 の展開に AD RMS の役割をインストールします。

2.  インストールが完了したら、リンクを選択して**追加の構成を行い**ます。

3.  **[既存の AD RMS クラスターに参加]** します を選択し、 **[次へ]** をクリックします。

4.  **[構成データベースの選択]** ページで、2016 SQL SERVER (FQDN) の DNS に指定されている CNAME を入力します。

5.  2行目の **[リスト]** をクリックし、ドロップダウンから**defaultinstance**を選択します。

6.  **[構成データベース名]** でドロップダウンメニューを選択し、表示される drms 構成を選択します。 続けて、 **[次へ]** をクリックします。

7.  **[データベース情報]** ページで、表示されたフィールドにクラスターキーパスワードを入力します。 その後、 **[次へ]** をクリックします。

8.  ウィザードの次のページで、AD RMS サービスアカウントを指定し、パスワードを入力して、確認が完了したら **[次へ]** をクリックします。

9.  **[クラスター Web サイト]** ページが表示されたら、適切な web サイトが選択されていることを確認し、 **[次へ]** をクリックします。

10. **[サーバー認証証明書の選択]** ページで、インポートされた SSL 証明書を選択し、 **[次へ]** をクリックします。

11. **[インストール]** をクリックしてインストールを開始します。

12. 構成が完了したら、ログオフしてから、AD RMS を管理するために再度ログオンする必要があります。

13. 再度ログオンした後で、 **[ツール]** **サーバーマネージャー**選択し、 **[Active Directory Rights Management]** をクリックします。 [管理] ウィンドウが表示され、クラスターにクラスター内の追加のサーバーがあることが示されます。

14. サーバーのセットアップを確認したら、クラスター内の異なる AD RMS サーバー間で負荷を分散するように負荷分散サービスを構成します。

#### <a name="adding-a-windows-server-2016-ad-fs-server-for-high-availability"></a>高可用性を実現するための Windows Server 2016 AD FS サーバーの追加

高可用性をセットアップするために、追加の AD FS サーバーを展開することができます。 AD FS サーバーへのトラフィックが増加した場合に、このアクションを実行することを選択できます。 **注: ファームの動作レベルを上げた後、新しいデータベースエントリが SQL Server 2016 (Adfs Configv3) に入力されます。これらの手順を続行する前に、古い構成データベースを削除する必要があります。**

**高可用性を実現するために Windows Server 2016 AD FS サーバーを追加するには**

1.  必要な Windows Server 2016 の展開に AD RMS の役割をインストールします。

2.  インストールが完了したら、**このサーバーでフェデレーションサービスを構成**するためのリンクを選択します。

3.  ウィザードの [ようこそ] セクションで、フェデレーションサーバーを**フェデレーションサーバーファームに追加**するオプションを選択し、 **[次へ]** をクリックします。

4.  適切な管理者アカウントを指定し、 **[次へ]** をクリックします。

5.  **[ファームの指定]** ページで、 **[SQL Server を使用して既存のファームのデータベースの場所を指定]** する を選択し、データベースのホスト名として SQL サービスの CNAME を入力して、 **[次へ]** をクリックします。

6.  ウィザードの **[サービスアカウントの指定]** 領域で、AD FS サービスアカウントの資格情報を入力し、 **[次へ]** をクリックします。

7.  **[オプションの確認]** で、 **[次へ]** をクリックします。

8.  ボタンが使用可能になったら、 **[構成]** をクリックします。

9.  構成が完了したら、コンピューターを再起動します。

10. サーバーのセットアップを確認したら、必要に応じて AD FS サーバーの負荷を分散します。

#### <a name="adding-a-windows-server-2016-wap-server-for-high-availability"></a>高可用性を実現するための Windows Server 2016 WAP サーバーの追加

高可用性を設定するために、追加の WAP サーバーを展開することができます。 AD RMS サーバーへのトラフィックが増加した場合に、このアクションを実行することを選択できます。

**高可用性を実現するために Windows Server 2016 Web アプリケーションプロキシサーバーを追加するには**

1.  Web アプリケーションプロキシとしてセットアップするサーバーからサーバーマネージャーコンソールに移動し、 **[役割と機能の追加]** をクリックします。

2.  **役割と機能の追加ウィザード**で、サーバーの役割の選択 画面が表示されるまで **次へ** をクリックします。

3.  サーバーの役割の選択 画面で、**リモートアクセス** を選択し、サーバーの役割の選択 画面に戻るまで **次へ** をクリックします。

4.  サーバーの役割の選択 画面で  **Web アプリケーションプロキシ** を選択し、**機能の追加** をクリックして、**次へ** をクリックします。

5.  インストールオプションの確認 画面で、**インストール** をクリックします。

6.  インストールが完了したら、 **[閉じる]** をクリックします。

7.  次に、サーバーを構成します。 これを行うには、Web アプリケーションプロキシサーバーでリモートアクセス管理コンソールを開きます。 **[スタート]** メニューを開き、「 **ramgmtui.exe**」と入力して、アプリケーションを選択します。

8.  ナビゲーション ウィンドウで **[Web アプリケーション プロキシ]** をクリックします。

9.  リモートアクセス管理コンソールで、 **[Web アプリケーションプロキシ構成ウィザードを実行する]** をクリックします。 ウィザードで **[次へ]** をクリックします。

10. [フェデレーションサーバー] 画面で、AD FS サーバーの完全修飾ドメイン名を入力します (例については、 adfs.contoso.com) をクリックし、AD FS サーバーの管理者の資格情報を入力します。

11. プロキシ証明書の AD FS 画面の Web アプリケーションプロキシサーバーに現在インストールされている証明書の一覧で、AD FS プロキシの Web アプリケーションプロキシで使用する証明書を選択し、**次へ** をクリックします。

12. 確認 画面で設定を確認し、**構成** をクリックします。

13. 構成が完了したら、 **[閉じる]** をクリックします。

14. サーバーのセットアップを確認した後、DMZ で WAP サーバーの負荷を分散します。

#### <a name="adding-a-sql-server-2016-node-for-always-on-high-availability"></a>Always On 高可用性のための SQL Server 2016 ノードの追加

Always On 高可用性をセットアップするために、追加の SQL server を展開することができます。 AD RMS サーバーへのトラフィックが増加した場合に、このアクションを実行することを選択できます。 **注: 両方の SQL Server に受信ポート5022が開いていることを確認してください。**

**Always On 高可用性を実現するために SQL server 2016 サーバーを追加するには**

1.  追加の SQL Server 2016 サーバーとしてセットアップするサーバーで、サーバーマネージャーコンソールに移動し、 **[役割と機能の追加]** をクリックします。

2.  **[機能の選択]** ダイアログボックスまで **[次へ]** をクリックします。

3.  **[フェールオーバークラスタリング]** チェックボックスをオンにします。 **注: この手順に従って、元の SQL server 2016 サーバーでもフェールオーバークラスタリング機能を使用できるようにします。**

4.  **[インストール]** をクリックして、フェールオーバークラスタリング機能をインストールします。

5.  次に、**サーバーマネージャー**を開き、 **[ツール]** 、 **[フェールオーバークラスターマネージャー]** の順に選択します。

6.  左側のメニューウィンドウで、**フェールオーバークラスターマネージャー**を右クリックし、**クラスターの作成** を選択します。

7.  **クラスターの作成ウィザード**が開きます。

8.  高可用性 Always On に使用される SQL server 2016 サーバーを参照し、 **[次へ]** をクリックします。

9.  検証の警告が表示されます。 **[はい]** を選択してクラスターノードを検証し、 **[次へ]** をクリックします。

10. **テストオプション** ページで、**すべてのテストを実行** オプションを選択し、次へ をクリックし**ます。**

11. **注: クラスター検証ウィザードでは、特に共有記憶域を使用しない場合に、いくつかの警告メッセージが返されることが想定されています。それ以外の場合、エラーメッセージが見つかった場合は、Windows Server フェールオーバークラスターを作成する前に修正する必要があり**ます。

12. **[クラスター管理用のアクセスポイント]** ダイアログボックスで、Windows Server フェールオーバークラスターのクラスター名と仮想 IP アドレスを入力し、 **[次へ]** をクリックします。

13. 構成が正常に完了したことを確認**し、[** **完了**] をクリックします。

14. フェールオーバークラスターマネージャーに戻り **、** クラスターを右クリックし、 **[その他のアクション]** 、 **[クラスタークォーラム設定の構成]** の順に選択します。

15. **[次へ]** をクリックし、 **[クォーラム監視の選択]** のオプションを選択して、もう一度 **[次へ]** をクリックします。

16. **[クォーラム監視の選択**] ページで、 **[ファイル共有監視を構成する]** オプションを選択します。 続けて、 **[次へ]** をクリックします。

17. **参照** を選択し、ファイル共有パス ダイアログボックスで使用するファイル共有のパスを指定します。 **[次へ]** をクリックします。

18. 確認 ページで、**次へ** をクリックします。

19. 概要 ページで、**完了** をクリックします。

20. 次に、 **[スタート]** メニューを開き、 **SQL Server 構成マネージャー**を検索します。

21. SQL Server 名を右クリックし、 **[プロパティ]** を選択します。

22. プロパティ ダイアログボックスで、 **AlwaysOn 高可用性** タブを選択します。 **AlwaysOn 可用性グループを有効にする** チェックボックスをオンにします。 **[OK]** をクリックすると、 **注: この操作は、両方の SQL server 2016 サーバーで実行します。**

23. 次に、SQL Server サービスを再起動します。

24. 次に、 **[スタート]** メニューを開き、左側のナビゲーションウィンドウで**SQL Server Management Studio**を検索します。次に、 **[可用性グループ]** を右クリックし、 **[新しい可用性グループウィザード]** をクリックして、 **[次へ]** をクリックします。

25. **[可用性グループ名の指定]** ページで、グループ名 (例 SQLAvailabilityGroup2016) を選択します。 続けて、 **[次へ]** をクリックします。

26. **[データベースの選択]** セクションで、データベースを指定します。 その後、[次へ] をクリックします。 **注: 一部のデータベースは、もう一度バックアップするか、完全復旧モードにする必要があり**ます。

27. レプリカの **[指定]** ページで、 **[レプリカの追加]** ボタンをクリックし、他の 2016 SQL Server を選択します。

28. 他のサーバーを追加した後、チェックボックスをオンにして、セカンダリサーバーを読み取り可能なセカンダリに設定します。

29. **[エンドポイント]** タブに移動し、 **[更新]** オプションをクリックします。 また、ここでもスクロールし、同じサービスアカウントがプライマリノードとセカンダリノードにあることを確認します。

30. 次に、 **[バックアップの設定]** タブを選択し、 **[セカンダリを優先]** オプションを選択します。

31. **[リスナー]** タブに移動します。

32. 名前を指定します (例 SQLListener) を選択し、ポートが**1433**であることを確認してから、 **[次へ]** をクリックします。

33. ウィザードの **[最初のデータの同期を選択**] ページで、[完全] オプションを選択し、すべての SQL サーバーからアクセス可能**な**ネットワークの場所を指定して、 **[次へ]** をクリックします。

34. 最後に、 **[完了]** をクリックすると、プロセスが完了します。

### <a name="decommission-windows-server-2012-r2-nodes"></a>Windows Server 2012 R2 ノードの使用停止

以下のセクションでは、AD RMS クラスターを Windows Server 2016 に正常にアップグレードした後に、Windows Server 2012 R2 サーバーを削除しなければならない場合がある操作タスクについてのガイダンスを提供します。

#### <a name="removing-a-windows-server-2012-r2-ad-rms-server"></a>Windows Server 2012 R2 AD RMS サーバーの削除

アップグレード後に不要な AD RMS サーバーを削除することができます。 AD RMS サーバーの使用停止が必要になったときに、このアクションを実行することを選択できます。

**Windows server 2012 R2 AD RMS サーバー** **を削除するには**

1.  サーバーマネージャーの Windows Server 2012 R2 AD RMS サーバーで、右上のメニューから **[管理]** を選択し、 **[役割と機能の削除]** を選択します。

2.  **役割と機能の削除ウィザード**が開き、 **[開始する前]** に 画面で **[次へ]** をクリックします。

3.  **[サーバーの選択]** 画面で、 **[次へ]** をクリックします。

4.  **サーバーの役割** 画面で、 **Active Directory Rights Management サービス**の横にあるチェックボックスをオフにし、**次へ** をクリックします。

5.  **[機能]** 画面で、 **[次へ]** をクリックします。

6.  **[確認]** 画面で、 **[削除]** をクリックします。

7.  この処理が完了したら、サーバーを再起動します。

8.  このサーバーをシャットダウンし、必要に応じてリソースを再割り当てできるようになりました。
