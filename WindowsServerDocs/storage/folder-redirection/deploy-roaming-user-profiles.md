---
title: 移動ユーザープロファイルの展開
TOCTitle: Deploying Roaming User Profiles
ms.prod: windows-server
ms.technology: storage
ms.topic: article
author: JasonGerend
manager: brianlic
ms.date: 06/07/2019
ms.author: jgerend
ms.openlocfilehash: b7a89ce8d72cf4f060e83b3653b3b2d93eed5cfd
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71402035"
---
# <a name="deploying-roaming-user-profiles"></a>移動ユーザープロファイルの展開

>適用対象:Windows 10、Windows 8.1、Windows 8、Windows 7、Windows Server 2019、Windows Server 2016、Windows Server (半期チャネル)、windows server 2012 R2、Windows Server 2012、Windows Server 2008 R2

このトピックでは、Windows Server を使用して、[移動ユーザープロファイル](folder-redirection-rup-overview.md)を windows クライアントコンピューターに展開する方法について説明します。 移動ユーザープロファイルは、ユーザーが複数のコンピューターで同じオペレーティングシステムとアプリケーションの設定を受信できるように、ユーザープロファイルをファイル共有にリダイレクトします。

このトピックの最近の変更点の一覧については、このトピックの「[変更履歴](#change-history)」セクションを参照してください。

> [!IMPORTANT]
> [MS16](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016)で行われたセキュリティの変更により、手順 4 [. を更新しました。必要に応じて、このトピックの](#step-4-optionally-create-a-gpo-for-roaming-user-profiles)移動ユーザープロファイルの GPO を作成して、Windows が移動ユーザープロファイルポリシーを適切に適用できるようにします (影響を受ける pc のローカルポリシーに戻すことはできません)。

> [!IMPORTANT]
>  次の構成で OS インプレースアップグレードを実行すると、ユーザーのカスタマイズが失われます。
> - ユーザーは移動プロファイル用に構成されています
> - ユーザーは変更を開始することが許可されています
>
> その結果、OS のインプレースアップグレード後に、[スタート] メニューが新しい OS バージョンの既定値にリセットされます。 回避策につい[ては、「付録 C:アップグレード](#appendix-c-working-around-reset-start-menu-layouts-after-upgrades)後に [スタート] メニューのレイアウトのリセットを回避する。

## <a name="prerequisites"></a>前提条件

### <a name="hardware-requirements"></a>ハードウェア要件

移動ユーザープロファイルには、x64 ベースまたは x86 ベースのコンピューターが必要です。Windows RT ではサポートされていません。

### <a name="software-requirements"></a>ソフトウェア要件

移動ユーザー プロファイルには次のソフトウェア要件があります。

- 既存のローカル ユーザー プロファイルのある環境に、フォルダー リダイレクトと共に移動ユーザー プロファイルを展開する場合、移動ユーザー プロファイルの前にフォルダー リダイレクトを展開して、移動プロファイルのサイズを最小にします。 既存のユーザー フォルダーが正しくリダイレクトされたら、移動ユーザー プロファイルを展開できます。
- 移動ユーザー プロファイルを管理するには、Domain Administrators セキュリティ グループ、Enterprise Administrators セキュリティ グループ、または Group Policy Creator Owners セキュリティ グループのメンバーとしてサインインする必要があります。
- クライアントコンピューターでは、Windows 10、Windows 8.1、windows 8、Windows 7、Windows Vista、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2、または Windows Server 2008 を実行する必要があります。
- クライアント コンピューターは、管理している Active Directory ドメイン サービス (AD DS) に参加している必要があります。
- グループ ポリシー管理および Active Directory 管理センターがインストールされたコンピューターが使用できる必要があります。
- 移動ユーザー プロファイルをホストするためにファイル サーバーが使用できる必要があります。

    - ファイル共有で DFS 名前空間を使用している場合、ユーザーのさまざまなサーバーへの編集の競合を防ぐため、DFS フォルダー (リンク) のターゲットは 1 つである必要があります。
    - ファイル共有で DFS レプリケーションを使用して、コンテンツを別のサーバーにレプリケートする場合、ユーザーのさまざまなサーバーへの編集の競合を防ぐため、ユーザーはソース サーバーにのみアクセスできる必要があります。
    - ファイル共有がクラスター化されている場合は、パフォーマンスの問題を回避するため、ファイル共有での継続的可用性を無効にします。
- 移動ユーザープロファイルでプライマリコンピューターのサポートを使用するには、追加のクライアントコンピューターと Active Directory スキーマの要件があります。 詳細については、「[フォルダーリダイレクトおよび移動ユーザープロファイル用のプライマリコンピューターの展開](deploy-primary-computers.md)」を参照してください。
- 複数の PC、リモートデスクトップセッションホスト、または仮想デスクトップインフラストラクチャ (VDI) サーバーを使用している場合、ユーザーの [スタート] メニューのレイアウトは Windows 10、Windows Server 2019、または Windows Server 2016 ではローミングしません。 回避策として、このトピックで説明するように、開始レイアウトを指定できます。 または、ユーザープロファイルディスクを使用して、リモートデスクトップセッションホストサーバーまたは VDI サーバーで使用するときに [スタート] メニューの設定を適切に移動することもできます。 詳細については、「 [Windows Server 2012 のユーザープロファイルディスクでのユーザーデータ管理の簡易](https://blogs.technet.microsoft.com/enterprisemobility/2012/11/13/easier-user-data-management-with-user-profile-disks-in-windows-server-2012/)化」を参照してください。

### <a name="considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows"></a>複数の Windows のバージョンで移動ユーザー プロファイルを使用する場合の考慮事項

複数の Windows のバージョン間で移動ユーザー プロファイルを使用する場合、次の対策を講じることをお勧めします。

- オペレーティング システムのバージョンごとに、個別のプロファイル バージョンを維持するように Windows を構成します。 これにより、プロファイルの破損など望ましくない予測不能な問題を回避します。
- フォルダー リダイレクトを使用して、ドキュメントやピクチャなどのユーザー ファイルをユーザー プロファイルとは別に保存します。 これにより、ユーザーがオペレーティング システムのバージョンの違いに関係なく、同じファイルを使用できます。 さらに、プロファイルが小さく維持され、サインインが速くなります。
- 移動ユーザー プロファイルに十分な記憶域を割り当てます。 2 つのオペレーティング システムのバージョンをサポートする場合、オペレーティング システム バージョンごとに個別のプロファイルを維持するため、プロファイルの数 (したがって消費される合計の領域) が倍になります。
- Windows Vista/Windows Server 2008 および Windows 7/Windows Server 2008 R2 を実行しているコンピューター間で移動ユーザープロファイルを使用しないでください。 これらのオペレーティングシステムバージョン間のローミングは、プロファイルバージョンが非互換性のため、サポートされていません。
- 1つのオペレーティングシステムのバージョンで行われた変更が別のオペレーティングシステムのバージョンにローミングしないことをユーザーに通知します。
- 別のプロファイルバージョン (windows 10 から windows 10、バージョン1607など) を使用しているバージョンの windows に環境を移動する場合[は、「付録 B:一覧のプロファイルバージョン](#appendix-b-profile-version-reference-information)参照情報) ユーザーには、空の新しい移動ユーザープロファイルが表示されます。 フォルダーリダイレクトを使用して共通のフォルダーをリダイレクトすることによって、新しいプロファイルを取得することによる影響を最小限に抑えることができます。 移動ユーザープロファイルを別のプロファイルバージョンに移行する方法はサポートされていません。

## <a name="step-1-enable-the-use-of-separate-profile-versions"></a>手順 1:個別のプロファイル バージョンの使用を有効にする

Windows 8.1、Windows 8、Windows Server 2012 R2、または Windows Server 2012 を実行しているコンピューターに移動ユーザープロファイルを展開する場合は、を展開する前に、Windows 環境にいくつかの変更を加えることをお勧めします。 これらの変更により、将来のオペレーティング システムのアップグレードがスムーズに進み、移動ユーザー プロファイルによって、複数の Windows のバージョンを同時に実行できるようになります。

これらの変更を行うには、次の手順に従います。

1. ローミング、必須、スーパー必須、またはドメインの既定のプロファイルを使用するすべてのコンピューターに、適切なソフトウェア更新プログラムをダウンロードしてインストールします。

    - Windows 8.1、または Windows Server 2012 R2: Microsoft サポート技術情報の記事[2887595](http://support.microsoft.com/kb/2887595)に記載されているソフトウェア更新プログラムをインストールします (リリースされた場合)。
    - Windows 8 または Windows Server 2012: Microsoft サポート技術情報の記事 [2887239](http://support.microsoft.com/kb/2887239) で説明されているソフトウェア更新プログラムをインストールします。

2. 移動ユーザープロファイルを使用する Windows 8.1、Windows 8、Windows Server 2012 R2、または Windows Server 2012 を実行しているすべてのコンピューターで、レジストリエディターまたはグループポリシーを使用して次のレジストリキー `1`DWORD 値を作成し、それをに設定します。 グループ ポリシーを使用してレジストリ キーを作成する方法については、「 [[レジストリ] 項目を構成する](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753092(v=ws.11)>)」を参照してください。

    ```
    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ProfSvc\Parameters\UseProfilePathExtensionVersion
    ```

    > [!WARNING]
    > レジストリを正しく編集しないと、システムが正常に動作しなくなる場合があります。 レジストリを変更する前に、コンピューター上の重要なデータのバックアップを作成する必要があります。
3. コンピューターを再起動します。

## <a name="step-2-create-a-roaming-user-profiles-security-group"></a>手順 2:移動ユーザー プロファイルのセキュリティ グループを作成する

環境に移動ユーザー プロファイルをまだ設定していない場合、最初の手順は、移動ユーザー プロファイル ポリシー設定を適用するすべてのユーザーやコンピューターを含むセキュリティ グループを作成することです。

- 汎用移動ユーザー プロファイル展開の管理者は一般にユーザーのセキュリティ グループを作成します。
- リモート デスクトップ サービスまたは仮想デスクトップ展開の管理者は一般にユーザーと共有コンピューターのセキュリティ グループを使用します。

移動ユーザープロファイルのセキュリティグループを作成するには、次の手順を実行します。

1. Active Directory 管理センターがインストールされているコンピューターでサーバーマネージャーを開きます。
2. **[ツール]** メニューの **[Active Directory 管理センター]** を選択します。 Active Directory 管理センターが表示されます。
3. 適切なドメインまたは OU を右クリックし、 **[新規作成]** をクリックして、 **[グループ]** を選択します。
4. **[グループの作成]** ウィンドウの **[グループ]** で、次の設定を指定します。

    - **[グループ名]** に、セキュリティ グループの名前を入力します。たとえば、**Roaming User Profiles Users and Computers** のようになります。
    - **[グループのスコープ]** で、 **[セキュリティ]** を選択し、 **[グローバル]** を選択します。

5. **[メンバー]** セクションで、 **[追加]** を選択します。 [ユーザー、連絡先、コンピューター、サービス アカウントまたはグループの選択] ダイアログ ボックスが表示されます。
6. コンピューターアカウントをセキュリティグループに含める場合は、オブジェクトの **[種類]** を選択し、 **[コンピューター]** チェックボックスをオンにして、[ **OK]** を選択します。
7. 移動ユーザープロファイルを展開するユーザー、グループ、またはコンピューターの名前を入力し、 **[ok]** を選択してから、もう一度 **[ok]** を選択します。

## <a name="step-3-create-a-file-share-for-roaming-user-profiles"></a>手順 3:移動ユーザー プロファイルのファイル共有を作成する

移動ユーザープロファイル用の個別のファイル共有 (移動プロファイルフォルダーが誤ってキャッシュされるのを防ぐために、リダイレクトされたフォルダーの共有から独立している) がまだない場合は、次の手順に従って、Windows を実行しているサーバーにファイル共有を作成します。Server.

> [!NOTE]
> 使用している Windows Server のバージョンによっては、一部の機能が異なる場合や使用できない場合があります。

Windows Server でファイル共有を作成するには、次の手順を実行します。

1. サーバーマネージャーナビゲーションウィンドウで、**ファイルサービスおよび記憶域サービス** を選択し、**共有** を選択して 共有 ページを表示します。
2. 共有 タイルで、**タスク** を選択し、**新しい共有** を選択します。 新しい共有ウィザードが表示されます。
3. **[プロファイルの選択]** ページで、 **[SMB 共有–簡易]** を選択します。 ファイルサーバーリソースマネージャーがインストールされていて、フォルダー管理プロパティを使用している場合は、代わりに **[SMB 共有-詳細設定]** を選択します。
4. **[共有の場所]** ページで、共有を作成するサーバーとボリュームを選択します。
5. **[共有名]** ページで、 **[共有名]** ボックスに共有の名前 ( **User Profiles$** など) を入力します。

    > [!TIP]
    > 共有を作成するときに、共有名の後```$```にを指定して共有を非表示にします。 これにより、共有が通常のブラウザーから非表示になります。

6. **[他の設定]** ページで、 **[継続的可用性を有効にする]** チェック ボックスをオフにし (ある場合)、必要に応じて **[アクセスベースの列挙を有効にする]** および **[データ アクセスの暗号化]** チェック ボックスをオンにします。
7. **[アクセス許可]** ページで、 **[アクセス許可のカスタマイズ]** を選択します。 [セキュリティの詳細設定] ダイアログ ボックスが表示されます。
8. **[継承を無効にする]** を選択し、継承された **[アクセス許可をこのオブジェクトの明示的なアクセス許可に変換]** を選択します。
9. [移動ユーザープロファイルをホストしているファイル共有に対する必要なアクセス](#required-permissions-for-the-file-share-hosting-roaming-user-profiles)許可に関するページの説明に従ってアクセス許可を設定し、次のスクリーンショットに示されているように、一覧にないグループとアカウントのアクセス許可を削除して、移動ユーザーに特別なアクセス許可を追加します。手順 1. で作成したプロファイルユーザーとコンピューターグループ。
    
    ![表1で説明されているアクセス許可を示す [セキュリティの詳細設定] ウィンドウ](media/advanced-security-user-profiles.jpg)
    
    **図 1** 移動ユーザー プロファイル共有のアクセス許可の設定
10. **[SMB 共有 - 高度]** プロファイルを選択した場合、 **[管理プロパティ]** ページで、 **[ユーザー ファイル]** フォルダーの使用法値を選択します。
11. **[SMB 共有 - 高度]** プロファイルを選択した場合、 **[クォータ]** ページで、オプションで共有のユーザーに適用するクォータを選択します。
12. **確認** ページで、作成 を選択し**ます。**

### <a name="required-permissions-for-the-file-share-hosting-roaming-user-profiles"></a>移動ユーザープロファイルをホストしているファイル共有に必要なアクセス許可

| ユーザー アカウント | アクセス | 対象 |
|   -   |   -   |   -   |
|   System    |  フル コントロール     |  このフォルダー、サブフォルダー、およびファイル     |
|  管理者     |  フル コントロール     |  このフォルダーのみ     |
|  作成者/所有者     |  フル コントロール     |  サブフォルダーとファイルのみ     |
| データを共有に置く必要があるユーザーのセキュリティ グループ (Roaming User Profiles Users and Computers)      |  フォルダーの一覧表示/データの読み取り *(高度なアクセス許可)* <br />フォルダーの作成/データの追加 *(高度なアクセス許可)* |  このフォルダーのみ     |
| その他のグループおよびアカウント   |  なし (削除)     |       |

## <a name="step-4-optionally-create-a-gpo-for-roaming-user-profiles"></a>手順 4:オプションで移動ユーザー プロファイルの GPO を作成する

移動ユーザー プロファイル設定用の GPO をまだ作成していない場合、次の手順に従って、移動ユーザー プロファイルに使用する空の GPO を作成します。 この GPO は、移動ユーザー プロファイル設定 (別途説明するプライマリ コンピューターのサポートなど) を構成することができ、さらに、一般に仮想デスクトップ環境内やリモート デスクトップ サービスによって展開する場合に行うように、コンピューターで移動ユーザー プロファイルを有効にするためにも使用できます。

移動ユーザープロファイルの GPO を作成するには、次の手順を実行します。

1. グループ ポリシー管理がインストールされたコンピューターでサーバー マネージャーを開きます。
2. **[ツール]** メニューの **[グループポリシー管理]** を選択します。 グループ ポリシー管理が表示されます。
3. 移動ユーザープロファイルを設定するドメインまたは OU を右クリックし、[**このドメインに GPO を作成し、この**コンテナーにリンクする] を選択します。
4. **[新しい gpo]** ダイアログボックスで、gpo の名前 (**移動ユーザープロファイルの設定**など) を入力し、[ **OK]** を選択します。
5. 新しく作成した GPO を右クリックし、 **[リンクの有効化]** チェックボックスをオフにします。 これにより、GPO の構成が完了するまで、それが適用されるのを防ぎます。
6. GPO を選択します。 **[スコープ]** タブの **[セキュリティフィルター処理]** セクションで、 **[Authenticated Users]** を選択し、 **[削除]** を選択して、GPO がすべてのユーザーに適用されないようにします。
7. **[セキュリティフィルター処理]** セクションで、 **[追加]** を選択します。
8. **[ユーザー、コンピューター、またはグループの選択**] ダイアログボックスで、手順1で作成したセキュリティグループの名前 (たとえば、**移動ユーザープロファイル [ユーザーとコンピューター**]) を入力し、[ **OK]** を選択します。
9. **[委任]** タブを選択し、 **[追加]** を選択して「 **Authenticated Users**」と入力し、 **[ok]** をクリックしてから **[ok]** をもう一度選択して、既定の読み取りアクセス許可を受け入れます。
    
    この手順は[、MS16](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016)でセキュリティが変更されたために必要です。

>[!IMPORTANT]
>[MS16-072A](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016)で加えられたセキュリティの変更により、Authenticated users グループに gpo への読み取りアクセス許可を委任する必要があります。そうしないと、gpo がユーザーに適用されない場合、または gpo が既に適用されている場合は、ユーザープロファイルをリダイレクトします。ローカル PC に対して。 詳細については、「[グループポリシーセキュリティ更新プログラム MS16-072 の展開](https://blogs.technet.microsoft.com/askds/2016/06/22/deploying-group-policy-security-update-ms16-072-kb3163622/)」を参照してください。

## <a name="step-5-optionally-set-up-roaming-user-profiles-on-user-accounts"></a>手順 5:オプションでユーザー アカウントに移動ユーザー プロファイルを設定する

移動ユーザー プロファイルをユーザー アカウントに展開する場合、次の手順を使用して、Active Directory ドメイン サービスでユーザー アカウントに移動ユーザー プロファイルを指定します。 移動ユーザープロファイルをコンピューターに展開する場合は、通常、リモートデスクトップサービスまたは仮想化されたデスクトップ展開の場合と同様[に、代わりに「手順 6:必要に応じて、コンピューター](#step-6-optionally-set-up-roaming-user-profiles-on-computers)に移動ユーザープロファイルを設定します。

> [!NOTE]
> 移動ユーザー プロファイルを Active Directory を使用してユーザー アカウントに設定し、さらにグループ ポリシーを使用してコンピューターに設定した場合、コンピューターベースのポリシー設定が優先されます。

ユーザーアカウントで移動ユーザープロファイルを設定する方法を次に示します。

1. Active Directory 管理者センターで、適切なドメインの **[Users]** コンテナー (または OU) に移動します。
2. 移動ユーザープロファイルを割り当てるすべてのユーザーを選択し、ユーザーを右クリックして、 **[プロパティ]** を選択します。
3. **[プロファイル]** セクションで、 **[プロファイルパス:]** チェックボックスをオンにし、ユーザーの移動ユーザープロファイルを保存するファイル共有へのパスを入力し`%username%`ます (最初のユーザー名に自動的に置き換えられます)。ユーザーがサインインした時刻)。 以下に例を示します。
    
    `\\fs1.corp.contoso.com\User Profiles$\%username%`
    
    必須の移動ユーザープロファイルを指定するには、前の例`fs1.corp.contoso.comUser Profiles$default`で作成した ntuser.dat ファイルへのパスを指定します。 詳細については、「[必須ユーザープロファイルを作成する](https://docs.microsoft.com/windows/client-management/mandatory-user-profile)」を参照してください。
4. **[OK]** を選択します。

> [!NOTE]
> 既定で、移動ユーザー プロファイルを使用する場合、すべての Windows® ランタイムベース (Windows ストア) アプリの展開が許可されます。 ただし、特殊なプロファイルを使用する場合、アプリは既定で展開されません。 特殊なプロファイルは、ユーザーがサインアウトした後に変更が破棄されるユーザー プロファイルです。
> <br><br>特殊なプロファイルのアプリの展開の制限を削除するには、**特殊なプロファイルでの展開操作を許可する**ポリシー設定 (コンピューターの構成\ポリシー\管理用テンプレート\Windows コンポーネント\アプリ パッケージの展開にある) をオンにします。 ただし、このシナリオで展開されたアプリでは、コンピューターに一部のデータが保存されたままになり、単一のコンピューターに数百のユーザーがいる場合に、蓄積される可能性があります。 アプリをクリーンアップするには、コンピューターにプロファイルがなくなったユーザーのために、 [Cleanuppackageforuserasync](https://msdn.microsoft.com/library/windows/apps/windows.management.deployment.packagemanager.cleanuppackageforuserasync.aspx) API を使用してアプリパッケージをクリーンアップするツールを探すか開発します。
> <br><br>Windows ストア アプリの追加の背景情報については、「 [Windows ストアへのクライアント アクセスの管理](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-8.1-and-8/hh832040(v=ws.11)>)」を参照してください。

## <a name="step-6-optionally-set-up-roaming-user-profiles-on-computers"></a>手順 6:オプションでコンピューターに移動ユーザー プロファイルを設定する

一般に、リモート デスクトップ サービスや仮想デスクトップの展開で行われるように、移動ユーザー プロファイルをコンピューターに展開する場合は、次の手順に従います。 移動ユーザープロファイルをユーザーアカウントに展開する場合は、代わりに[「手順 5:必要に応じて、ユーザーアカウント](#step-5-optionally-set-up-roaming-user-profiles-on-user-accounts)に移動ユーザープロファイルを設定します。

グループポリシーを使用すると、Windows 8.1、Windows 8、Windows 7、Windows Vista、Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2、または Windows Server 2008 を実行しているコンピューターに移動ユーザープロファイルを適用できます。

> [!NOTE]
> 移動ユーザー プロファイルをグループ ポリシーを使用してコンピューターに設定し、さらに Active Directory を使用してユーザー アカウントに設定した場合、コンピューターベースのポリシー設定が優先されます。

コンピューターに移動ユーザープロファイルを設定する方法を次に示します。

1. グループ ポリシー管理がインストールされたコンピューターでサーバー マネージャーを開きます。
2. **[ツール]** メニューの **[グループポリシー管理]** を選択します。 グループポリシー管理が表示されます。
3. グループポリシー管理 で、手順 3. で作成した GPO (**移動ユーザープロファイルの設定**など) を右クリックし、**編集** を選択します。
4. グループ ポリシー管理エディター ウィンドウで、**コンピューターの構成**、次に **ポリシー**、次に **管理用テンプレート**、次に **システム**、次に **ユーザー プロファイル** に移動します。
5. **[このコンピューターにログオンしているすべてのユーザーの移動プロファイルパスを設定する]** を右クリックし、 **[編集]** を選択します。
    > [!TIP]
    > ユーザーのホーム フォルダーは、構成されている場合、Windows PowerShell などの一部のプログラムによって使用される既定のフォルダーです。 AD DS のユーザー アカウントのプロパティーの **[ホーム フォルダー]** セクションを使用して、ユーザー単位で、代替のローカルまたはネットワークの場所を構成できます。 仮想デスクトップ環境で Windows 8.1、Windows 8、Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、または Windows Server 2012 を実行しているコンピューターのすべてのユーザーのホームフォルダーの場所を構成するには、[**ユーザーのホームフォルダーを設定**する] を有効にします。ポリシー設定を選択し、ファイル共有とマップするドライブ文字を指定します (またはローカルフォルダーを指定します)。 環境変数や省略記号を使用しないでください。 ユーザーサインオン中に指定されたパスの末尾に、ユーザーのエイリアスが追加されます。
6. **[プロパティ]** ダイアログボックスで、 **[有効]** を選択します。
7. [**このコンピューターにログオン**しているユーザーは、この移動プロファイルのパスを使用する] ボックスに、ユーザーの移動ユーザープロファイルを保存するファイル共有のパスを`%username%`入力します。これには、次のように指定します (ユーザー名に自動的に置き換えられます)。ユーザーが初めてサインインしたとき)。 以下に例を示します。

    `\\fs1.corp.contoso.com\User Profiles$\%username%`

    固定の移動ユーザープロファイルを指定するには (ユーザーがサインアウトしたときに変更がリセットされる) 事前に構成されたプロファイルである場合は、前に作成した Ntuser.dat ファイルへのパスを指定`\\fs1.corp.contoso.com\User Profiles$\default`します。たとえば、のように指定します。 詳細については、「 [Creating a Mandatory User Profile (固定ユーザー プロファイルの作成)](https://docs.microsoft.com/windows/client-management/mandatory-user-profile)」を参照してください。
8. **[OK]** を選択します。

## <a name="step-7-optionally-specify-a-start-layout-for-windows-10-pcs"></a>手順 7:必要に応じて Windows 10 Pc の開始レイアウトを指定する

グループポリシーを使用すると、特定の [スタート] メニューのレイアウトを適用して、ユーザーがすべての Pc で同じスタートレイアウトを表示できるようにすることができます。 ユーザーが複数の PC にサインインし、pc 間で一貫したスタートレイアウトを使用する場合は、GPO がすべての pc に適用されていることを確認してください。

開始レイアウトを指定するには、次の手順を実行します。

1. Windows 10 Pc を Windows 10 バージョン 1607 (記念日更新プログラムとも呼ばれます) 以降に更新し、2017の累積的な更新プログラム ([KB4013429](https://support.microsoft.com/kb/4013429)) またはそれ以降をインストールします。
2. 完全または部分的なスタートメニューのレイアウト XML ファイルを作成します。 これを行うには、「[スタートレイアウトのカスタマイズとエクスポート](https://docs.microsoft.com/windows/configuration/customize-and-export-start-layout)」を参照してください。
    * *完全*なスタートレイアウトを指定した場合、ユーザーは [スタート] メニューのどの部分もカスタマイズできません。 *部分的*なスタートレイアウトを指定すると、ユーザーは、指定したタイルのロックされたグループ以外のすべてのものをカスタマイズできます。 ただし、部分的なスタートレイアウトでは、[スタート] メニューに対するユーザーのカスタマイズは、他の Pc にはローミングしません。
3. グループポリシーを使用して、カスタマイズされたスタートレイアウトを移動ユーザープロファイル用に作成した GPO に適用します。 これを行うには、「グループポリシーを使用して、カスタマイズされ[たスタートレイアウトをドメインに適用する](https://docs.microsoft.com/windows/configuration/customize-windows-10-start-screens-by-using-group-policy#bkmk-domaingpodeployment)」を参照してください。
4. グループポリシーを使用して、Windows 10 Pc で次のレジストリ値を設定します。 これを行うには、「 [Configure a Registry Item](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753092(v=ws.11)>)」を参照してください。

| **操作**   | **Update**                  |
| ------------ | ------------                |
| ［ハイブ］         | **HKEY_LOCAL_MACHINE**      |
| キーのパス     | **Software\Microsoft\Windows\CurrentVersion\Explorer** |
| 値の名前   | **SpecialRoamingOverrideAllowed** |
| [値の型]   | **REG_DWORD**               |
| [値] に   | **1** (無効にする場合は**0** ) |
| 基本         | **位**                 |

5. Optional初回ログオンの最適化を有効にすると、ユーザーによるサインインが高速になります。 これを行うには、「[ポリシーを適用してサインイン時間を向上](https://docs.microsoft.com/windows/client-management/mandatory-user-profile#apply-policies-to-improve-sign-in-time)させる」を参照してください。
6. Optionalクライアント Pc の展開に使用する Windows 10 基本イメージから不要なアプリを削除することで、サインイン時間をさらに短縮します。 Windows Server 2019 および Windows Server 2016 には事前にプロビジョニングされたアプリがないため、サーバーイメージでこの手順をスキップできます。
    - アプリを削除するには、Windows PowerShell の[AppxProvisionedPackage](https://docs.microsoft.com/powershell/module/dism/remove-appxprovisionedpackage?view=win10-ps)コマンドレットを使用して、次のアプリケーションをアンインストールします。 Pc が既に展開されている場合は、 [get-appxpackage](https://docs.microsoft.com/powershell/module/appx/remove-appxpackage?view=win10-ps)を使用してこれらのアプリを削除するスクリプトを作成できます。
    
      - Windowscommunicationsapps\_8wekyb3d8bbwe
      - Microsoft bingweather\_8wekyb3d8bbwe
      - DesktopAppInstaller\_8wekyb3d8bbwe
      - \_8wekyb3d8bbwe
      - 8wekyb3d8bbwe の画像\_
      - WindowsCamera\_8wekyb3d8bbwe
      - Microsoft windowsフィード backhub\_8wekyb3d8bbwe
      - Microsoft windowsstore\_8wekyb3d8bbwe
      - Microsoft. xboxapp\_8wekyb3d8bbwe
      - XboxIdentityProvider\_8wekyb3d8bbwe
      - ZuneMusic\_8wekyb3d8bbwe

>[!NOTE]
>これらのアプリをアンインストールすると、サインイン時間が短縮されますが、展開に必要な場合はインストールしたままにすることができます。

## <a name="step-8-enable-the-roaming-user-profiles-gpo"></a>手順 8:移動ユーザー プロファイル GPO を有効にする

グループ ポリシーを使用して、コンピューターに移動ユーザー プロファイルを設定しているか、グループ ポリシーを使用して、他の移動ユーザー プロファイルをカスタマイズした場合、次の手順は、GPO を有効にし、影響のあるユーザーへの適用を許可することです。

>[!TIP]
>プライマリコンピューターのサポートを実装する予定の場合は、ここで GPO を有効にする前に実行してください。 これにより、プライマリ コンピューターのサポートが有効にされる前に、ユーザー データがプライマリでないコンピューターにコピーされることを防ぎます。 特定のポリシー設定については、「[フォルダーリダイレクトおよび移動ユーザープロファイル用のプライマリコンピューターの展開](deploy-primary-computers.md)」を参照してください。

移動ユーザープロファイル GPO を有効にする方法を次に示します。

1. グループ ポリシーの管理を開きます。
2. 作成した GPO を右クリックし、 **[リンクの有効化]** を選択します。 メニュー項目の横にチェックボックスが表示されます。

## <a name="step-9-test-roaming-user-profiles"></a>手順 9:移動ユーザー プロファイルをテストする

移動ユーザー プロファイルをテストするには、移動ユーザー プロファイル用に構成されたユーザー アカウントでコンピューターにサインインするか、移動ユーザー プロファイル用に構成されたコンピューターにサインインします。 次に、プロファイルがリダイレクトされることを確認します。

移動ユーザープロファイルをテストする方法を次に示します。

1. 移動ユーザー プロファイルを有効にしているユーザー アカウントでプライマリ コンピューターにサインインします (プライマリ コンピューターのサポートを有効にしている場合)。 特定のコンピューターで移動ユーザー プロファイルを有効にしている場合、これらのいずれかのコンピューターにサインインします。
2. ユーザーが以前にコンピューターにサインインしている場合、管理者特権でコマンド プロンプトを開き、次のコマンドを入力して、クライアント コンピューターに最新のグループ ポリシー設定が適用されるようにします。
    
    ```PowerShell
    GpUpdate /Force
    ```
3. ユーザープロファイルがローミングであることを確認するには、**コントロールパネル**を開き、**システムとセキュリティ** を選択し、**システム**、システムの**詳細設定** の順に選択して、ユーザープロファイル セクションの **設定** を選択し、次のように**検索します。** **型**列のローミング。

## <a name="appendix-a-checklist-for-deploying-roaming-user-profiles"></a>付録 A:移動ユーザー プロファイルの展開のチェックリスト

| 状況                     | 操作                                                |
| ---                        | ------                                                |
| ☐<br>☐<br>☐<br>☐<br>☐   | 1. ドメインを準備する<br>-コンピューターをドメインに参加させる<br>-個別のプロファイルバージョンの使用を有効にする<br>-ユーザーアカウントを作成する<br>-(省略可能) フォルダーリダイレクトを展開する |
| ☐<br><br><br>             | 2. 移動ユーザー プロファイルのセキュリティ グループを作成する<br>-グループ名:<br>属する |
| ☐<br><br>                 | 3.移動ユーザー プロファイルのファイル共有を作成する<br>-ファイル共有名: |
| ☐<br><br>                 | 4。移動ユーザー プロファイルの GPO を作成する<br>-GPO 名:|
| ☐                         | 5。移動ユーザー プロファイル ポリシー設定を構成する    |
| ☐<br>☐<br>☐              | 6。移動ユーザープロファイルを有効にする<br>-ユーザーアカウントの AD DS で有効にしますか?<br>-コンピューターアカウントのグループポリシーで有効にしますか?<br> |
| ☐                         | 7.OptionalWindows 10 Pc の必須の開始レイアウトを指定する |
| ☐<br>☐<br><br>☐<br><br>☐ | 8.Optionalプライマリコンピューターのサポートを有効にする<br>-ユーザーのプライマリコンピューターを指定します<br>-ユーザーとプライマリコンピューターのマッピングの場所:<br>-(オプション) フォルダーリダイレクトに対してプライマリコンピューターのサポートを有効にします。<br>-コンピューターベースまたはユーザーベースの場合<br>-(省略可能) 移動ユーザープロファイルのプライマリコンピューターのサポートを有効にします。 |
| ☐                        | 9.移動ユーザー プロファイル GPO を有効にする                |
| ☐                        | 10.移動ユーザー プロファイルをテストする                         |

## <a name="appendix-b-profile-version-reference-information"></a>付録 B:プロファイル バージョン参照情報

各プロファイルには、プロファイルが使用されている Windows のバージョンにほぼ対応するプロファイルバージョンがあります。 たとえば、Windows 10 バージョン1703とバージョン1607では、どちらもを使用します。V6 プロファイルのバージョン。 Microsoft では、互換性を維持するために必要な場合にのみ、新しいプロファイルバージョンを作成します。これは、Windows のすべてのバージョンに新しいプロファイルバージョンが含まれているわけではないためです。

次の表に、各種 Windows バージョンでの移動ユーザー プロファイルの場所を一覧表示します。

| オペレーティング システムのバージョン | 移動ユーザー プロファイルの場所 |
| --- | --- |
| Windows XP と Windows Server 2003 | ```\\<servername>\<fileshare>\<username>``` |
| Windows Vista および Windows Server 2008 | ```\\<servername>\<fileshare>\<username>.V2``` |
| Windows 7 および Windows Server 2008 R2 | ```\\<servername>\<fileshare>\<username>.V2``` |
| Windows 8 と Windows Server 2012 | ```\\<servername>\<fileshare>\<username>.V3```(ソフトウェア更新プログラムとレジストリキーが適用された後)<br>```\\<servername>\<fileshare>\<username>.V2```(ソフトウェアの更新とレジストリキーが適用される前) |
| Windows 8.1 と Windows Server 2012 R2 | ```\\<servername>\<fileshare>\<username>.V4```(ソフトウェア更新プログラムとレジストリキーが適用された後)<br>```\\<servername>\<fileshare>\<username>.V2```(ソフトウェアの更新とレジストリキーが適用される前) |
| Windows 10 | ```\\<servername>\<fileshare>\<username>.V5``` |
| Windows 10 バージョン1703およびバージョン1607 | ```\\<servername>\<fileshare>\<username>.V6``` |

## <a name="appendix-c-working-around-reset-start-menu-layouts-after-upgrades"></a>付録 Cアップグレード後の [スタート] メニューのレイアウトのリセットに関する回避策

ここでは、インプレースアップグレード後にリセットするスタートメニューのレイアウトを回避する方法をいくつか紹介します。

- 1人のユーザーのみがデバイスを使用し、IT 管理者が SCCM などの管理対象 OS 展開戦略を使用している場合は、次の操作を実行できます。
    
  1. アップグレードの前に [スタート] メニューのレイアウトをエクスポート-Startlayout にエクスポートする 
  2. OOBE の後、ユーザーがサインインする前に、[スタート] メニューのレイアウトをインポートします。  
 
     > [!NOTE] 
     > StartLayout をインポートすると、既定のユーザープロファイルが変更されます。 インポート後に作成されたすべてのユーザープロファイルは、インポートされた開始レイアウトを取得します。
 
- IT 管理者は、グループポリシーで開始のレイアウトを管理することを選択できます。 グループポリシーを使用すると、標準化されたスタートレイアウトをユーザーに適用するための一元的な管理ソリューションが提供されます。 開始管理にグループポリシーを使用するモードには、2つのモードがあります。 完全ロックダウンと部分的なロックダウン。 完全ロックダウンのシナリオでは、ユーザーは、開始のレイアウトを変更できません。 部分ロックダウンのシナリオでは、ユーザーが特定の開始領域に変更を加えることができます。 詳細については、「[スタートレイアウトのカスタマイズとエクスポート](https://docs.microsoft.com/windows/configuration/customize-and-export-start-layout)」を参照してください。
        
   > [!NOTE]
   > 部分ロックダウンシナリオでユーザーが行った変更は、アップグレード中も失われます。

- レイアウトのリセットを開始し、エンドユーザーが開始を再構成できるようにします。 通知電子メールまたはその他の通知をエンドユーザーに送信して、OS をアップグレードした後で、影響を最小限に抑えるためにスタートレイアウトがリセットされることを期待できます。 

# <a name="change-history"></a>変更履歴

次の表に、このトピックの最も重要な変更をいくつかまとめています。

| date | 説明 |Reason|
| --- | ---         | ---   |
| 2019年5月1日 | Windows Server 2019 の更新プログラムが追加されました |
| 2018年4月10日 | OS のインプレースアップグレード後にユーザーのカスタマイズを開始するタイミングについての説明が追加されました|コールアウトに関する既知の問題。 |
| 2018年3月13日 | Windows Server 2016 用に更新されました | 以前のバージョンのライブラリから移動し、最新バージョンの Windows Server 用に更新されました。 |
| 2017年4月13日 | Windows 10 バージョン1703のプロファイル情報を追加し、オペレーティングシステムのアップグレード時にローミングプロファイルのバージョンがどのように機能するかを明確にしました。「[複数のバージョンの Windows で移動ユーザープロファイルを使用する場合の考慮事項」を](#considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows)参照してください。 | お客様からのフィードバック。 |
| 2017年3月14日 | 付録 a で[Windows 10 pc の必須の開始レイアウトを指定するための省略可能な手順を追加しました。移動ユーザープロファイル](#appendix-a-checklist-for-deploying-roaming-user-profiles)を展開するためのチェックリスト。 |最新の Windows update での機能の変更。 |
| 2017年1月23日 | 手順 4. に[ステップを追加しました。必要に応じて、移動ユーザープロファイル](#step-4-optionally-create-a-gpo-for-roaming-user-profiles)の GPO を作成し、認証されたユーザーに読み取りアクセス許可を委任します。これは、グループポリシーセキュリティ更新プログラムのために必要になりました。|グループポリシー処理に対するセキュリティの変更。 |
| 2016年12月29日 | 手順 8. で[リンクを追加しました。移動ユーザープロファイル GPO](#step-8-enable-the-roaming-user-profiles-gpo)を有効にすると、プライマリコンピューターのグループポリシーの設定方法に関する情報を簡単に取得できるようになります。 また、番号が間違っていた手順5と6への参照をいくつか修正しました。|お客様からのフィードバック。 |
| 2016年12月5日 | [スタート] メニューの設定のローミングに関する問題を説明する情報を追加しました。 | お客様からのフィードバック。 |
| 2016年7月6日 | 付録 B で Windows 10 プロファイルバージョン[サフィックスを追加しました。プロファイルバージョン参照情報](#appendix-b-profile-version-reference-information)。 また、サポートされているオペレーティングシステムの一覧から、Windows XP および Windows Server 2003 も削除されました。 | Windows の新しいバージョンの更新プログラムと、サポートされなくなった Windows のバージョンに関する情報が削除されました。 |
| 2015 年 7 月 7 日 | クラスター化されたファイル サーバーを使用するときに継続的可用性を無効にする要件と手順を追加しました。 | 継続的可用性が無効になっていると、クラスター化されたファイル共有は小さい書き込み (移動ユーザー プロファイルでは一般的) でのパフォーマンスが向上します。 |
| 2014 年 3 月 19 日 | 大文字のプロファイルバージョンサフィックス (.V2、。V3、。V4) ( [付録 B):プロファイルバージョン参照情報](#appendix-b-profile-version-reference-information)。 | Windows では大文字と小文字が区別されませんが、ファイル共有で NFS を使用する場合は、プロファイルサフィックスに正しい (大文字) 大文字小文字を使用することが重要です。 |
| 2013 年 10 月 9 日 | Windows Server 2012 R2 および Windows 8.1 用に改訂され、いくつかのことを明確にし、 [[複数のバージョンの windows および付録 B で移動ユーザープロファイルを使用する場合の考慮事項](#considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows)を追加しました。プロファイルバージョン参照情報](#appendix-b-profile-version-reference-information)のセクション。 | 新しいバージョンの更新プログラムお客様からのフィードバック。 |

## <a name="more-information"></a>詳細情報

- [フォルダーリダイレクト、オフラインファイル、移動ユーザープロファイルを展開する](deploy-folder-redirection.md)
- [フォルダーリダイレクトと移動ユーザープロファイルのプライマリコンピューターを展開する](deploy-primary-computers.md)
- [ユーザー状態管理の実装](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc784645(v=ws.10)>)
- [レプリケートされたユーザープロファイルデータに関するマイクロソフトのサポート声明](https://blogs.technet.microsoft.com/askds/2010/09/01/microsofts-support-statement-around-replicated-user-profile-data/)
- [DISM を使用したアプリのサイドロード](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-8.1-and-8/hh852635(v=win.10)>)
- [Windows ランタイムベースのアプリのパッケージ化、配置、およびクエリのトラブルシューティング](https://msdn.microsoft.com/library/windows/desktop/hh973484.aspx)