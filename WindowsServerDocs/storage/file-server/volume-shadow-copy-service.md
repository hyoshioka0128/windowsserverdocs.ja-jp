---
title: ボリューム シャドウ コピー サービス
ms.date: 01/30/2019
ms.prod: windows-server
ms.technology: storage
author: JasonGerend
manager: elizapo
ms.author: jgerend
ms.openlocfilehash: d90030fe183e5cfcb94866e87793c0419b636433
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2020
ms.locfileid: "85475449"
---
# <a name="volume-shadow-copy-service"></a>ボリューム シャドウ コピー サービス

適用先:Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2、Windows Server 2008、Windows 10、Windows 8.1、Windows 8、Windows 7

重要なビジネス データのバックアップと復元は、次のような問題が原因で非常に複雑になる可能性があります。

  - データは通常、そのデータを生成するアプリケーションがまだ実行されている間にバックアップする必要がある。 これは、一部のデータ ファイルが開いているか、一貫性のない状態になっている可能性があることを意味します。

  - データ セットが大きい場合、一度にすべてをバックアップするのが困難な場合がある。


バックアップと復元の操作を適切に実行するには、バックアップ アプリケーション、バックアップする基幹業務アプリケーション、および記憶域管理のハードウェアとソフトウェアの間で、密接な連携が必要です。 Windows Server®2003 で導入されたボリューム シャドウ コピー サービス (VSS) を使用すると、これらのコンポーネント間の会話を容易にし、連携を高めることができます。 すべてのコンポーネントで VSS がサポートされている場合は、アプリケーションをオフラインにしなくても、それらを使用してアプリケーション データをバックアップできます。

VSS では、バックアップするデータの一貫したシャドウ コピー (スナップショットまたは特定の時点のコピーとも呼ばれます) を作成するために必要なアクションが調整されます。 シャドウ コピーはそのまま使用することも、次のようなシナリオで使用することもできます。

  - 別のハード ディスク ドライブ、テープ、またはその他のリムーバブル メディアへのデータのアーカイブを含め、アプリケーション データとシステム状態の情報をバックアップする必要がある。

  - データ マイニングを行っている。

  - ディスクからディスクへのバックアップを実行している。

  - 元の LUN にデータを復元するか、障害が発生した元の LUN を置き換える完全に新しい LUN にデータを復元することにより、データ損失から迅速に回復する必要がある。


VSS を使用する Windows の機能とアプリケーションには、次のものが含まれます。

  - [Windows Server バックアップ](https://go.microsoft.com/fwlink/?linkid=180891) (https://go.microsoft.com/fwlink/?LinkId=180891)

  - [共有フォルダーのシャドウ コピー](https://go.microsoft.com/fwlink/?linkid=142874) (https://go.microsoft.com/fwlink/?LinkId=142874)

  - [System Center Data Protection Manager](https://go.microsoft.com/fwlink/?linkid=180892) (https://go.microsoft.com/fwlink/?LinkId=180892)

  - [システムの復元](https://go.microsoft.com/fwlink/?linkid=180893) (https://go.microsoft.com/fwlink/?LinkId=180893)


## <a name="how-volume-shadow-copy-service-works"></a>ボリューム シャドウ コピー サービスの仕組み

完全な VSS ソリューションには、次の基本部分がすべて必要です。

**VSS サービス**   他のコンポーネントが互いに正しく通信して連携できるようにする、Windows オペレーティング システムの一部です。

**VSS リクエスター**   シャドウ コピーの実際の作成を要求するソフトウェア (または、インポートや削除などの他の高レベルの操作)。 通常、これはバックアップ アプリケーションです。 Windows Server バックアップ ユーティリティと System Center Data Protection Manager アプリケーションは、VSS リクエスターです。 Microsoft® 以外の VSS リクエスターには、Windows で実行されるほとんどすべてのバックアップ ソフトウェアが含まれます。

**VSS ライター**   バックアップするための一貫性のあるデータ セットがあることを保証するコンポーネント。 これは通常、SQL Server® や Exchange Server などの基幹業務アプリケーションの一部として提供されます。 Windows オペレーティング システムには、レジストリなどのさまざまな Windows コンポーネントの VSS ライターが含まれています。 Microsoft 以外の VSS ライターは、バックアップ中のデータの整合性を保証する必要がある Windows 用の多くのアプリケーションに含まれています。

**VSS プロバイダー**   シャドウ コピーを作成して維持するコンポーネント。 これは、ソフトウェアまたはハードウェアで発生する可能性があります。 Windows オペレーティング システムには、コピー オン ライトを使用する VSS プロバイダーが含まれています。 記憶域ネットワーク (SAN) を使用する場合は、SAN の VSS ハードウェア プロバイダーが提供されている場合は、それをインストールすることが重要です。 ハードウェア プロバイダーにより、シャドウ コピーを作成して維持するタスクがホスト オペレーティング システムからオフロードされます。

次の図は、VSS サービスがリクエスター、ライター、およびプロバイダーと連携してボリュームのシャドウ コピーを作成する方法を示しています。

![](media/volume-shadow-copy-service/Ee923636.94dfb91e-8fc9-47c6-abc6-b96077196741(WS.10).jpg)

**図 1**   ボリューム シャドウ コピー サービスのアーキテクチャ図

### <a name="how-a-shadow-copy-is-created"></a>シャドウ コピーの作成方法

このセクションでは、シャドウ コピーの作成に必要な手順をリストすることにより、リクエスター、ライター、およびプロバイダーのさまざまなロールをコンテキストで示します。 次の図は、ボリューム シャドウ コピー サービスでリクエスター、ライター、およびプロバイダーの全体的な調整を制御する方法を示しています。

![](media/volume-shadow-copy-service/Ee923636.1c481a14-d6bc-4796-a3ff-8c6e2174749b(WS.10).jpg)

**図 2** シャドウ コピーの作成プロセス

シャドウ コピーを作成するために、リクエスター、ライター、およびプロバイダーは、次の操作を実行します。

1.  リクエスターは、ライターを列挙し、ライター メタデータを収集し、シャドウ コピーの作成を準備するようにボリューム シャドウ コピー サービスに要求します。

2.  各ライターは、バックアップする必要があるコンポーネントとデータ ストアの XML 記述を作成し、ボリューム シャドウ コピー サービスに提供します。 また、ライターは、すべてのコンポーネントで使用される復元メソッドも定義します。 ボリューム シャドウ コピー サービスは、ライターの記述をリクエスターに提供し、それがバックアップするコンポーネントを選択します。

3.  ボリューム シャドウ コピー サービスは、すべてのライターに対して、シャドウ コピーを作成するためのデータを準備するように通知します。

4.  各ライターは、すべての開いているトランザクションの完了、トランザクション ログのローリング、キャッシュのフラッシュなど、必要に応じてデータを準備します。 データをシャドウ コピーする準備ができたら、ライターはボリューム シャドウ コピー サービスに通知します。

5.  ボリューム シャドウ コピー サービスは、ボリューム (1 つまたは複数) のシャドウ コピーの作成に必要な数秒間、アプリケーションの書き込み I/O 要求を一時的に凍結するようライターに指示します (読み取り I/O 要求は引き続き可能)。 アプリケーションの凍結は、60 秒より長くかかることは許されません。 ボリューム シャドウ コピー サービスは、ファイル システムのバッファーをフラッシュし、ファイル システムを凍結します。これにより、ファイル システムのメタデータが正しく記録され、シャドウ コピーされるデータが一貫性のある順序で書き込まれます。

6.  ボリューム シャドウ コピー サービスは、シャドウ コピーを作成するようにプロバイダーに指示します。 シャドウ コピーの作成期間は 10 秒以内で、その間、ファイル システムへの書き込み I/O 要求はすべて凍結されたままになります。

7.  ボリューム シャドウ コピー サービスは、ファイル システムの書き込み I/O 要求を解放します。

8.  VSS は、アプリケーション書き込み I/O 要求の解凍をライターに指示します。 この時点で、アプリケーションは、シャドウ コピーされているディスクにデータの書き込みを再開することができます。


> [!NOTE]
> ライターが 60 秒より長く凍結状態で保持されている場合、またはプロバイダーがシャドウ コピーのコミットに 10 秒以上かかる場合は、シャドウ コピーの作成を中止できます。
<br>

9. リクエスターは、プロセスを再試行する (手順 1 に戻る) か、後で再試行するよう管理者に通知することができます。

10. シャドウ コピーが正常に作成された場合、ボリューム シャドウ コピー サービスによって、リクエスターにシャドウ コピーの場所情報が返されます。 場合によっては、シャドウ コピーが完了する前に VSS と 1 つ以上のアプリケーションでシャドウ コピーの内容を変更できるように、シャドウ コピーを読み取り/書き込みボリュームとして一時的に利用可能にすることができます。 VSS とアプリケーションが変更を行った後、シャドウ コピーは読み取り専用になります。 このフェーズは自動回復と呼ばれ、シャドウ コピーが作成される前に完了しなかったシャドウ コピー ボリューム上のファイル システムまたはアプリケーションのトランザクションを元に戻すために使用されます。


### <a name="how-the-provider-creates-a-shadow-copy"></a>プロバイダーがシャドウ コピーを作成する方法

ハードウェアまたはソフトウェアのシャドウ コピー プロバイダーは、次のいずれかの方法でシャドウ コピーを作成します。

**完全なコピー**   この方法では、特定の時点での元のボリュームの完全なコピー ("完全コピー" または "複製" と呼ばれます) が作成されます。 このコピーは読み取り専用です。

**コピー オン ライト**   この方法では、元のボリュームはコピーされません。 代わりに、特定の時点以降にボリュームに対して行われたすべての変更 (完了した書き込み I/O 要求) をコピーして差分コピーが作成されます。

**リダイレクト オン ライト**   この方法では、元のボリュームはコピーされません。また、特定の時点以降は元のボリュームに変更は加えられません。 代わりに、すべての変更を別のボリュームにリダイレクトすることで、差分コピーが作成されます。

## <a name="complete-copy"></a>完全なコピー

完全なコピーは、通常、次のように "分割ミラー" を作成することによって作成されます。

1. 元のボリュームとシャドウ コピー ボリュームは、ミラー化されたボリューム セットです。

2. シャドウ コピー ボリュームは、元のボリュームから分離されます。 これにより、ミラー接続が切断されます。


ミラー接続が切断された後、元のボリュームとシャドウ コピー ボリュームは独立しています。 元のボリュームでは、すべての変更 (書き込み I/O 要求) が引き続き受け入れられますが、シャドウ コピー ボリュームは、中断時の元のデータの読み取り専用の正確なコピーのままとなります。

### <a name="copy-on-write-method"></a>コピー オン ライト方式

コピー オン ライト方式では、元のボリュームに対する変更が発生したとき (ただし、書き込み I/O 要求が完了する前) に、変更される各ブロックが読み取られ、ボリュームのシャドウ コピー記憶域 ("差分領域" とも呼ばれます) に書き込まれます。 シャドウ コピー記憶域は、同じボリュームまたは別のボリュームに配置できます。 これにより、変更によって上書きされる前に、元のボリュームのデータ ブロックのコピーが保持されます。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>時間</th>
<th>ソース データ (状態とデータ)</th>
<th>シャドウ コピー (状態とデータ)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>元のデータ:1 2 3 4 5</p></td>
<td><p>コピーなし: —</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>キャッシュ内のデータが変更される:3 から 3'</p></td>
<td><p>シャドウ コピーが作成される (差分のみ):3</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>元のデータが上書きされる:1 2 3' 4 5</p></td>
<td><p>差分とインデックスがシャドウ コピーに保管される:3</p></td>
</tr>
</tbody>
</table>

**表 1**   シャドウ コピーを作成するコピー オン ライト方式

コピー オン ライト方式では、変更されたデータのみがコピーされるため、シャドウ コピーを簡単に作成できます。 差分領域内のコピーされたブロックを、元のボリューム上の変更されたデータと組み合わせて、変更が行われる前の状態にボリュームを復元することができます。 変更の量が多い場合、コピー オン ライト方式はコストが高くなる可能性があります。

### <a name="redirect-on-write-method"></a>リダイレクト オン ライト方式

リダイレクト オン ライト方式では、元のボリュームが変更 (書き込み I/O 要求) を受信するたびに変更が元のボリュームに適用されることはありません。 代わりに、変更は別のボリュームのシャドウ コピー記憶域に書き込まれます。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>時間</th>
<th>ソース データ (状態とデータ)</th>
<th>シャドウ コピー (状態とデータ)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>元のデータ:1 2 3 4 5</p></td>
<td><p>コピーなし: —</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>キャッシュ内のデータが変更される:3 から 3'</p></td>
<td><p>シャドウ コピーが作成される (差分のみ):3'</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>元のデータは変更されない:1 2 3 4 5</p></td>
<td><p>差分とインデックスがシャドウ コピーに保管される:3'</p></td>
</tr>
</tbody>
</table>

**表 2**   シャドウ コピーを作成するリダイレクト オン ライト方式

コピー オン ライト方式と同様に、リダイレクト オン ライト方式では、データに対する変更のみがコピーされるため、シャドウ コピーを簡単に作成できます。 差分領域内のコピーされたブロックを、元のボリューム上の変更されていないデータと組み合わせて、データの完全な最新コピーを作成できます。 読み取り I/O 要求が多数ある場合は、リダイレクト オン ライト方式はコストが高くなる可能性があります。

## <a name="shadow-copy-providers"></a>シャドウ コピー プロバイダー

シャドウ コピー プロバイダーには、ハードウェア ベースのプロバイダーとソフトウェア ベースのプロバイダーの 2 種類があります。 また、システム プロバイダーもあります。これは、Windows オペレーティングシステムに組み込まれているソフトウェア プロバイダーです。

### <a name="hardware-based-providers"></a>ハードウェア ベースのプロバイダー

ハードウェア ベースのシャドウ コピー プロバイダーは、ハードウェア ストレージ アダプターまたはコントローラーと連携して動作することによって、ボリューム シャドウ コピー サービスとハードウェア レベルの間のインターフェイスとして機能します。 シャドウ コピーの作成と保守の作業は、ストレージ アレイによって実行されます。

ハードウェア プロバイダーは常に LUN 全体のシャドウ コピーを取得しますが、ボリューム シャドウ コピー サービスは、要求されたボリュームのシャドウ コピーのみを公開します。

ハードウェア ベースのシャドウ コピー プロバイダーは、特定の時点を定義し、データの同期を可能にし、シャドウ コピーを管理し、バックアップ アプリケーションとの共通のインターフェイスを提供する、ボリューム シャドウ コピー サービスの機能を利用します。 ただし、ボリューム シャドウ コピー サービスでは、ハードウェア ベースのプロバイダーによるシャドウ コピーの生成と保持に使用される、基になるメカニズムは指定されません。

### <a name="software-based-providers"></a>ソフトウェア ベースのプロバイダー

ソフトウェア ベースのシャドウ コピー プロバイダーは通常、ファイル システムとボリューム マネージャー ソフトウェア間のソフトウェア レイヤーでの読み取りおよび書き込みの I/O 要求をインターセプトして処理します。

これらのプロバイダーは、ユーザーモードの DLL コンポーネントと少なくとも 1 つのカーネルモードのデバイス ドライバー (通常はストレージ フィルター ドライバー) として実装されます。 ハードウェア ベースのプロバイダーとは異なり、ソフトウェア ベースのプロバイダーは、ハードウェア レベルではなく、ソフトウェア レベルでシャドウ コピーを作成します。

ソフトウェア ベースのシャドウ コピー プロバイダーは、シャドウ コピーの作成時間前のボリュームの状態を再作成するために使用できるデータ セットにアクセスすることによって、ボリュームの "特定の時点" のビューを維持する必要があります。 例として、システム プロバイダーのコピー オン ライト手法があります。 ただし、ボリューム シャドウ コピー サービスでは、ソフトウェア ベースのプロバイダーがシャドウ コピーの作成と管理に使用する技法に制限はありません。

ソフトウェア プロバイダーは、ハードウェア ベースのプロバイダーよりも広範なストレージ プラットフォームに適用されます。また、ベーシック ディスクや論理ボリュームでも同様に機能します。 (論理ボリュームは、2 つ以上のディスクの空き領域を組み合わせることによって作成されるボリュームです)。ハードウェア シャドウ コピーとは対照的に、ソフトウェア プロバイダーは、オペレーティング システムのリソースを使用してシャドウ コピーを保持します。

ベーシック ディスクの詳細については、TechNet の「[ベーシック ディスクとボリュームとは](https://go.microsoft.com/fwlink/?linkid=180894)」 (https://go.microsoft.com/fwlink/?LinkId=180894) を参照してください。

### <a name="system-provider"></a>システム プロバイダー

Windows オペレーティング システムでは、1 つのシャドウ コピー プロバイダー (システム プロバイダー) が提供されています。 Windows では既定のプロバイダーが提供されていますが、他のベンダーは、ストレージ ハードウェアおよびソフトウェア アプリケーション用に最適化された実装を自由に提供できます。

シャドウ コピーに含まれているボリュームの "特定の時点" のビューを維持するために、システム プロバイダーはコピー オン ライト手法を使用します。 シャドウ コピーの作成開始以降に変更されたボリューム上のブロックのコピーは、シャドウ コピーの記憶域に格納されます。

システム プロバイダーは運用ボリュームを公開できます。これは、通常どおりに書き込みや読み取りができます。 シャドウ コピーが必要な場合は、運用ボリューム上のデータに差分を論理的に適用して、完全なシャドウ コピーを公開します。

システム プロバイダーの場合、シャドウ コピーの記憶域は NTFS ボリューム上にある必要があります。 シャドウ コピーするボリュームは、NTFS ボリュームである必要はありませんが、システムにマウントされたボリュームの少なくとも 1 つが NTFS ボリュームである必要があります。

システム プロバイダーを構成するコンポーネント ファイルは、swprv.dll と volsnap.sys です。

### <a name="in-box-vss-writers"></a>インボックス VSS ライター

Windows オペレーティング システムには、さまざまな Windows 機能で必要なデータを列挙する役割を果たす VSS ライターのセットが含まれています。

これらのライターの詳細については、以下の Microsoft Docs Web ページを参照してください。

- [インボックス VSS ライター](https://docs.microsoft.com/windows/win32/vss/in-box-vss-writers) (https://docs.microsoft.com/windows/win32/vss/in-box-vss-writers)


## <a name="how-shadow-copies-are-used"></a>シャドウ コピーの使用方法

シャドウ コピーは、アプリケーション データとシステム状態情報のバックアップに加えて、次のようなさまざまな目的で使用できます。

  - LUN の復元 (LUN の再同期と LUN スワップ)

  - 個々のファイルの復元 (共有フォルダーのシャドウ コピー)

  - 転送可能シャドウ コピーを使用したデータ マイニング


### <a name="restoring-luns-lun-resynchronization-and-lun-swapping"></a>LUN の復元 (LUN の再同期と LUN スワップ)

Windows Server 2008 R2 および Windows 7 では、VSS リクエスターは、LUN 再同期と呼ばれるハードウェア シャドウ コピー プロバイダーの機能を使用できます。 これは、アプリケーション管理者がシャドウ コピーから元の LUN または新しい LUN にデータを復元できるようにする、高速回復スキームです。

シャドウ コピーは、完全な複製または差分シャドウ コピーにすることができます。 どちらの場合も、再同期操作の終了時に、コピー先 LUN のコンテンツはシャドウ コピー LUN と同じになります。 再同期操作中、アレイはシャドウ コピーからコピー先の LUN へのブロックレベルのコピーを実行します。


> [!NOTE]
> シャドウ コピーは、転送可能なハードウェア シャドウ コピーである必要があります。
<br>


ほとんどのアレイでは、再同期操作の開始直後に実稼働 I/O 操作を再開できます。 再同期操作の実行中、読み取り要求はシャドウ コピー LUN にリダイレクトされ、書き込み要求はコピー先の LUN にリダイレクトされます。 これにより、アレイは非常に大きなデータセットを復旧し、数秒で通常の操作を再開できます。

LUN の再同期は、LUN スワップとは異なります。 LUN スワップは、Windows Server 2003 SP1 以降に VSS でサポートされる高速回復シナリオです。 LUN スワップでは、シャドウ コピーがインポートされ、読み取り/書き込みボリュームに変換されます。 変換は元に戻すことができない操作であり、その後、ボリュームと基になる LUN を VSS API で制御することはできません。 次のリストでは、LUN の再同期と LUN スワップの比較について説明します。

  - LUN の再同期では、シャドウ コピーは変更されないため、複数回使用できます。 LUN スワップでは、シャドウ コピーを回復のために 1 回のみ使用できます。 安全性を重要視するほとんどの管理者にとって、これは重要です。 LUN の再同期を使用すると、最初に何らかの問題が発生した場合に、リクエスターが復元操作全体を再試行できます。

  - LUN スワップの最後に、シャドウ コピー LUN が実稼働 I/O 要求に使用されます。 このため、シャドウ コピー LUN では、回復操作後にパフォーマンスが影響を受けないように、元の実稼働 LUN と同じ品質の記憶域を使用する必要があります。 代わりに LUN の再同期が使用されている場合、ハードウェア プロバイダーは、実稼働品質の記憶域よりも安価な記憶域にシャドウ コピーを保持できます。

  - コピー先の LUN が使用できず、再作成が必要な場合、LUN のスワップは、コピー先の LUN を必要としないため、より経済的になる可能性があります。


> [!WARNING]
> リストされているすべての操作は、LUN レベルの操作です。 LUN の再同期を使用して特定のボリュームを回復しようとすると、LUN を共有している他のすべてのボリュームが元に戻されます。
<br>


### <a name="restoring-individual-files-shadow-copies-for-shared-folders"></a>個々のファイルの復元 (共有フォルダーのシャドウ コピー)

共有フォルダーのシャドウ コピーでは、ボリューム シャドウ コピー サービスを使用して、ファイル サーバーなどの共有ネットワーク リソースに配置されているファイルの特定の時点のコピーが提供されます。 共有フォルダーのシャドウ コピーを使用すると、ネットワークに保存されている削除または変更されたファイルを迅速に回復できます。 管理者の支援なしで実行できるため、共有フォルダーのシャドウ コピーによって生産性が向上し、管理コストが削減されます。

共有フォルダーのシャドウ コピーの詳細については、TechNet の「[共有フォルダーのシャドウ コピー](https://go.microsoft.com/fwlink/?linkid=180898)」 (https://go.microsoft.com/fwlink/?LinkId=180898) を参照してください。

### <a name="data-mining-by-using-transportable-shadow-copies"></a>転送可能シャドウ コピーを使用したデータ マイニング

ボリューム シャドウ コピー サービスと共に使用するように設計されたハードウェア プロバイダーを使用すると、同じサブシステム内のサーバー (SAN など) にインポートできる、転送可能なシャドウ コピーを作成できます。 これらのシャドウ コピーを使用すると、データ マイニング用の読み取り専用データを使用して、運用環境またはテスト環境のインストールをシードすることができます。

ボリューム シャドウ コピー サービスと、ボリューム シャドウ コピー サービスで使用するように設計されたハードウェア プロバイダーを持つストレージ アレイでは、1 台のサーバーにソース データ ボリュームのシャドウ コピーを作成してから、そのシャドウ コピーを別のサーバーにインポートする (または同じサーバーに戻す) ことができます。 データのサイズに関係なく、このプロセスは数分で完了します。 トランスポート プロセスは、転送可能なシャドウ コピーをサポートするシャドウ コピー リクエスター (記憶域管理アプリケーション) を使用する一連の手順によって実現されます。

## <a name="to-transport-a-shadow-copy"></a>シャドウ コピーを転送するには

1.  サーバー上のソース データの転送可能なシャドウ コピーを作成します。

2.  SAN に接続されているサーバーにシャドウ コピーをインポートします (別のサーバーまたは同じサーバーにインポートできます)。

3.  これで、データを使用する準備ができました。

![](media/volume-shadow-copy-service/Ee923636.633752e0-92f6-49a7-9348-f451b1dc0ed7(WS.10).jpg)

**図 3**   シャドウコピーの作成と 2 つのサーバー間での転送


> [!NOTE]
> Windows Server 2003 に作成された転送可能なシャドウ コピーは、Windows Server 2008 または Windows Server 2008 R2 を実行しているサーバーにインポートすることはできません。 Windows server 2008 または Windows Server 2008 R2 に作成された転送可能なシャドウコピーは、Windows Server 2003 を実行しているサーバーにインポートすることはできません。 ただし、Windows Server 2008 に作成された転送可能なシャドウ コピーは、Windows Server 2008 R2 を実行しているサーバーにインポートすることができ、またその逆も可能です。
<br>


シャドウ コピーは読み取り専用です。 シャドウ コピーを読み取り/書き込み LUN に変換する場合は、ボリューム シャドウ コピー サービスに加えて、仮想ディスク サービス ベースの記憶域管理アプリケーション (一部のリクエスターも含む) を使用できます。 このアプリケーションを使用すると、ボリューム シャドウ コピー サービス管理からシャドウ コピーを削除して、読み取り/書き込み LUN に変換することができます。

ボリューム シャドウ コピー サービス トランスポートは、Windows Server 2003 Enterprise Edition、Windows Server 2003 Datacenter Edition、Windows Server 2008、または Windows Server 2008 R2 を実行しているコンピューターの高度なソリューションです。 これはストレージ アレイにハードウェア プロバイダーがある場合にのみ機能します。 シャドウ コピー トランスポートは、テープ バックアップ、データ マイニング、テストなど、さまざまな目的で使用できます。

## <a name="frequently-asked-questions"></a>よく寄せられる質問

この FAQ では、ボリューム シャドウ コピー サービス (VSS) に関するシステム管理者向けの質問に回答します。 VSS アプリケーション プログラミング インターフェイスの詳細については、Windows デベロッパー センター ライブラリの「[ボリューム シャドウ コピー サービス](https://go.microsoft.com/fwlink/?linkid=180899)」 (https://go.microsoft.com/fwlink/?LinkId=180899) を参照してください。

### <a name="when-was-volume-shadow-copy-service-introduced-on-which-windows-operating-system-versions-is-it-available"></a>ボリューム シャドウ コピー サービスが導入されたのはいつですか? どの Windows オペレーティング システムのバージョンで利用可能ですか?

VSS は Windows XP で導入されました。 Windows XP、Windows Server 2003､Windows Vista®､Windows Server 2008､Windows 7､Windows Server 2008 R2 で使用可能です。

### <a name="what-is-the-difference-between-a-shadow-copy-and-a-backup"></a>シャドウ コピーとバックアップの違いは何ですか?

ハード ディスク ドライブのバックアップの場合は、作成されたシャドウ コピーはバックアップでもあります。 復元用にシャドウ コピーからデータをコピーすることも、シャドウ コピーを高速回復のシナリオ (LUN の再同期や LUN スワップなど) で使用することもできます。

シャドウ コピーからテープまたはその他のリムーバブル メディアにデータをコピーすると、メディアに格納されたコンテンツによってバックアップが構成されます。 シャドウ コピー自体は、データがコピーされた後で削除できます。

### <a name="what-is-the-largest-size-volume-that-volume-shadow-copy-service-supports"></a>ボリューム シャドウ コピー サービスでサポートされるボリュームの最大サイズはいくつですか?

ボリューム シャドウ コピー サービスは、最大 64 TB のボリューム サイズをサポートしています。

### <a name="i-made-a-backup-on-windows-server2008-can-i-restore-it-on-windows-server2008r2"></a>Windows Server 2008 でバックアップを作成しました。 Windows Server 2008 R2 で復元することはできますか?

これは、使用したバックアップ ソフトウェアによって異なります。 ほとんどのバックアップ プログラムでは、データについてこのシナリオがサポートされまが、システム状態のバックアップについてはサポートされません。

これらのいずれかのバージョンの Windows で作成されたシャドウ コピーは、もう一方でも使用できます。

### <a name="i-made-a-backup-on-windows-server2003-can-i-restore-it-on-windows-server2008"></a>Windows Server 2003 でバックアップを作成しました。 Windows Server 2008 で復元することはできますか?

これは、使用したバックアップ ソフトウェアによって異なります。 Windows Server 2003 でシャドウ コピーを作成した場合、Windows Server 2008 で使用することはできません。 また、Windows Server 2008 でシャドウ コピーを作成した場合、それを Windows Server 2003 で復元することはできません。

### <a name="how-can-i-disable-vss"></a>VSS を無効にするにはどうすればよいですか?

Microsoft 管理コンソールを使用して、ボリューム シャドウ コピー サービスを無効にすることができます。 ただし、これは行わないでください。 VSS を無効にすると、これに依存する、システムの復元や Windows Server バックアップなど、使用するソフトウェアに悪影響が及びます。

詳細については、次の Microsoft TechNet Web サイトを参照してください。

- [システムの復元](https://go.microsoft.com/fwlink/?linkid=157113) (https://go.microsoft.com/fwlink/?LinkID=157113)

- [Windows Server バックアップ](https://go.microsoft.com/fwlink/?linkid=180891) (https://go.microsoft.com/fwlink/?LinkID=180891)


### <a name="can-i-exclude-files-from-a-shadow-copy-to-save-space"></a>シャドウ コピーからファイルを除外して領域を節約することはできますか?

VSS は、ボリューム全体のシャドウ コピーを作成するように設計されています。 ページング ファイルなどの一時ファイルは、領域を節約するために、シャドウ コピーから自動的に除外されます。

シャドウ コピーから特定のファイルを除外するには、次のレジストリ キーを使用します。**FilesNotToSnapshot**。


> [!NOTE]
> <STRONG>FilesNotToSnapshot</STRONG> レジストリ キーは、アプリケーションによってのみ使用されることが想定されています。 これを使用しようとするユーザーには、次のような制限が課されます。
> <br>
> <UL>
> <LI>以前のバージョンの機能を使用して、Windows Server 上で作成されたシャドウ コピーからファイルを削除することはできません。<BR><BR>
> <LI>共有フォルダーのシャドウ コピーからファイルを削除することはできません。<BR><BR>
> <LI><a href="https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow" data-raw-source="[Diskshadow](https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow)">Diskshadow</a> ユーティリティを使用して作成されたシャドウ コピーからファイルを削除することはできますが、<a href="https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin" data-raw-source="[Vssadmin](https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin)">Vssadmin</a> ユーティリティを使用して作成されたシャドウ コピーからファイルを削除することはできません。<BR><BR>
> <LI>ファイルは、ベストエフォート方式でシャドウ コピーから削除されます。 つまり、削除されることは保証されていません。<BR><BR></LI></UL>


詳細については、MSDN の「[シャドウ コピーからファイルを除外する](https://go.microsoft.com/fwlink/?linkid=180904)」 (https://go.microsoft.com/fwlink/?LinkId=180904) を参照してください。

### <a name="my-non-microsoft-backup-program-failed-with-a-vss-error-what-can-i-do"></a>Microsoft 以外のバックアップ プログラムが VSS エラーのために失敗しました。 どうすればよいですか?

バックアップ プログラムを作成した会社の Web サイトの製品サポート セクションを確認してください。 この問題を解決するためにダウンロードしてインストールできる製品の更新プログラムがある可能性があります。 そうでない場合は、会社の製品サポート部門にお問い合わせください。

システム管理者は、次の Microsoft TechNet ライブラリ Web サイトにある VSS のトラブルシューティング情報を使用して、VSS 関連の問題に関する診断情報を収集できます。

詳細については、TechNet の「[ボリューム シャドウ コピー サービス](https://go.microsoft.com/fwlink/?linkid=180905)」 (https://go.microsoft.com/fwlink/?LinkId=180905) を参照してください。

### <a name="what-is-the-diff-area"></a>"差分領域" とは何ですか?

シャドウ コピーの記憶域 (または "差分領域") は、システム ソフトウェア プロバイダーによって作成されたシャドウ コピーのデータが格納される場所です。

### <a name="where-is-the-diff-area-located"></a>差分領域はどこにありますか?

差分領域は、任意のローカル ボリュームに配置できます。 ただし、それを格納するのに十分な領域がある NTFS ボリュームに配置する必要があります。

### <a name="how-is-the-diff-area-location-determined"></a>差分領域の場所はどのように決定されますか?

次の条件がこの順序で評価され、差分領域の場所が決定されます。

  - ボリュームに既存のシャドウ コピーが既に存在する場合は、その場所が使用されます。

  - 元のボリュームとシャドウ コピー ボリュームの場所の間に事前に構成された手動の関連付けがある場合は、その場所が使用されます。

  - 前の 2 つの条件で場所が決定されない場合、シャドウ コピー サービスは使用可能な空き領域に基づいて場所を選択します。 複数のボリュームがシャドウ コピーされている場合、シャドウ コピー サービスは、空き領域のサイズに基づいて、使用可能なスナップショットの場所の一覧を降順で作成します。 指定された場所の数は、シャドウ コピーされているボリュームの数と同じです。

  - シャドウ コピー対象のボリュームが、可能な場所の 1 つである場合は、ローカルの関連付けが作成されます。 それ以外の場合は、使用可能な領域が最も多いボリュームとの関連付けが作成されます。


### <a name="can-vss-create-shadow-copies-of-non-ntfs-volumes"></a>VSS では、NTFS 以外のボリュームのシャドウ コピーを作成できますか?

はい。 ただし、永続的なシャドウ コピーは NTFS ボリュームに対してのみ作成できます。 また、システムにマウントされた少なくとも 1 つのボリュームが NTFS ボリュームである必要があります。

### <a name="whats-the-maximum-number-of-shadow-copies-i-can-create-at-one-time"></a>一度に作成できるシャドウ コピーの最大数はいくつですか?

1 つのシャドウ コピー セットでシャドウ コピーされるボリュームの最大数は 64 です。 これはシャドウ コピーの数と同じではないことに注意してください。

### <a name="whats-the-maximum-number-of-software-shadow-copies-created-by-the-system-provider-that-i-can-maintain-for-a-volume"></a>ボリュームに対して保持できる、システム プロバイダーによって作成されるソフトウェア シャドウ コピーの最大数はいくつかですか?

各ボリュームのソフトウェア シャドウ コピーの最大数は 512 です。 ただし、既定では、共有フォルダーのシャドウ コピー機能によって使用される 64 個のシャドウ コピーのみを保持できます。 共有フォルダーのシャドウ コピー機能の制限を変更するには、次のレジストリ キーを使用します。**MaxShadowCopies**。

### <a name="how-can-i-control-the-space-that-is-used-for-shadow-copy-storage-space"></a>シャドウ コピーの記憶領域に使用する領域は、どのようにして制御できますか?

**vssadmin resize shadowstorage** コマンドを入力します。

詳細については、TechNet の「[Vssadmin resize shadowstorage](https://go.microsoft.com/fwlink/?linkid=180906)」 (https://go.microsoft.com/fwlink/?LinkId=180906) を参照してください。

### <a name="what-happens-when-i-run-out-of-space"></a>領域が不足した場合はどうなりますか?

ボリュームのシャドウ コピーが、最も古いシャドウ コピーから削除されます。

## <a name="volume-shadow-copy-service-tools"></a>ボリューム シャドウ コピー サービスのツール

Windows オペレーティング システムには、VSS を操作するための次のツールが用意されています。

  - [DiskShadow](https://go.microsoft.com/fwlink/?linkid=180907) (https://go.microsoft.com/fwlink/?LinkId=180907)

  - [VssAdmin](https://go.microsoft.com/fwlink/?linkid=84008) (https://go.microsoft.com/fwlink/?LinkId=84008)


### <a name="diskshadow"></a>DiskShadow

DiskShadow は、システム上で使用できるすべてのハードウェアおよびソフトウェアのスナップショットを管理するために使用できる VSS リクエスターです。 DiskShadow には、次のようなコマンドが含まれています。

  - **list**:VSS ライター、VSS プロバイダー、およびシャドウ コピーの一覧を表示します

  - **create**:新しいシャドウ コピーを作成します

  - **import**:転送可能なシャドウ コピーをインポートします

  - **expose**:永続シャドウ コピーを公開します (たとえば、ドライブ文字として)

  - **revert**:指定したシャドウ コピーにボリュームを元に戻します


このツールは IT プロフェッショナルによる使用が意図されていますが、開発者にとっても VSS ライターまたは VSS プロバイダーをテストする際に役立つことがあります。

DiskShadow は、Windows Server オペレーティング システムでのみ使用できます。 Windows クライアント オペレーティング システムでは使用できません。

### <a name="vssadmin"></a>VssAdmin

VssAdmin は、シャドウコピーに関する情報を作成、削除、および一覧表示するために使用されます。 また、シャドウ コピーの記憶域 ("差分領域") のサイズを変更するためにも使用できます。

VssAdmin には、次のようなコマンドが含まれています。

  - **create shadow**:新しいシャドウ コピーを作成します

  - **delete shadows**:シャドウ コピーを削除します

  - **list providers**:登録されているすべての VSS プロバイダーを一覧表示します

  - **list writers**:サブスクライブされているすべての VSS ライターを一覧表示します

  - **resize shadowstorage**:シャドウ コピーの記憶域の最大サイズを変更します


VssAdmin は、システム ソフトウェア プロバイダーによって作成されたシャドウ コピーの管理にのみ使用できます。

VssAdmin は、Windows クライアントおよび Windows Server オペレーティング システムのバージョンで使用できます。

## <a name="volume-shadow-copy-service-registry-keys"></a>ボリューム シャドウ コピー サービスのレジストリ キー

VSS では、次のレジストリ キーを使用できます。

  - **VssAccessControl**

  - **MaxShadowCopies**

  - **MinDiffAreaFileSize**


### <a name="vssaccesscontrol"></a>VssAccessControl

このキーは、シャドウ コピーにアクセスできるユーザーを指定するために使用されます。

詳細については、MSDN Web サイトで次のエントリを参照してください。

  - [ライターのセキュリティに関する考慮事項](https://go.microsoft.com/fwlink/?linkid=157739) (https://go.microsoft.com/fwlink/?LinkId=157739)

  - [リクエスターのセキュリティに関する考慮事項](https://go.microsoft.com/fwlink/?linkid=180908) (https://go.microsoft.com/fwlink/?LinkId=180908)


### <a name="maxshadowcopies"></a>MaxShadowCopies

このキーは、コンピューターの各ボリュームに保存できる、クライアントがアクセスできるシャドウ コピーの最大数を指定します。 クライアントがアクセスできるシャドウ コピーは、共有フォルダーのシャドウ コピーによって使用されます。

詳細については、MSDN Web サイトで次のエントリを参照してください。

[バックアップと復元のレジストリ キー](https://go.microsoft.com/fwlink/?linkid=180909) (https://go.microsoft.com/fwlink/?LinkId=180909) に関する記事の **MaxShadowCopies**

### <a name="mindiffareafilesize"></a>MinDiffAreaFileSize

このキーは、シャドウ コピーの記憶域の最小初期サイズを MB 単位で指定します。

詳細については、MSDN Web サイトで次のエントリを参照してください。

[バックアップと復元のレジストリ キー](https://go.microsoft.com/fwlink/?linkid=180910) (https://go.microsoft.com/fwlink/?LinkId=180910) に関する記事の **MinDiffAreaFileSize**

### <a name="supported-operating-system-versions"></a>サポートされるオペレーティング システムのバージョン

次の表は、VSS 機能でサポートされるオペレーティング システムの最小バージョンを示しています。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>VSS 機能</th>
<th>サポートされている最小のクライアント</th>
<th>サポートされている最小のサーバー</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>LUN の再同期</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2008 R2</p></td>
</tr>
<tr class="even">
<td><p><strong>FilesNotToSnapshot</strong> レジストリキー</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="odd">
<td><p>転送可能なシャドウ コピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003 SP1</p></td>
</tr>
<tr class="even">
<td><p>ハードウェア シャドウ コピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="odd">
<td><p>以前のバージョンの Windows Server</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="even">
<td><p>LUN スワップを使用した高速回復</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003 SP1</p></td>
</tr>
<tr class="odd">
<td><p>ハードウェア シャドウ コピーの複数のインポート</p>
<div class="alert">
<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><img src="media/volume-shadow-copy-service/Dd560667.note(WS.10).gif" />注意</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>これは、シャドウ コピーを複数回インポートする機能です。 一度に実行できるインポート操作は 1 つだけです。
<p></p></td>
</tr>
</tbody>
</table>
<p></p>
</div></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>共有フォルダーのシャドウ コピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="odd">
<td><p>転送可能な自動回復シャドウ コピー</p></td>
<td><p>サポートなし</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>同時バックアップ セッション (最大 64)</p></td>
<td><p>Windows XP</p></td>
<td><p>Windows Server 2003</p></td>
</tr>
<tr class="odd">
<td><p>バックアップと同時に実行される単一の復元セッション</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003 SP2</p></td>
</tr>
<tr class="even">
<td><p>バックアップと同時に実行される最大 8 個の復元セッション</p></td>
<td><p>Windows 7</p></td>
<td><p>Windows Server 2003 R2</p></td>
</tr>
</tbody>
</table>

## <a name="additional-references"></a>その他の参照情報

[Windows デベロッパー センターのボリューム シャドウ コピー サービス](https://docs.microsoft.com/windows/desktop/vss/volume-shadow-copy-service-overview)
