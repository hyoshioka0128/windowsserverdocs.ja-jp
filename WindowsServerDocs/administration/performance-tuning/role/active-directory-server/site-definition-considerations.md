---
title: のサイト定義とドメインコントローラーの配置によってパフォーマンスチューニングが追加される
description: Active Directory パフォーマンスチューニングにおけるサイト定義とドメインコントローラーの配置に関する考慮事項。
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: TimWi; ChrisRob; HerbertM; KenBrumf;  MLeary; ShawnRab
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 66c6f94f1f3fee924ba0d9a3bfa0c712d62bb095
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/14/2020
ms.locfileid: "75947101"
---
# <a name="proper-placement-of-domain-controllers-and-site-considerations"></a>ドメインコントローラーとサイトの適切な配置に関する考慮事項

適切なサイト定義は、パフォーマンスにとって重要です。 クライアントのサイトが不足すると、認証とクエリのパフォーマンスが低下する可能性があります。 さらに、クライアントでの IPv6 の導入により、要求は IPv4 または IPv6 アドレスから取得され、Active Directory は IPv6 用に適切に定義されたサイトを持つ必要があります。 両方が構成されている場合、オペレーティングシステムは IPv6 を優先します。

Windows Server 2008 以降では、ドメインコントローラーは、クライアントが存在するサイトを決定するために、名前解決を使用して逆引き参照を実行しようとします。 これにより、ATQ スレッドプールが枯渇し、ドメインコントローラーが応答しなくなる可能性があります。 これに対する適切な解決策は、IPv6 のサイトトポロジを適切に定義することです。 回避策として、ドメインコントローラーの要求にすばやく応答するように名前解決インフラストラクチャを最適化できます。 詳細については、「 [Windows server 2008 または Windows server 2008 R2 のドメインコントローラーが LDAP または Kerberos 要求に対して遅延応答を送信する](https://support.microsoft.com/kb/2668820)」を参照してください。

Rodc が使用されているシナリオでは、読み取り/書き込み Dc を検索することを考慮する必要があります。  一部の操作では、読み取り専用ドメインコントローラーで十分であれば、書き込み可能なドメインコントローラーへのアクセス、または書き込み可能なドメインコントローラーへのアクセスが必要になります。  これらのシナリオを最適化するには、次の2つのパスを使用します。
-   読み取り専用ドメインコントローラーで十分な場合は、書き込み可能なドメインコントローラーに接続します。  このためには、アプリケーションコードを変更する必要があります。
-   書き込み可能なドメインコントローラーが必要になる場合があります。  読み書き可能なドメインコントローラーを中央の場所に配置して、待機時間を最小限に抑えます。

詳細については、次を参照してください。
-   [Rodc とのアプリケーションの互換性](https://technet.microsoft.com/library/cc772597.aspx)
-   [Active Directory サービスインターフェイス (ADSI) と読み取り専用ドメインコントローラー (RODC) –パフォーマンスの問題の回避](https://blogs.technet.microsoft.com/fieldcoding/2012/06/24/active-directory-service-interface-adsi-and-the-read-only-domain-controller-rodc-avoiding-performance-issues/)

## <a name="optimize-for-referrals"></a>参照用に最適化

参照とは、照会されたパーティションのコピーをドメインコントローラーがホストしていない場合に、LDAP クエリがどのようにリダイレクトされるかを示します。 参照が返されると、パーティションの識別名、DNS 名、ポート番号が含まれます。 クライアントはこの情報を使用して、パーティションをホストするサーバーでクエリを続行します。 これは DCLocator シナリオであり、すべての推奨事項サイト定義とドメインコントローラーの配置は維持されますが、参照に依存するアプリケーションは見落とされることがよくあります。 サイト定義やドメインコントローラーの配置などの AD トポロジがクライアントのニーズを正しく反映するようにすることをお勧めします。 また、1つのサイトに複数のドメインのドメインコントローラーを配置したり、DNS 設定を調整したり、アプリケーションのサイトを再配置したりすることができます。

## <a name="optimization-considerations-for-trusts"></a>信頼の最適化に関する考慮事項

フォレスト内のシナリオの場合、信頼は、次のドメイン階層に従って処理されます:&gt; 子ドメイン-&gt; フォレストルートドメイン-&gt; 子ドメイン&gt; の親子ドメイン。 これは、信頼階層内の Dc に通過認証要求の集約によって、フォレストルートのセキュリティで保護されたチャネルと各親が過負荷になる可能性があることを意味します。 これにより、認証によって、上のフローに影響を与える高可用性リンクを転送する必要がある場合に、地理的に大きい分散の Active Directory で遅延が発生することもあります。 オーバーロードは、フォレスト間および下位レベルの信頼のシナリオで発生する可能性があります。 次の推奨事項は、すべてのシナリオに適用されます。

-   セキュリティで保護されたチャネル全体の負荷をサポートするように MaxConcurrentAPI を適切に調整します。 詳細については、「 [MaxConcurrentApi 設定を使用して NTLM 認証のパフォーマンスチューニングを行う方法](https://support.microsoft.com/kb/2688798/EN-US)」を参照してください。

-   必要に応じて、負荷に基づいてショートカットの信頼を作成します。

-   ドメイン内のすべてのドメインコントローラーが名前解決を実行し、信頼されたドメイン内のドメインコントローラーと通信できることを確認します。

-   信頼に関して、局所性に関する考慮事項を考慮してください。

-   可能な場合は Kerberos を有効にし、セキュリティで保護されたチャネルの使用を最小限に抑えて、MaxConcurrentAPI のボトルネックが発生するリスクを軽減します。

ドメイン間の信頼シナリオは、多くのお客様にとって常に問題点となっている分野です。 ファイアウォールが原因で、名前解決と接続の問題が発生した場合、信頼する側のドメインコントローラーでリソースが枯渇し、すべてのクライアントに影響が及びます。 さらに、見落とされがちなシナリオは、信頼されたドメインコントローラーへのアクセスを最適化することです。 これが正常に機能することを確認するための主な領域は次のとおりです。

-   信頼する側のドメインコントローラーが使用している DNS および WINS の名前解決が、信頼される側のドメインのドメインコントローラーの正確な一覧を解決できることを確認します。

    -   静的に追加されたレコードは、長期間にわたって古くなって、接続の問題を再び導入する傾向があります。 WINS/DNS インフラストラクチャの DNS 転送、動的 DNS、およびマージは、長時間実行されます。

    -   クライアントがアクセスする必要がある環境内のすべてのリソースについて、前方参照ゾーンと逆引き参照ゾーンの両方について、フォワーダー、条件付き転送、およびセカンダリコピーを適切に構成します。 この場合も、手動でのメンテナンスが必要になり、古くなる傾向があります。 インフラストラクチャの統合は理想的です。

-   信頼する側のドメインのドメインコントローラーは、最初に同じサイトにある信頼される側のドメインのドメインコントローラーを検索し、次に汎用ロケーターにフェールバックします。

    -   DCLocator のしくみの詳細については、[最も近いサイトでのドメインコントローラーの検索](https://technet.microsoft.com/library/cc978016.aspx)に関するページを参照してください。

    -   信頼される側のドメインと信頼する側のドメインの間でサイト名が収束し、同じ場所にドメインコントローラーが反映されます。 サブネットと IP アドレスのマッピングが両方のフォレストのサイトに正しくリンクされていることを確認します。 詳細については、「[フォレストの信頼を越えたドメインロケーター](https://blogs.technet.com/b/askds/archive/2008/09/24/domain-locator-across-a-forest-trust.aspx)」を参照してください。

    -   ドメインコントローラの場所について、DCLocator のニーズに従ってポートが開いていることを確認します。 ドメイン間にファイアウォールが存在する場合は、すべての信頼に対してファイアウォールが正しく構成されていることを確認します。 ファイアウォールが開いていない場合でも、信頼する側のドメインコントローラーは信頼される側のドメインにアクセスしようとします。 何らかの理由で通信が失敗した場合、信頼する側のドメインコントローラーは、最終的に信頼される側のドメインコントローラーに要求をタイムアウトさせます。 ただし、このタイムアウトには、要求ごとに数秒かかることがあります。また、受信要求の量が多い場合は、信頼する側のドメインコントローラーのネットワークポートを使用できません。 クライアントは、ハングしたスレッドとしてドメインコントローラーのタイムアウトを待機することがあります。これは、アプリケーションがフォアグラウンドスレッドで要求を実行する場合に、ハングしたスレッドとして変換される可能性があります。 詳細については、「[ドメインと信頼関係のためにファイアウォールを構成する方法](https://support.microsoft.com/kb/179442)」を参照してください。

    -   DnsAvoidRegisterRecords を使用して、サテライトサイトにあるものなど、パフォーマンスの低い、または待機時間の長いドメインコントローラを、広告から汎用ロケーターにまで除去します。 詳細については、「[クライアントのサイトの外部に存在するドメインコントローラーまたはグローバルカタログの場所を最適化する方法](https://support.microsoft.com/kb/306602)」を参照してください。

        > [!NOTE]
        > クライアントが使用できるドメインコントローラーの数について、約50の実質的な制限があります。 これらのドメインコントローラーは、サイトに最適で最高容量のドメインコントローラーである必要があります。

    
    -  信頼されたドメインと信頼する側のドメインのドメインコントローラーを同じ物理的な場所に配置することを検討してください。

すべての信頼のシナリオで、資格情報は、認証要求で指定されたドメインに従ってルーティングされます。 これは、LookupAccountName や LsaLookupNames (およびその他のもの) に対するクエリにも当てはまります。これらは、最も一般的に使用される Api にすぎません。 これらの Api のドメインパラメーターに NULL 値が渡されると、ドメインコントローラーは、使用可能なすべての信頼されるドメインに指定されているアカウント名の検索を試みます。

-   NULL ドメインが指定されている場合は、使用可能なすべての信頼の確認を無効にします。 [LsaLookupRestrictIsolatedNameLevel レジストリエントリを使用して、外部の信頼される側のドメインでの分離名の参照を制限する方法](https://support.microsoft.com/kb/818024)

-   使用可能なすべての信頼に対して NULL ドメインが指定された認証要求を渡すことを無効にします。 [Active Directory ドメインコントローラーに多数の外部の信頼がある場合、Lsass.exe プロセスが応答を停止することがある](https://support.microsoft.com/kb/923241/EN-US)

## <a name="see-also"></a>「
- [パフォーマンスチューニング Active Directory サーバー](index.md)
- [ハードウェアに関する考慮事項](hardware-considerations.md)
- [LDAP に関する考慮事項](ldap-considerations.md)
- [ADDS パフォーマンスのトラブルシューティング](troubleshoot.md) 
- [Active Directory Domain Services のキャパシティ プランニング](https://go.microsoft.com/fwlink/?LinkId=324566)