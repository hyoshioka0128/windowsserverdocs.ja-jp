---
title: AD DS パフォーマンスチューニングにおけるメモリ使用量に関する考慮事項
description: Windows Server 2012 R2、2016、および2019を実行しているドメインコントローラー上の Lsass.exe プロセスによるメモリ使用量。
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: v-tea; lindakup
author: Teresa-Motiv
ms.date: 7/3/2019
ms.openlocfilehash: 55ac47d835874ddb8e160603f08cbafa985aad2a
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71370289"
---
# <a name="memory-usage-considerations-for-ad-ds-performance-tuning"></a>AD DS パフォーマンスチューニングに関するメモリ使用量に関する考慮事項

この記事では、ローカルセキュリティ機関サブシステムサービス (lsass、Lsass.exe プロセスとも呼ばれます) の基本、LSASS の構成に関するベストプラクティス、およびメモリ使用量について説明します。 この記事は、ドメインコントローラー (Dc) での LSASS パフォーマンスおよびメモリ使用の分析に関するガイドとして使用する必要があります。 この記事の情報は、このエンジンを最適化するためにサーバーと Dc を調整して構成する方法について不明な点がある場合に役立ちます。  

LSASS は、ローカルセキュリティ機関 (LSA) のドメイン認証と Active Directory 管理の管理を担当します。 LSASS は、クライアントとサーバーの両方の認証を処理し、Active Directory エンジンも制御します。 LSASS は、次のコンポーネントを担当します。  

- ローカル セキュリティ機関
- NetLogon サービス
- セキュリティアカウントマネージャー (SAM) サービス
- LSA サーバーサービス
- Secure Sockets Layer (SSL)
- Kerberos v5 認証プロトコル
- NTLM 認証プロトコル
- LSA に読み込まれるその他の認証パッケージ

Active Directory データベースサービス (NTDSAI) は、拡張可能なストレージエンジン (ESE、ESENT) で動作します。

DC の LSASS メモリ使用量の図を次に示します。

![LSASS メモリを使用するコンポーネントの図](media/domain-controller-lsass-memory-usage.png)  

DC 上で LSASS が使用するメモリの量は、Active Directory の使用状況に応じて増加します。 データが照会されると、メモリにキャッシュされます。 その結果、通常は、Active Directory データベースファイル (ntds.dit) のサイズより大きいメモリ量を使用して LSASS が表示されます。

図に示すように、LSASS メモリ使用量は、ESE データベースバッファーキャッシュ、ESE バージョンストアなど、いくつかの部分に分けることができます。 この記事の残りの部分では、これらの各部分について説明します。

## <a name="ese-database-buffer-cache"></a>ESE データベースバッファーキャッシュ  
LSASS 内の最大可変メモリ使用量は、ESE データベースバッファーキャッシュです。 キャッシュのサイズは、1 MB 未満からデータベース全体のサイズまでの範囲で指定できます。 キャッシュのサイズが大きいとパフォーマンスが向上するため、Active Directory (ESENT) のデータベースエンジンはキャッシュを可能な限り保持しようとします。 キャッシュのサイズはコンピューターのメモリ不足によって異なりますが、ESE データベースバッファーキャッシュの最大サイズは、コンピューターにインストールされている物理 RAM によって*のみ*制限されます。 他にメモリ不足が発生しない限り、Active Directory ntds.dit データベースファイルのサイズにキャッシュが拡張される可能性があります。 キャッシュ可能なデータベースの数が多いほど、DC のパフォーマンスが向上します。  
  
> [!NOTE]
> データベースキャッシュアルゴリズムの動作は、データベースのサイズが使用可能な RAM よりも小さい64ビットシステムでは、データベースのキャッシュが、データベースのサイズよりも 30 ~ 40% 大きくなる可能性があるためです。

## <a name="ese-version-store"></a>ESE バージョンストア

ESE バージョンストア (上の図の赤い部分) によるメモリ使用量が変動しています。 使用されるメモリの量は、Windows Server 2019 以前のバージョンの Windows があるかどうかによって異なります。

- Windows server 2019 の Windows server バージョンでは、既定で LSASS は、ESE バージョンストアの64ビットコンピューター上のメモリの最大 400 MB (Cpu 数によって異なります) を使用する場合があります。 バージョンストアの使用方法の詳細については、ライアン Ries による次の ASKDS ブログ投稿を参照してください。[バージョンストアはを呼び出しましたが、これらはすべてバケット外](https://techcommunity.microsoft.com/t5/Ask-the-Directory-Services-Team/The-Version-Store-Called-and-They-8217-re-All-Out-of-Buckets/ba-p/400415)です。

- Windows Server 2019 では、これは簡略化され、NTDS サービスが最初に開始されたときに、ESE バージョンストアのサイズが物理 RAM の 10% として計算されるようになりました。最小値は 400 MB、最大値は 4 GB です。 このバージョンおよびバージョンストアのトラブルシューティングの詳細については、「ライアン Ries」にあるもう1つの優れたブログを参照してください。[Deep:Active Directory、サーバー 2019 @ no__t で ESE バージョンストアの変更が変更されています。

## <a name="other-memory-use"></a>その他のメモリ使用量

最後に、コード、スタック、ヒープ、およびさまざまな固定サイズのデータ構造 (スキーマキャッシュなど) があります。 LSASS が使用するメモリの量は、コンピューターの負荷によって異なる場合があります。 実行中のスレッドの数が増えると、によってメモリスタックの数が増加します。 平均して、LSASS はこれらの固定コンポーネントに対して 100 MB ~ 300 MB のメモリを使用します。 RAM が大量にインストールされている場合、LSASS は RAM の使用量を増やし、仮想メモリを減らすことができます。

**ドメインコントローラー上のプログラム数を制限または最小化するか、必要に応じて RAM を追加します**

最適なパフォーマンスを得るために、LSASS は特定の DC で可能な限り多くの RAM を使用します。 LSASS は、他のプロセスとしてその RAM を解放します。 この考え方は、コンピューター上で実行される可能性のある他のプロセスを考慮しながら、LSASS のパフォーマンスを最適化することです。 監視対象のプログラムの一覧には、監視エージェントが含まれています。 一部のお客様は、大容量の RAM リソースを消費する可能性があるさまざまなサーバー機能に対して個別のエージェントを使用します。 いくつかの WMI クエリが発行される場合がありますが、その詳細については以下を参照してください。

このため、およびパフォーマンスを向上させるには、DC 上のプログラムの数を制限または最小限にすることをお勧めします。 メモリ要求がない場合、LSASS はこのメモリを使用して Active Directory データベースをキャッシュするため、最適なパフォーマンスが得られます。

DC にパフォーマンス上の問題があることがわかった場合は、メモリ使用率が非常に高いプロセスも監視してください。 トラブルシューティングに必要な問題が発生している可能性があります。 Microsoft コンポーネントが含まれている場合があります。 最新のサービス更新プログラムを継続的にご利用ください。 @ no__t-0Microsoft は品質更新プログラムの一部としてメモリ使用量が過剰になっているソリューションを含み、DC のパフォーマンスにも役立ちます。

使用プロファイルに応じて、大量の RAM を消費する OS 機能が組み込まれています。

- **ファイルサーバー**。 Dc は SYSVOL 共有と Netlogon 共有用のファイルサーバーでもあり、ポリシーおよびスタートアップ/ログオンスクリプト用のグループポリシーおよびスクリプトを提供します。
  ただし、お客様が Dc を使用して他のファイルコンテンツにサービスを提供していることがわかります。 SMB ファイルサーバーは、RAM を使用してアクティブなクライアントを追跡しますが、最も重要なのは、ファイルの内容によって OS ファイルキャッシュが拡張され、RAM の ESE データベースキャッシュと競合する場合です。  

- **WMI クエリ**。 多くの場合、監視ソリューションは多くの WMI クエリを行います。 個々のクエリの実行にはコストがかかる場合があります。 多くの場合、特に、監視ソリューションでは、Windows が管理するさまざまなイベントログから新しいイベントを抽出するので、オーバーヘッドが発生する呼び出しの量が発生します。  

  ほとんどのボリュームを生成するイベントログは、通常、セキュリティイベントログです。 また、これは、セキュリティ管理者が (特に Dc から) 収集するイベントログでもあります。  

  WMI サービスは、クエリを最適化する動的メモリ割り当てスキームを使用します。 そのため、WMI サービスは、ESE データベースキャッシュとの競合を再処理するために、大量のメモリを割り当てることがあります。  
