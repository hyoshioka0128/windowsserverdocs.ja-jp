---
title: ノードの削除に関する問題
description: この記事では、アクティブなフェールオーバークラスターメンバーシップからノードを削除するときに発生する問題について説明します。
ms.prod: windows-server
ms.technology: server-general
ms.date: 05/28/2020
author: Deland-Han
ms.author: delhan
ms.openlocfilehash: 30714e8a9c5ca4ad13ed6757c6ce1da211b279ac
ms.sourcegitcommit: ef089864980a1d4793a35cbf4cbdd02ce1962054
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/28/2020
ms.locfileid: "84150230"
---
# <a name="having-a-problem-with-nodes-being-removed-from-active-failover-cluster-membership"></a>アクティブなフェールオーバークラスターのメンバーシップからノードが削除されるという問題が発生する

この記事では、ノードがアクティブフェールオーバークラスターメンバーシップからランダムに削除される問題を解決する方法を紹介します。

## <a name="symptoms"></a>現象

この問題が発生すると、次のようなイベントがシステムイベントログに記録されます。

![イベント1135](media/problem-nodes-failover-cluster/1135-1.png)

このイベントは、削除されたノードを除く、クラスター内のすべてのノードに記録されます。 このイベントが発生する理由は、クラスター内のいずれかのノードがノードをダウン状態としてマークしたためです。 その後、イベントの他のすべてのノードに通知します。 ノードに通知されると、ダウンしたノードへのハートビート接続が停止され、破棄されます。

## <a name="what-caused-the-node-to-be-marked-down"></a>ノードが下に表示される原因

Windows 2008 または 2008 R2 フェールオーバークラスター内のすべてのノードは、このネットワーク上のクラスターネットワーク通信を許可するように設定されているネットワーク上で相互に通信します。 ノードは、これらのネットワーク経由でハートビートパケットを他のすべてのノードに送信します。 これらのパケットは他のノードによって受信され、応答が返されます。 クラスター内の各ノードには、ネットワークが稼働しており、他のノードが稼働していることを確認するために監視する独自のハートビートがあります。 次の例では、これを明確にすることができます。

![Nodes](media/problem-nodes-failover-cluster/Node2.png)

これらのパケットのいずれかが返されなかった場合は、特定のハートビートが失敗したと見なされます。 たとえば、W2K8-NODE2 は要求を送信し、W2K8 からハートビートパケットへの応答を受信します。これにより、ネットワークとノードが稼働していることが確認されます。  W2K8-NODE1 が W2K8 に要求を送信し、W2K8 が応答を取得しなかった場合は、ハートビートが失われたと見なされ、W2K8 はそれを追跡します。  この失敗した応答には、別のハートビート要求が受信されるまで、W2K8 を使用してネットワークをダウンさせることができます。

既定では、クラスターノードは5秒以内に5秒間に制限され、接続が停止します。 そのため、W2K8-NODE1 が時間内に応答を5回受信しなかった場合、W2K8 への特定のルートがダウンしていると見なされます。 他のルートがまだ稼働していると見なされた場合、W2K8 はアクティブなメンバーとして残ります。

すべてのルートが W2K8---NODE2 用にマークされている場合は、アクティブなフェールオーバークラスターのメンバーシップから削除され、最初のセクションに表示されているイベント1135がログに記録されます。 W2K8-NODE2 で、クラスターサービスを終了して再起動すると、クラスターに再度参加させることができます。

3つ以上のノードを含む特定のルートを処理する方法の詳細については、Jeff Hughes によって作成された、 [「パーティション分割](/archive/blogs/askcore/partitioned-cluster-networks)されたクラスターネットワークのブログ」を参照してください。

## <a name="now-that-we-know-how-the-heartbeat-process-works-what-are-some-of-the-known-causes-for-the-process-to-fail"></a>これで、ハートビートプロセスがどのように動作するかがわかったので、プロセスが失敗する原因となっていることがいくつかあります。

1. 実際のネットワークハードウェアの障害。 パケットがノード間のネットワーク上で失われると、ハートビートは失敗します。 両方のノードからのネットワークトレースによって、このことが明らかになります。

2. ネットワーク接続用のプロファイルは、ドメインからパブリックに、ドメインに再び戻る可能性があります。 これらの変更の移行中に、ネットワーク i/o がブロックされる可能性があります。 ネットワークプロファイルの操作ログを確認することで、この問題が発生していないかどうかを確認できます。 このログを確認するには、イベントビューアーを開き、[アプリケーションとサービス] Logs\Microsoft\Windows\NetworkProfile\Operational. に移動します。 イベント ID: 1135 に示されているノードでこのログのイベントを確認し、この時点でプロファイルが変更されたかどうかを確認します。 その場合は、 [windows 7 または Windows Server 2008 R2 で、ネットワークの場所のプロファイルが "ドメイン" から "パブリック" に変更](https://support.microsoft.com/help/2524478/the-network-location-profile-changes-from-domain-to-public-in-windows)されていることを確認してください。

3. サーバーで IPv6 が有効になっているが、Windows ファイアウォールで受信と送信に対して次の2つの規則が無効になっている。

    - コアネットワーク-近隣探索の提供情報
    - コアネットワーク-近隣探索要請

4. ウイルス対策ソフトウェアも、このプロセスに干渉する可能性があります。 問題があると思われる場合は、ソフトウェアを無効化またはアンインストールしてテストします。 この操作は、この時点ではウイルスから保護されないため、お客様自身の責任で行ってください。

5. ネットワークの待機時間によっても発生する可能性があります。 ノード間でパケットが失われることはありませんが、タイムアウト期間が経過する前にノードに到達できない可能性があります。

6. IPv6 は、フェールオーバークラスタリングがハートビートに使用する既定のプロトコルです。 ハートビート自体は、ポート3343を介して通信する UDP ユニキャストネットワークパケットです。 このトラフィックを通過できるように、スイッチ、ファイアウォール、またはルーターが正しく構成されていない場合は、次のような問題が発生する可能性があります。

7. IPsec セキュリティポリシーの更新により、この問題が発生することもあります。 具体的な問題は、IPSec グループポリシーの更新中に、すべての IPsec セキュリティアソシエーション (SAs) がセキュリティが強化された Windows ファイアウォール (WFAS) によって破棄されることです。 この問題が発生している間、すべてのネットワーク接続がブロックされます。 Active Directory による認証の実行に遅延がある場合、セキュリティアソシエーションを renegotiating すると、(すべてのネットワーク通信がブロックされている) 遅延が発生し、クラスターのハートビートが開始されなくなり、5秒のしきい値内に応答しない場合、クラスターの正常性の監視によってノードがダウンします。

8. 古いまたは古いネットワークカードドライバーやファームウェア。  場合によっては、ネットワークカードやスイッチの構成の誤りが原因でハートビートが失われることもあります。

9. 最新のネットワークカードと仮想ネットワークカードでパケット損失が発生している可能性があります。  これは、パフォーマンスモニターを開き、"Network Interface\Packets Received 破棄済み" というカウンターを追加することによって追跡できます。  このカウンターは累積され、サーバーが再起動されるまで増加します。  ここで破棄された多数のパケットが表示される場合は、ネットワークカードの受信バッファーが低すぎるか、サーバーのパフォーマンスが低下し、受信トラフィックを処理できないことを示す符号です。  各ネットワークカードの製造元は、これらの設定をネットワークカードのプロパティで公開するかどうかを選択します。そのため、製造元の web サイトを参照してこれらの値を増やす方法を確認し、推奨値を使用する必要があります。  VMware で実行している場合、次のブログではこれについてもう少し詳しく説明しています。これについては、これが問題であるかどうかを確認する方法や、変更する設定について VMWare の記事を参照する方法などがあります。

    [VMWare ESX のフェールオーバークラスターメンバーシップから削除されているノード](/archive/blogs/askcore/nodes-being-removed-from-failover-cluster-membership-on-vmware-esx)

これらのイベントがログに記録される最も一般的な理由を次に示しますが、その他の理由も考えられます。 このブログでは、プロセスについていくつかの洞察を得て、何を探しているかについてのアイデアを提供することにしました。 この問題を回避するために、次の値が最大値になる場合があります。

|パラメーター|Default|範囲|
|---|---|---|
|**SameSubnetDelay**|1000ミリ秒|250-2000 ミリ秒|
|**CrossSubnetDelay**|1000ミリ秒|250-4000 ミリ秒|
|**SameSubnetThreshold**|5|3-10|
|**CrossSubnetThreshold**|5|3-10|
||||

これらの値を最大値に増やすと、イベントとノードの削除が解消されるため、問題が解消されます。 何も修正されません。 最適な方法は、ハートビートエラーの根本原因を見つけて、それを修正することです。 これらの値を大きくすることが本当に必要なのは、ノードが異なる場所に存在し、ネットワーク待機時間を克服できないマルチサイトのシナリオです。
